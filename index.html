<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quality Analyzer</title>

<style>
:root{
  --bg0:#070b14;
  --bg1:#0b1220;
  --card:#0f1a2e;
  --line:rgba(148,163,184,.18);

  --text:#e5e7eb;
  --muted:#94a3b8;

  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --shadow2: 0 10px 30px rgba(0,0,0,.35);

  --focus: rgba(99,102,241,.22);

  --c1:#6366f1;
  --c2:#22d3ee;

  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --r:18px;
  --r2:14px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(900px 520px at 10% 0%, rgba(99,102,241,.35), transparent 60%),
    radial-gradient(650px 420px at 92% 8%, rgba(34,211,238,.22), transparent 60%),
    radial-gradient(800px 520px at 45% 100%, rgba(34,197,94,.10), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

/* Layout */
.container{max-width: 1480px; margin: 26px auto; padding: 0 18px 34px;}
.shell{
  border:1px solid var(--line);
  border-radius: var(--r);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow: var(--shadow);
  padding: 16px;
}

.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  margin-bottom:14px;
}
.brand{display:flex; align-items:center; gap:12px;}
.logo{
  width:36px; height:36px; border-radius:12px;
  background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70));
  box-shadow: 0 10px 22px rgba(0,0,0,.25);
}
.brand h1{margin:0; font-size:20px; letter-spacing:.2px}
.brand p{margin:3px 0 0; color:var(--muted); font-weight:800; font-size:12px}

.pills{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
.pill{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  box-shadow: var(--shadow2);
  color: var(--muted);
  font-weight: 900;
  font-size: 12px;
}
.dot{width:8px; height:8px; border-radius:99px; background:rgba(148,163,184,.55); box-shadow:0 0 0 3px rgba(148,163,184,.12)}
.dot.ok{background: var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.14)}
.dot.bad{background: var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.14)}
.dot.warn{background: var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.14)}

.tabs{
  display:flex; gap:10px; flex-wrap:wrap;
  margin-bottom:14px;
}
.tab{
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color: var(--text);
  padding: 10px 14px;
  border-radius: 14px;
  cursor:pointer;
  font-weight: 900;
  transition: all .12s ease;
}
.tab.active{
  border-color: rgba(99,102,241,.65);
  box-shadow: 0 0 0 4px rgba(99,102,241,.14);
  background: rgba(99,102,241,.10);
}

.section{display:none}
.section.active{display:block}

.grid{
  display:grid;
  grid-template-columns: 1.25fr .75fr;
  gap: 16px;
}
@media (max-width: 1100px){
  .grid{grid-template-columns:1fr}
}

.panel{
  border:1px solid var(--line);
  background: rgba(2,6,23,.82);
  border-radius: var(--r);
  padding: 14px;
}
.panelTitle{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.panelTitle b{font-size: 13px}
.panelTitle span{color:var(--muted);font-weight:900;font-size:12px}

textarea{
  width:100%;
  min-height: 310px;
  border-radius: var(--r);
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  color: var(--text);
  padding: 14px 14px;
  outline:none;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12.7px;
  line-height: 1.42;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
textarea:focus{border-color: rgba(99,102,241,.85); box-shadow: 0 0 0 4px var(--focus);}

input, select{
  width:100%;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  color:var(--text);
  padding: 11px 12px;
  outline:none;
  font-weight: 900;
}
input:focus,select:focus{border-color: rgba(99,102,241,.85); box-shadow: 0 0 0 4px var(--focus);}

.kpis{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
@media (max-width:600px){.kpis{grid-template-columns:1fr}}

.kpi{
  padding: 12px 12px;
  border-radius: var(--r2);
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  display:flex;
  flex-direction:column;
  gap:4px;
}
.kpi span{color:var(--muted); font-size: 12px; font-weight: 900;}
.kpi b{font-size: 18px; letter-spacing: .2px;}

hr.sep{border:none;height:1px;background:var(--line); margin: 12px 0;}

.controls{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}
@media (max-width:1000px){.controls{grid-template-columns:1fr}}

.btn{
  width:100%;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  padding: 11px 12px;
  cursor:pointer;
  color:white;
  font-weight: 950;
  letter-spacing:.2px;
  transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease;
  background: linear-gradient(135deg, rgba(99,102,241,.85), rgba(34,211,238,.55));
  box-shadow: 0 10px 22px rgba(0,0,0,.28);
}
.btn:hover{filter:brightness(1.05); box-shadow: 0 0 0 3px rgba(99,102,241,.16), 0 14px 28px rgba(0,0,0,.38);}
.btn:active{transform:scale(.985)}
.btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.2); box-shadow:none;}

.btn.primary{background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70)); border-color: rgba(99,102,241,.25);}
.btn.copy{background: linear-gradient(135deg, rgba(34,211,238,.55), rgba(99,102,241,.55)); border-color: rgba(34,211,238,.18);}
.btn.export{background: linear-gradient(135deg, rgba(99,102,241,.70), rgba(167,139,250,.70)); border-color: rgba(167,139,250,.22);}
.btn.clear{background: linear-gradient(135deg, rgba(148,163,184,.35), rgba(51,65,85,.55)); border-color: rgba(148,163,184,.18);}

.sectionTitle{display:flex; justify-content:space-between; align-items:center; gap:10px; margin: 2px 0 8px;}
.sectionTitle b{font-size:13px}
.sectionTitle small{color:var(--muted); font-weight:900}

.modeRow{display:flex; gap:10px; flex-wrap:wrap;}
.mode{
  flex:1;
  min-width: 160px;
  display:flex; align-items:center; justify-content:center;
  gap:10px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  padding: 10px 12px;
  font-weight: 950;
  cursor:pointer;
}
.mode input{accent-color: var(--c2)}
.mode.active{
  border-color: rgba(99,102,241,.7);
  box-shadow: 0 0 0 4px rgba(99,102,241,.14);
  background: rgba(99,102,241,.08);
}

.two{display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}
@media(max-width:500px){.two{grid-template-columns:1fr}}

.hint{margin-top:6px; color: var(--muted); font-size: 12px; font-weight: 900;}

.badges{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
.badge{
  padding: 7px 10px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  font-size: 12px;
  font-weight: 950;
}
.badge b{color: var(--c2);}

.box{
  margin-top:10px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  border-radius: 14px;
  padding: 10px;
  max-height: 220px;
  overflow:auto;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12px;
  white-space: pre;
}

.status{
  margin-top:10px;
  border-radius: 14px;
  border:1px dashed rgba(148,163,184,.25);
  padding: 10px 12px;
  font-weight: 900;
  font-size: 13px;
  color: var(--muted);
}

/* Tables */
.tableWrap{
  margin-top:16px;
  border:1px solid var(--line);
  border-radius: var(--r);
  overflow:auto;
  background: rgba(2,6,23,.82);
  max-height: 560px;
}
table{width:100%; border-collapse:collapse; font-size:13px;}
thead{
  position:sticky; top:0; z-index:2;
  background: rgba(15,26,46,.95);
  backdrop-filter: blur(8px);
}
th,td{
  padding: 12px 12px;
  border-bottom: 1px solid rgba(148,163,184,.14);
  white-space:nowrap;
}
tbody tr:hover{background: rgba(99,102,241,.08)}
.empty{ text-align:center; color:var(--muted); padding: 26px; font-weight: 950; }

/* Keyword tags */
.tagsWrap{
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  border-radius: 14px;
  padding: 10px;
  max-height: 160px;
  overflow:auto;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.tag{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 7px 10px;
  border-radius: 999px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.65);
  font-weight: 950;
  font-size: 12px;
}
.tag button{
  border:none;
  width:18px;height:18px;
  border-radius: 999px;
  cursor:pointer;
  background: rgba(239,68,68,.18);
  color: #fecaca;
  font-weight: 950;
}
.tag button:hover{filter:brightness(1.1)}

.smallRow{
  display:grid;
  grid-template-columns: 1.25fr .75fr;
  gap: 10px;
}
@media (max-width:1000px){.smallRow{grid-template-columns:1fr}}

.inlineNote{
  color: var(--muted);
  font-weight: 900;
  font-size: 12px;
}

/* Maintenance modal */
.modalBackdrop{
  position:fixed; inset:0; z-index:9999;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 18px;
}
.modal{
  width:min(980px, 100%);
  border-radius: 18px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.96);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.modalHeader{
  display:flex; align-items:center; justify-content:space-between;
  padding: 12px 14px;
  border-bottom: 1px solid rgba(148,163,184,.14);
  background: rgba(255,255,255,.03);
}
.modalHeader b{font-size:13px}
.modalHeader button{
  border:none;
  background: rgba(255,255,255,.06);
  color: var(--text);
  border:1px solid var(--line);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight: 950;
}
.modalBody{padding: 14px; display:grid; grid-template-columns: 1fr 1fr; gap: 14px;}
@media(max-width:900px){.modalBody{grid-template-columns:1fr}}
.previewBox{
  border:1px solid var(--line);
  border-radius: 14px;
  overflow:hidden;
  background: rgba(255,255,255,.02);
  min-height: 240px;
  display:flex; align-items:center; justify-content:center;
  color: var(--muted);
  font-weight: 950;
}
.previewBox img{max-width:100%; height:auto; display:block;}
</style>
</head>

<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>CSV Analyzer</h1>
        <p></p>
      </div>
    </div>

    <div class="pills">
      <div class="pill">
        <span class="dot warn" id="pillDot"></span>
        <span id="pillText">Ready</span>
      </div>

      <!-- Maintenance (kifma kant) -->
      <div class="pill" style="cursor:pointer" id="btnMaintenanceTop" title="Maintenance report + screenshot">
        üõ† <span id="maintLabel">Maintenance</span>
      </div>
    </div>
  </div>

  <div class="shell">
    <div class="tabs">
      <button class="tab active" id="tabAnalyzer">Imacors</button>
      <button class="tab" id="tabKeyword">Webautomate</button>
    </div>

    <!-- ===================== ANALYZER ===================== -->
    <div class="section active" id="secAnalyzer">
      <div class="grid">
        <div class="panel">
          <div class="panelTitle">
            <b>Input</b>
            <span>Paste CSV / logs here</span>
          </div>
          <textarea id="csvInput" placeholder='Examples:
"1814, Error: Email/Subject/Message not written, 18-12-2024 9-39"
"5731,script Add_language,failed to change language,27-01-2026 11-57"
2504, search Nathan passed successfully,2026-01-16
1961,input empty,21-12-2024_11-7
'></textarea>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <b>Controls</b>
            <span>Classic output</span>
          </div>

          <div class="kpis">
            <div class="kpi"><span>Total rows</span><b id="a_total">‚Äî</b></div>
            <div class="kpi"><span>Visible rows</span><b id="a_count">‚Äî</b></div>
            <div class="kpi"><span>Not processed</span><b id="a_missingCountTop">‚Äî</b></div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="btnProcess">‚ö° Process</button>
            <button class="btn copy" id="btnCopy">üìã Copy IDs</button>
            <button class="btn export" id="btnExport">‚¨á Export CSV</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Date filter</b>
            <small id="dateModeLabel">Single day</small>
          </div>

          <div class="modeRow">
            <label class="mode active" id="modeSingle">
              <input type="radio" name="dateMode" value="single" checked>
              Single day
            </label>
            <label class="mode" id="modeRange">
              <input type="radio" name="dateMode" value="range">
              Date range
            </label>
          </div>

          <div id="singleWrap" style="margin-top:10px">
            <input id="singleDate" placeholder="Day (YYYY-MM-DD or DD-MM-YYYY or M/D/YYYY)">
            <div class="hint">Examples: 2026-01-20 | 20-01-2026 | 1/20/2026</div>
          </div>

          <div id="rangeWrap" style="margin-top:10px;display:none">
            <div class="two">
              <input id="dateFrom" placeholder="From day">
              <input id="dateTo" placeholder="To day">
            </div>
            <div class="hint">Tip: if From &gt; To we auto-swap</div>
          </div>

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr">
            <button class="btn primary" id="btnApplyDate">‚úÖ Apply date</button>
            <button class="btn clear" id="btnClearDate">‚Ü© Clear</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>ID range check</b>
            <small class="inlineNote">Type: 3376 - 4375</small>
          </div>

          <input id="rangeInput" placeholder="1961 - 2240" value="1961 - 2240">

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr 1fr">
            <button class="btn primary" id="btnRange">üîé Check</button>
            <button class="btn copy" id="btnCopyMissing">üìã Copy NOT</button>
            <button class="btn export" id="btnExportMissing">‚¨á Export NOT</button>
          </div>

          <div class="badges">
            <div class="badge">Processed unique: <b id="procInRange">0</b></div>
            <div class="badge">Not processed: <b id="missingCount">0</b></div>
            <div class="badge">Duplicates: <b id="dupCount">0</b></div>
          </div>

          <div class="box" id="missingBox">Run ‚ÄúCheck‚Äù‚Ä¶</div>
          <div class="status" id="status">Waiting‚Ä¶</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>STATUS</th>
              <th>DATETIME</th>
              <th>DAY</th>
            </tr>
          </thead>
          <tbody id="outputBody">
            <tr><td colspan="4" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===================== KEYWORD CHECKER ===================== -->
    <div class="section" id="secKeyword">
      <div class="grid">
        <div class="panel">
          <div class="panelTitle">
            <b>Keyword Checker Input</b>
            <span>Paste table (TAB/CSV/;) with headers</span>
          </div>

          <textarea id="k_input" placeholder='Required headers (case-insensitive):
profile_Name (or profile_name) + log + details
Optional: cnx_problems + tag + status_name + script_name + session_name

Example (TAB):
profile_Name	tag	status_name	log	cnx_problems	details	script_name	session_name
1	[07AD...]	Completed	[ Status => connected Updated!]		...	MyScript	CMH1_IT_3(173.225.106.66)
'></textarea>

          <div class="hint">
            Session name is auto-normalized: <b>CMH1_IT_3(173...)</b> ‚Üí <b>CMH1_IT_3</b>
          </div>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <b>Keyword Checker Controls</b>
            <span>Apps Script logic + Sessions + DISCONNECTED</span>
          </div>

          <div class="kpis">
            <div class="kpi"><span>Total rows</span><b id="k_total">‚Äî</b></div>
            <div class="kpi"><span>Processed</span><b id="k_processed">‚Äî</b></div>
            <div class="kpi"><span>Not processed</span><b id="k_not">‚Äî</b></div>
          </div>

          <div class="kpis" style="margin-top:10px">
            <div class="kpi"><span>Disconnected</span><b id="k_disc">‚Äî</b></div>
            <div class="kpi"><span>Session</span><b id="k_sessCount">‚Äî</b></div>
            <div class="kpi"><span>Delim</span><b id="k_delim">‚Äî</b></div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="k_btnProcess">‚ö° Process</button>
            <button class="btn copy" id="k_btnCopyNot">üìã Copy NOT (profile_Name)</button>
            <button class="btn export" id="k_btnExportNot">‚¨á Export NOT</button>
          </div>

          <div class="controls" style="margin-top:10px">
            <button class="btn copy" id="k_btnCopyDisc">üìã Copy DISCONNECTED</button>
            <button class="btn export" id="k_btnExportDisc">‚¨á Export DISCONNECTED</button>
            <button class="btn clear" id="k_btnClearView">‚Ü© Clear view</button>
          </div>

          <hr class="sep">

          <div class="smallRow">
            <div>
              <div class="sectionTitle" style="margin-bottom:8px">
                <b>Session filter</b>
                <small class="inlineNote">based on session_name</small>
              </div>
              <select id="k_sessionSelect">
                <option value="ALL">ALL sessions</option>
              </select>
              <div class="hint">Counts & output follow selected session.</div>
            </div>

            <div>
              <div class="sectionTitle" style="margin-bottom:8px">
                <b>process_status filter</b>
                <small class="inlineNote">table + output</small>
              </div>
              <select id="k_statusSelect">
                <option value="ALL">ALL</option>
                <option value="PROCESSED">PROCESSED</option>
                <option value="NOT PROCESSED">NOT PROCESSED</option>
                <option value="DISCONNECTED">DISCONNECTED</option>
              </select>
              <div class="hint">Copy/Export always uses <b>profile_Name</b>.</div>
            </div>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Keywords</b>
            <small class="inlineNote">saved in browser (localStorage)</small>
          </div>

          <div class="controls" style="grid-template-columns: 1.4fr .6fr 1fr; align-items:center">
            <input id="k_kwInput" placeholder="Add keyword (ex: done, already, success...)">
            <button class="btn primary" id="k_btnAdd">+ Add</button>
            <button class="btn clear" id="k_btnDefault">‚ü≤ Default list</button>
          </div>

          <div class="controls" style="margin-top:10px; grid-template-columns: 1fr 1fr 1fr">
            <button class="btn clear" id="k_btnNormalize">‚ú® Normalize</button>
            <button class="btn clear" id="k_btnClearKws">üßπ Clear all</button>
            <div class="pill" style="justify-content:center">
              <span class="dot ok" style="opacity:.9"></span>
              <span>Match = keyword in log/details/cnx_problems</span>
            </div>
          </div>

          <div class="tagsWrap" id="k_tags" style="margin-top:10px"></div>

          <!-- IMPORTANT: NO "Keywords used" line -->
          <div class="box" id="k_outputBox" style="margin-top:12px">Paste input then click ‚ÄúProcess‚Äù‚Ä¶</div>
          <div class="status" id="k_status">Waiting‚Ä¶</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>profile_Name</th>
              <th>tag</th>
              <th>status_name</th>
              <th>process_status <span style="opacity:.7; font-weight:900; margin-left:6px">‚ñº</span></th>
              <th>session</th>
              <th>log/details (preview)</th>
            </tr>
          </thead>
          <tbody id="k_tableBody">
            <tr><td colspan="7" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- ===================== MAINTENANCE MODAL (KIFMA KANT + screenshot) ===================== -->
<div class="modalBackdrop" id="m_backdrop">
  <div class="modal">
    <div class="modalHeader">
      <b>üõ† Maintenance report</b>
      <button id="m_close">‚úï Close</button>
    </div>
    <div class="modalBody">
      <div>
        <div class="panelTitle" style="margin:0 0 10px 0">
          <b>Report</b>
          <span>same format</span>
        </div>

        <div class="box" id="m_reportBox">‚Äî</div>

        <div class="hint" style="margin-top:10px">
          Screenshot: browser ŸÉŸäÿ∑ŸëŸÑÿ® permission (Share screen).  
          Telegram send ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÖŸÜ HTML local ÿ∫ÿßŸÑÿ®ÿßŸã ŸÉŸäÿ≥ŸÇÿ∑ (CORS)ÿå ŸÑÿ∞ŸÑŸÉ ÿßÿ≥ÿ™ÿπŸÖŸÑ webhook.
        </div>

        <hr class="sep">

        <div class="sectionTitle">
          <b>Webhook (to Telegram)</b>
          <small>recommended</small>
        </div>
        <input id="m_webhook" placeholder="Put your webhook URL ŸáŸÜÿß (n8n / backend)">

        <div class="controls" style="margin-top:10px; grid-template-columns: 1fr 1fr 1fr">
          <button class="btn primary" id="m_captureSend">Send (report + screenshot)</button>
          <button class="btn copy" id="m_copyReport">Copy report</button>
          <button class="btn export" id="m_downloadShot">Download screenshot</button>
        </div>

        <div class="status" id="m_status">Waiting‚Ä¶</div>
      </div>

      <div>
        <div class="panelTitle" style="margin:0 0 10px 0">
          <b>Screenshot preview</b>
          <span>latest capture</span>
        </div>
        <div class="previewBox" id="m_previewBox">
          No screenshot yet
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Shared Helpers
========================================================= */
const $ = (id)=>document.getElementById(id);

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeCsv(s){
  s = String(s ?? "");
  if(/[;\n\r"]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function setTopPill(type, text){
  const dot = $("pillDot");
  const pillText = $("pillText");
  dot.className = "dot " + (type || "warn");
  pillText.textContent = text || "Ready";
}
function setStatus(msg, type="muted"){
  const el = $("status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setTopPill(type === "ok" ? "ok" : type === "bad" ? "bad" : type === "warn" ? "warn" : "warn", msg);
}
function setKStatus(msg, type="muted"){
  const el = $("k_status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setTopPill(type === "ok" ? "ok" : type === "bad" ? "bad" : type === "warn" ? "warn" : "warn", msg);
}
function setMStatus(msg, type="muted"){
  const el = $("m_status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setTopPill(type === "ok" ? "ok" : type === "bad" ? "bad" : type === "warn" ? "warn" : "warn", msg);
}

/* =========================================================
   Tabs
========================================================= */
function activateTab(name){
  const isA = name==="Analyzer";
  $("tabAnalyzer").classList.toggle("active", isA);
  $("tabKeyword").classList.toggle("active", !isA);
  $("secAnalyzer").classList.toggle("active", isA);
  $("secKeyword").classList.toggle("active", !isA);
  setTopPill("warn", name + " ready");
}
$("tabAnalyzer").addEventListener("click", ()=>activateTab("Analyzer"));
$("tabKeyword").addEventListener("click", ()=>activateTab("Keyword Checker"));

/* =========================================================
   ANALYZER (old logic)
========================================================= */
function cleanField(v){
  return String(v ?? "")
    .trim()
    .replace(/^"+|"+$/g,"")
    .replace(/^'+|'+$/g,"")
    .trim();
}
function isTimeField(v){
  v = String(v||"").trim();
  return /^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/i.test(v);
}
function parseDateOnlyFlexible(v){
  v = String(v||"").trim();
  if(!v) return null;

  if(v.includes("_")) v = v.split("_")[0].trim();
  if(/\s/.test(v)) v = v.split(/\s+/)[0].trim();

  v = v.replace(/,/g,"").trim();
  const s = v.replace(/\./g,"/").replace(/-/g,"/");

  const m = s.match(/^(\d{1,4})\/(\d{1,2})\/(\d{1,4})$/);
  if(!m) return null;

  let a = Number(m[1]), b = Number(m[2]), c = Number(m[3]);
  if([a,b,c].some(n=>Number.isNaN(n))) return null;

  let yyyy, mm, dd;

  if(m[1].length === 4){
    yyyy = a; mm = b; dd = c;          // YYYY/MM/DD
  } else if(m[3].length === 4){
    yyyy = c;
    if(a > 12){ dd = a; mm = b; }      // DD/MM/YYYY
    else if(b > 12){ mm = a; dd = b; } // MM/DD/YYYY (rare)
    else { mm = a; dd = b; }           // default MM/DD/YYYY
  } else return null;

  if(yyyy < 1900 || yyyy > 2100) return null;
  if(mm < 1 || mm > 12) return null;
  if(dd < 1 || dd > 31) return null;

  return {yyyy, mm, dd};
}
function dayKeyFrom(yyyy,mm,dd){
  const pad = n => String(n).padStart(2,"0");
  return `${yyyy}-${pad(mm)}-${pad(dd)}`;
}
function toUTCDate(dayKey){
  const [y,m,d] = dayKey.split("-").map(Number);
  return new Date(Date.UTC(y, m-1, d));
}
function detectDelimiter(lines){
  let semi=0, comma=0;
  for(const ln of lines.slice(0,30)){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
  }
  return comma >= semi ? "," : ";";
}
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}
function parseText(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return [];

  const delim = detectDelimiter(lines);
  const rows = [];

  for(const line0 of lines){
    const parts = splitCSVLine(line0, delim).map(cleanField).filter(x => x !== "");
    if(parts.length < 2) continue;

    const id = parseInt(parts[0],10);
    if(!Number.isFinite(id)) continue;

    let dateIdx = -1, d = null;
    for(let i=1;i<parts.length;i++){
      const maybe = parseDateOnlyFlexible(parts[i]);
      if(maybe){ dateIdx = i; d = maybe; break; }
    }
    if(dateIdx === -1) continue;

    let timeStr = "";
    if(dateIdx + 1 < parts.length && isTimeField(parts[dateIdx + 1])) timeStr = parts[dateIdx + 1];

    const day = dayKeyFrom(d.yyyy, d.mm, d.dd);
    const dt = (parts[dateIdx] + (timeStr ? " " + timeStr : "")).trim();
    const status = parts.slice(1, dateIdx).join(" ").trim() || "(no status)";

    rows.push({ id, idText:String(id), status, datetime: dt, day });
  }

  return rows;
}

/* Analyzer state */
let allRows = [];
let visibleRows = [];
let missingIDs = [];

function renderTable(){
  const body = $("outputBody");
  body.innerHTML = "";

  if(!visibleRows.length){
    body.innerHTML = `<tr><td colspan="4" class="empty">No rows</td></tr>`;
    $("a_count").textContent = "0";
    return;
  }

  for(const r of visibleRows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.idText)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.datetime)}</td>
      <td>${escapeHtml(r.day)}</td>
    `;
    body.appendChild(tr);
  }
  $("a_count").textContent = String(visibleRows.length);
}

function resetRangeBox(){
  $("procInRange").textContent = "0";
  $("missingCount").textContent = "0";
  $("dupCount").textContent = "0";
  $("a_missingCountTop").textContent = "‚Äî";
  $("missingBox").textContent = 'Run ‚ÄúCheck‚Äù‚Ä¶';
  missingIDs = [];
}

function dateMode(){
  const r = document.querySelector('input[name="dateMode"]:checked');
  return r ? r.value : "single";
}
function normalizeDateInput(v){
  const d = parseDateOnlyFlexible(v);
  if(!d) return null;
  return dayKeyFrom(d.yyyy, d.mm, d.dd);
}
function applyDateFilter(){
  if(!allRows.length){ setStatus("Process first", "bad"); return; }

  const mode = dateMode();
  if(mode === "single"){
    const day = normalizeDateInput($("singleDate").value);
    if(!day){ setStatus("Invalid day", "bad"); return; }
    visibleRows = allRows.filter(r => r.day === day);
    renderTable(); resetRangeBox();
    setStatus(`Filtered by day: ${day}`, "ok");
  } else {
    const from = normalizeDateInput($("dateFrom").value);
    const to = normalizeDateInput($("dateTo").value);
    if(!from || !to){ setStatus("Invalid date range", "bad"); return; }
    const a = toUTCDate(from).getTime();
    const b = toUTCDate(to).getTime();
    const lo = Math.min(a,b), hi = Math.max(a,b);

    visibleRows = allRows.filter(r=>{
      const t = toUTCDate(r.day).getTime();
      return t >= lo && t <= hi;
    });
    renderTable(); resetRangeBox();
    setStatus(`Filtered range: ${from} ‚Üí ${to}`, "ok");
  }
}
function clearDateFilter(){
  visibleRows = [...allRows];
  $("singleDate").value = "";
  $("dateFrom").value = "";
  $("dateTo").value = "";
  renderTable(); resetRangeBox();
  setStatus("Date filter cleared (showing all rows)", "ok");
}

function parseRangeInput(s){
  s = String(s||"").trim();
  if(!s) return null;
  const m = s.match(/^\s*(\d+)\s*[-‚Äì‚Äî]\s*(\d+)\s*$/) || s.match(/^\s*(\d+)\s+(\d+)\s*$/);
  if(!m) return null;
  let from = Number(m[1]), to = Number(m[2]);
  if(Number.isNaN(from) || Number.isNaN(to)) return null;
  if(from > to){ const t=from; from=to; to=t; }
  return {from,to};
}

function checkRange(){
  if(!visibleRows.length){ setStatus("No visible rows (apply date first)", "bad"); return; }
  const rr = parseRangeInput($("rangeInput").value);
  if(!rr){ setStatus("Invalid ID range (use: 3376 - 4375)", "bad"); return; }
  const {from,to} = rr;

  const counts = new Map();
  for(const r of visibleRows) counts.set(r.id, (counts.get(r.id)||0)+1);

  let dupN = 0;
  for(const [,c] of counts) if(c>1) dupN++;
  $("dupCount").textContent = String(dupN);

  let processedUniqueInRange = 0;
  for(const [id] of counts) if(id>=from && id<=to) processedUniqueInRange++;
  $("procInRange").textContent = String(processedUniqueInRange);

  missingIDs = [];
  for(let i=from;i<=to;i++) if(!counts.has(i)) missingIDs.push(i);
  $("missingCount").textContent = String(missingIDs.length);
  $("a_missingCountTop").textContent = String(missingIDs.length);

  $("missingBox").textContent =
`Scope = visible rows (your date filter)
ID Range: ${from} ‚Üí ${to}

NOT processed (${missingIDs.length}):
${missingIDs.slice(0, 400).join("\n") || "‚Äî"}

(Preview first 400)`;

  setStatus("Range computed ‚úÖ", "ok");
}

function copyIDs(){
  if(!visibleRows.length){ setStatus("No visible rows to copy", "warn"); return; }
  navigator.clipboard.writeText(visibleRows.map(r=>r.idText).join("\n"))
    .then(()=>setStatus(`Copied ${visibleRows.length} IDs`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function exportVisibleCSV(){
  if(!visibleRows.length){ setStatus("No visible rows to export", "warn"); return; }
  let csv = "ID;STATUS;DATETIME;DAY\n";
  for(const r of visibleRows){
    csv += `${safeCsv(r.idText)};${safeCsv(r.status)};${safeCsv(r.datetime)};${safeCsv(r.day)}\n`;
  }
  downloadBlob(csv, "visible.csv", "text/csv;charset=utf-8;");
  setStatus(`Exported visible.csv (${visibleRows.length})`, "ok");
}
function copyMissing(){
  if(!missingIDs.length){ setStatus("No NOT processed IDs", "warn"); return; }
  navigator.clipboard.writeText(missingIDs.join("\n"))
    .then(()=>setStatus(`Copied NOT processed (${missingIDs.length})`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function exportMissing(){
  if(!missingIDs.length){ setStatus("No NOT processed IDs", "warn"); return; }
  const rr = parseRangeInput($("rangeInput").value);
  const name = rr ? `not_processed_${rr.from}-${rr.to}.csv` : "not_processed.csv";
  downloadBlob("ID\n" + missingIDs.join("\n"), name, "text/csv;charset=utf-8;");
  setStatus(`Exported ${name}`, "ok");
}

function processCSV(){
  const text = $("csvInput").value.trim();
  if(!text){ setStatus("Input empty", "bad"); return; }

  allRows = parseText(text);
  $("a_total").textContent = String(allRows.length);

  visibleRows = [...allRows];
  renderTable();
  resetRangeBox();

  if(!allRows.length){
    setStatus("No valid rows parsed (check format)", "bad");
    return;
  }

  const days = [...new Set(allRows.map(r=>r.day))].sort((a,b)=>b.localeCompare(a));
  $("singleDate").value = days[0] || "";
  setStatus("Parsed ‚úÖ Now choose date and Apply, then Check.", "ok");
}

/* Analyzer Mode toggle visuals */
function refreshModeUI(){
  const m = dateMode();
  $("dateModeLabel").textContent = m === "single" ? "Single day" : "Date range";
  $("singleWrap").style.display = m === "single" ? "block" : "none";
  $("rangeWrap").style.display = m === "range" ? "block" : "none";
  $("modeSingle").classList.toggle("active", m === "single");
  $("modeRange").classList.toggle("active", m === "range");
  resetRangeBox();
  setStatus(`Date mode: ${m}`, "ok");
}

/* Wire Analyzer */
$("btnProcess").addEventListener("click", processCSV);
$("btnCopy").addEventListener("click", copyIDs);
$("btnExport").addEventListener("click", exportVisibleCSV);
$("btnApplyDate").addEventListener("click", applyDateFilter);
$("btnClearDate").addEventListener("click", clearDateFilter);
$("btnRange").addEventListener("click", checkRange);
$("btnCopyMissing").addEventListener("click", copyMissing);
$("btnExportMissing").addEventListener("click", exportMissing);
document.querySelectorAll('input[name="dateMode"]').forEach(r=> r.addEventListener("change", refreshModeUI));

/* =========================================================
   KEYWORD CHECKER (Apps Script logic + sessions + DISCONNECTED)
========================================================= */
const K_STORAGE_KEY = "kw_checker_keywords_v3";

const K_DEFAULT = [
  "done","already","reply","forward","search completed for","markunread",
  "sendmessage","successfully","birthdaychanged","click","gender updated",
  "theme already changed","gmail template updated","languagevalue updated",
  "english has been added"
];

function k_norm(s){
  if(s === null || s === undefined) return "";
  let t = String(s);
  if(t === "#ERROR!") return "";
  t = t.replace(/^[=;]+>?/g, "");
  return t.toLowerCase();
}
function k_fixFormulaText(v){
  if (v === null || v === undefined) return v;
  let s = String(v);
  if (s.startsWith('=') || s.startsWith(';')) {
    return "'" + s.replace(/^[=;]+>?/g, '');
  }
  return s;
}
function k_loadKeywords(){
  try{
    const raw = localStorage.getItem(K_STORAGE_KEY);
    if(!raw) return [...K_DEFAULT];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [...K_DEFAULT];
    return arr.map(x=>String(x)).filter(Boolean);
  }catch(e){
    return [...K_DEFAULT];
  }
}
function k_saveKeywords(list){
  localStorage.setItem(K_STORAGE_KEY, JSON.stringify(list));
}
let k_keywords = k_loadKeywords();

function k_renderTags(){
  const wrap = $("k_tags");
  wrap.innerHTML = "";
  if(!k_keywords.length){
    wrap.innerHTML = `<span class="inlineNote">No keywords. Click ‚ÄúDefault list‚Äù.</span>`;
    return;
  }
  k_keywords.forEach((kw, idx)=>{
    const el = document.createElement("span");
    el.className = "tag";
    el.innerHTML = `${escapeHtml(kw)} <button title="remove">√ó</button>`;
    el.querySelector("button").addEventListener("click", ()=>{
      k_keywords.splice(idx,1);
      k_saveKeywords(k_keywords);
      k_renderTags();
      setKStatus("Keyword removed", "ok");
    });
    wrap.appendChild(el);
  });
}

function k_addKeyword(){
  const v = $("k_kwInput").value.trim();
  if(!v){ setKStatus("Keyword empty", "warn"); return; }
  k_keywords.push(v);
  k_saveKeywords(k_keywords);
  $("k_kwInput").value = "";
  k_renderTags();
  setKStatus("Keyword added ‚úÖ", "ok");
}
function k_setDefault(){
  k_keywords = [...K_DEFAULT];
  k_saveKeywords(k_keywords);
  k_renderTags();
  setKStatus("Default list loaded ‚úÖ", "ok");
}
function k_clearAllKeywords(){
  k_keywords = [];
  k_saveKeywords(k_keywords);
  k_renderTags();
  setKStatus("All keywords cleared", "ok");
}
function k_normalizeKeywords(){
  const set = new Set();
  const out = [];
  for(const kw of k_keywords){
    const t = String(kw).trim().toLowerCase();
    if(!t) continue;
    if(set.has(t)) continue;
    set.add(t);
    out.push(t);
  }
  k_keywords = out;
  k_saveKeywords(k_keywords);
  k_renderTags();
  setKStatus("Keywords normalized ‚úÖ", "ok");
}

function k_detectDelim(lines){
  for(const ln of lines.slice(0,10)){
    if(ln.includes("\t")) return "TAB";
  }
  let semi=0, comma=0;
  for(const ln of lines.slice(0,30)){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
  }
  return comma >= semi ? "," : ";";
}
function k_splitLine(line, delim){
  if(delim === "TAB") return line.split("\t");
  const out = [];
  let cur="", inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur+='"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}
function k_clean(v){
  return String(v ?? "")
    .trim()
    .replace(/^"+|"+$/g,"")
    .replace(/^'+|'+$/g,"")
    .trim();
}
function k_findIdx(headerParts, wanted){
  // wanted list already normalized (no spaces)
  for(let i=0;i<headerParts.length;i++){
    const h = headerParts[i].toLowerCase().replace(/\s+/g,"").replace(/_/g,"");
    if(wanted.includes(h)) return i;
  }
  return -1;
}
function k_normSessionName(s){
  s = String(s ?? "").trim();
  if(!s) return "";
  // keep only before first "("
  const i = s.indexOf("(");
  if(i !== -1) s = s.slice(0,i).trim();
  return s;
}

/* State */
let k_allRows = [];
let k_visibleRows = [];
let k_notUniqueProfiles = [];
let k_discUniqueProfiles = [];

function k_buildSessionOptions(){
  const sel = $("k_sessionSelect");
  const prev = sel.value || "ALL";
  const set = new Set();
  for(const r of k_allRows){
    if(r.session) set.add(r.session);
  }
  const sessions = [...set].sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = `<option value="ALL">ALL sessions</option>` + sessions.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  sel.value = sessions.includes(prev) ? prev : "ALL";
}

function k_buildNotAndDiscLists(){
  const notSet = new Set();
  const discSet = new Set();

  for(const r of k_visibleRows){
    if(r.process_status === "NOT PROCESSED" && r.profile_Name) notSet.add(r.profile_Name);
    if(r.process_status === "DISCONNECTED" && r.profile_Name) discSet.add(r.profile_Name);
  }

  const sortProfiles = (arr)=>arr.sort((a,b)=>{
    const na = Number(a), nb = Number(b);
    if(Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
    return String(a).localeCompare(String(b));
  });

  k_notUniqueProfiles = sortProfiles([...notSet]);
  k_discUniqueProfiles = sortProfiles([...discSet]);
}

function k_renderOutputBox(){
  const sess = $("k_sessionSelect").value || "ALL";
  const ps = $("k_statusSelect").value || "ALL";

  let list = [];
  if(ps === "NOT PROCESSED") list = k_notUniqueProfiles;
  else if(ps === "DISCONNECTED") list = k_discUniqueProfiles;
  else if(ps === "PROCESSED"){
    const set = new Set();
    for(const r of k_visibleRows) if(r.process_status === "PROCESSED" && r.profile_Name) set.add(r.profile_Name);
    list = [...set].sort((a,b)=>{
      const na = Number(a), nb = Number(b);
      if(Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
      return String(a).localeCompare(String(b));
    });
  } else {
    const set = new Set([...k_notUniqueProfiles, ...k_discUniqueProfiles]);
    list = [...set].sort((a,b)=>{
      const na = Number(a), nb = Number(b);
      if(Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
      return String(a).localeCompare(String(b));
    });
  }

  const head = `Session: ${sess}\nFilter: ${ps}\nCount: ${list.length}\n\n`;
  $("k_outputBox").textContent = head + (list.join("\n") || "‚Äî");
}

function k_renderTable(){
  const body = $("k_tableBody");
  body.innerHTML = "";

  if(!k_visibleRows.length){
    body.innerHTML = `<tr><td colspan="7" class="empty">No rows</td></tr>`;
    return;
  }

  const max = Math.min(k_visibleRows.length, 2000);
  for(let i=0;i<max;i++){
    const r = k_visibleRows[i];
    const tr = document.createElement("tr");

    const ps = r.process_status;
    const psColor =
      ps === "PROCESSED" ? "var(--ok)" :
      ps === "DISCONNECTED" ? "var(--warn)" :
      "var(--bad)";

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(r.profile_Name)}</td>
      <td>${escapeHtml(r.tag || "")}</td>
      <td>${escapeHtml(r.status_name || "")}</td>
      <td style="font-weight:950; color:${psColor}">${escapeHtml(ps)}</td>
      <td>${escapeHtml(r.session || "")}</td>
      <td>${escapeHtml(r.preview)}</td>
    `;
    body.appendChild(tr);
  }
}

function k_applyViewFilters(){
  const sess = $("k_sessionSelect").value || "ALL";
  const ps = $("k_statusSelect").value || "ALL";

  let rows = [...k_allRows];
  if(sess !== "ALL") rows = rows.filter(r => r.session === sess);
  if(ps !== "ALL") rows = rows.filter(r => r.process_status === ps);

  k_visibleRows = rows;
  k_renderTable();
  k_buildNotAndDiscLists();
  k_renderOutputBox();
}

function k_process(){
  const text = $("k_input").value.trim();
  if(!text){ setKStatus("Input empty", "bad"); return; }

  const lines = text.replace(/\r/g,"").split("\n").filter(Boolean);
  if(lines.length < 2){ setKStatus("Need header + rows", "bad"); return; }

  const delim = k_detectDelim(lines);
  $("k_delim").textContent = delim;

  const headerParts = k_splitLine(lines[0], delim).map(k_clean);
  const profileIdx = k_findIdx(headerParts, ["profilename"]);
  const logIdx = k_findIdx(headerParts, ["log"]);
  const detailsIdx = k_findIdx(headerParts, ["details"]);

  if(profileIdx === -1 || logIdx === -1 || detailsIdx === -1){
    setKStatus("Missing required headers: profile_Name + log + details", "bad");
    return;
  }

  const tagIdx = k_findIdx(headerParts, ["tag"]);
  const statusNameIdx = k_findIdx(headerParts, ["statusname"]);
  const cnxIdx = k_findIdx(headerParts, ["cnxproblems"]);
  const scriptIdx = k_findIdx(headerParts, ["scriptname"]);
  const sessionIdx = k_findIdx(headerParts, ["sessionname"]);

  const kws = k_keywords.map(x=>String(x).trim().toLowerCase()).filter(Boolean);

  const rows = [];
  for(let li=1; li<lines.length; li++){
    const parts = k_splitLine(lines[li], delim).map(k_clean);
    if(parts.every(x=>!x)) continue;

    const profile = (parts[profileIdx] ?? "").trim();
    if(!profile) continue;

    const rawLog = (parts[logIdx] ?? "");
    const rawDetails = (parts[detailsIdx] ?? "");
    const rawCnx = (cnxIdx !== -1 ? (parts[cnxIdx] ?? "") : "");

    const logText = k_norm(rawLog);
    const detailsText = k_norm(rawDetails);
    const cnxText = k_norm(rawCnx);

    const isDisconnected =
      logText.includes("disconnected") ||
      detailsText.includes("disconnected") ||
      cnxText.includes("disconnected");

    let processed = false;
    if(!isDisconnected){
      if(logText || detailsText || cnxText){
        for(const kw of kws){
          if(logText.includes(kw) || detailsText.includes(kw) || cnxText.includes(kw)){
            processed = true;
            break;
          }
        }
      }
    }

    const process_status = isDisconnected ? "DISCONNECTED" : (processed ? "PROCESSED" : "NOT PROCESSED");

    const tag = (tagIdx !== -1 ? parts[tagIdx] : "").trim();
    const status_name = (statusNameIdx !== -1 ? parts[statusNameIdx] : "").trim();
    const script_name = (scriptIdx !== -1 ? parts[scriptIdx] : "").trim();
    const session_raw = (sessionIdx !== -1 ? parts[sessionIdx] : "").trim();
    const session = k_normSessionName(session_raw);

    const preview = k_fixFormulaText(
      (rawLog ? rawLog : "") +
      (rawDetails ? (" | " + rawDetails) : "") +
      (rawCnx ? (" | " + rawCnx) : "")
    ).slice(0, 220);

    rows.push({
      profile_Name: profile,
      tag,
      status_name,
      script_name,
      session,
      process_status,
      preview
    });
  }

  k_allRows = rows;

  if(!k_allRows.length){
    setKStatus("No valid rows parsed (check header + delimiter)", "bad");
    $("k_total").textContent = "0";
    $("k_processed").textContent = "0";
    $("k_not").textContent = "0";
    $("k_disc").textContent = "0";
    $("k_sessCount").textContent = "0";
    k_visibleRows = [];
    k_renderTable();
    $("k_outputBox").textContent = "‚Äî";
    return;
  }

  const cProcessed = k_allRows.filter(r=>r.process_status==="PROCESSED").length;
  const cNot = k_allRows.filter(r=>r.process_status==="NOT PROCESSED").length;
  const cDisc = k_allRows.filter(r=>r.process_status==="DISCONNECTED").length;
  const sessSet = new Set(k_allRows.map(r=>r.session).filter(Boolean));

  $("k_total").textContent = String(k_allRows.length);
  $("k_processed").textContent = String(cProcessed);
  $("k_not").textContent = String(cNot);
  $("k_disc").textContent = String(cDisc);
  $("k_sessCount").textContent = String(sessSet.size);

  k_buildSessionOptions();
  k_visibleRows = [...k_allRows];
  k_applyViewFilters();

  setKStatus("Keyword check done ‚úÖ", "ok");
}

function k_copyList(list, label){
  if(!list.length){ setKStatus(`No ${label} profiles in current view`, "warn"); return; }
  navigator.clipboard.writeText(list.join("\n"))
    .then(()=>setKStatus(`Copied ${label} (${list.length})`, "ok"))
    .catch(()=>setKStatus("Clipboard blocked by browser", "bad"));
}
function k_exportList(list, filename, label){
  if(!list.length){ setKStatus(`No ${label} profiles in current view`, "warn"); return; }
  downloadBlob("profile_Name\n" + list.join("\n"), filename, "text/csv;charset=utf-8;");
  setKStatus(`Exported ${filename}`, "ok");
}

function k_copyNot(){ k_copyList(k_notUniqueProfiles, "NOT PROCESSED"); }
function k_exportNot(){
  const sess = $("k_sessionSelect").value || "ALL";
  const name = `not_processed_${sess}.csv`.replace(/[^\w\-.]+/g,"_");
  k_exportList(k_notUniqueProfiles, name, "NOT PROCESSED");
}
function k_copyDisc(){ k_copyList(k_discUniqueProfiles, "DISCONNECTED"); }
function k_exportDisc(){
  const sess = $("k_sessionSelect").value || "ALL";
  const name = `disconnected_${sess}.csv`.replace(/[^\w\-.]+/g,"_");
  k_exportList(k_discUniqueProfiles, name, "DISCONNECTED");
}

function k_clearView(){
  $("k_input").value = "";
  k_allRows = [];
  k_visibleRows = [];
  k_notUniqueProfiles = [];
  k_discUniqueProfiles = [];
  $("k_total").textContent = "‚Äî";
  $("k_processed").textContent = "‚Äî";
  $("k_not").textContent = "‚Äî";
  $("k_disc").textContent = "‚Äî";
  $("k_sessCount").textContent = "‚Äî";
  $("k_delim").textContent = "‚Äî";
  $("k_outputBox").textContent = "Paste input then click ‚ÄúProcess‚Äù‚Ä¶";
  $("k_tableBody").innerHTML = `<tr><td colspan="7" class="empty">No data yet</td></tr>`;
  $("k_sessionSelect").innerHTML = `<option value="ALL">ALL sessions</option>`;
  $("k_statusSelect").value = "ALL";
  setKStatus("Cleared ‚úÖ", "ok");
}

/* Wire Keyword Checker */
$("k_btnProcess").addEventListener("click", k_process);
$("k_btnAdd").addEventListener("click", k_addKeyword);
$("k_kwInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") k_addKeyword(); });
$("k_btnDefault").addEventListener("click", k_setDefault);
$("k_btnClearKws").addEventListener("click", k_clearAllKeywords);
$("k_btnNormalize").addEventListener("click", k_normalizeKeywords);

$("k_sessionSelect").addEventListener("change", ()=>{ if(k_allRows.length) k_applyViewFilters(); });
$("k_statusSelect").addEventListener("change", ()=>{ if(k_allRows.length) k_applyViewFilters(); });

$("k_btnCopyNot").addEventListener("click", k_copyNot);
$("k_btnExportNot").addEventListener("click", k_exportNot);
$("k_btnCopyDisc").addEventListener("click", k_copyDisc);
$("k_btnExportDisc").addEventListener("click", k_exportDisc);
$("k_btnClearView").addEventListener("click", k_clearView);

k_renderTags();

/* =========================================================
   Maintenance (KIFMA KANT) + screenshot via webhook
========================================================= */
function buildMaintenanceReport(){
  const mode =
    $("secAnalyzer").classList.contains("active") ? "Analyzer" : "Keyword Checker";

  const statusText =
    $("secAnalyzer").classList.contains("active") ? $("status").textContent :
    $("k_status").textContent;

  // SAME FORMAT as user showed
  return `üõ† Maintenance report
Mode: ${mode}
Time: ${new Date().toISOString()}
URL: ${location.href}
UA: ${navigator.userAgent}
Status: ${statusText || "Waiting‚Ä¶"}`;
}

function openMaintenance(){
  $("m_backdrop").style.display = "flex";
  const report = buildMaintenanceReport();
  $("m_reportBox").textContent = report;
  setMStatus("Waiting‚Ä¶", "muted");
}
function closeMaintenance(){
  $("m_backdrop").style.display = "none";
}

$("btnMaintenanceTop").addEventListener("click", openMaintenance);
$("m_close").addEventListener("click", closeMaintenance);
$("m_backdrop").addEventListener("click", (e)=>{
  if(e.target === $("m_backdrop")) closeMaintenance();
});

async function captureScreenshotBlob(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia){
    throw new Error("getDisplayMedia not supported");
  }

  const stream = await navigator.mediaDevices.getDisplayMedia({
    video: true,
    audio: false
  });

  try{
    const track = stream.getVideoTracks()[0];
    const video = document.createElement("video");
    video.srcObject = stream;
    video.muted = true;
    await video.play();

    await new Promise(res=>setTimeout(res, 250));

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    track.stop();
    stream.getTracks().forEach(t=>t.stop());

    const blob = await new Promise((resolve)=>canvas.toBlob(resolve, "image/png", 0.92));
    if(!blob) throw new Error("Failed to create screenshot");
    return blob;
  } finally {
    stream.getTracks().forEach(t=>t.stop());
  }
}

let lastShotBlob = null;

function showPreview(blob){
  lastShotBlob = blob;
  const url = URL.createObjectURL(blob);
  $("m_previewBox").innerHTML = `<img alt="screenshot" src="${url}">`;
}

$("m_copyReport").addEventListener("click", ()=>{
  const report = buildMaintenanceReport();
  $("m_reportBox").textContent = report;
  navigator.clipboard.writeText(report)
    .then(()=>setMStatus("Report copied ‚úÖ", "ok"))
    .catch(()=>setMStatus("Clipboard blocked", "bad"));
});

$("m_downloadShot").addEventListener("click", async ()=>{
  try{
    setMStatus("Capturing screenshot‚Ä¶", "warn");
    const blob = await captureScreenshotBlob();
    showPreview(blob);

    const fileName = `maintenance_${Date.now()}.png`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = fileName;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    setMStatus("Screenshot downloaded ‚úÖ", "ok");
  }catch(e){
    setMStatus("Screenshot failed: " + (e?.message || e), "bad");
  }
});

$("m_captureSend").addEventListener("click", async ()=>{
  const webhook = $("m_webhook").value.trim();
  const report = buildMaintenanceReport();
  $("m_reportBox").textContent = report;

  try{
    setMStatus("Capturing screenshot‚Ä¶", "warn");
    const blob = await captureScreenshotBlob();
    showPreview(blob);

    if(!webhook){
      setMStatus("Webhook empty. Screenshot captured ŸÅŸÇÿ∑. (Download ŸÖŸÖŸÉŸÜ)", "warn");
      return;
    }

    setMStatus("Sending to webhook‚Ä¶", "warn");
    const fd = new FormData();
    fd.append("report", report);
    fd.append("time", new Date().toISOString());
    fd.append("url", location.href);
    fd.append("ua", navigator.userAgent);
    fd.append("screenshot", blob, "screenshot.png");

    const res = await fetch(webhook, { method:"POST", body: fd });
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error("Webhook failed: " + res.status + " " + (txt || ""));
    }

    setMStatus("Sent ‚úÖ (webhook)", "ok");
  }catch(e){
    setMStatus("Send failed: " + (e?.message || e), "bad");
  }
});

/* =========================================================
   Init
========================================================= */
setTopPill("warn","Ready");
refreshModeUI();
</script>
</body>
</html>
