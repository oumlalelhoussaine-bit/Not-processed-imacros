<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV Analyzer ‚Äî Analyzer + Keyword Checker</title>

<style>
:root{
  --bg0:#070b14;
  --bg1:#0b1220;
  --card:#0f1a2e;
  --line:rgba(148,163,184,.18);

  --text:#e5e7eb;
  --muted:#94a3b8;

  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --shadow2: 0 10px 30px rgba(0,0,0,.35);

  --focus: rgba(99,102,241,.22);

  --c1:#6366f1;
  --c2:#22d3ee;

  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --r:18px;
  --r2:14px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(900px 520px at 10% 0%, rgba(99,102,241,.35), transparent 60%),
    radial-gradient(650px 420px at 92% 8%, rgba(34,211,238,.22), transparent 60%),
    radial-gradient(800px 520px at 45% 100%, rgba(34,197,94,.10), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

.container{
  max-width: 1480px;
  margin: 26px auto;
  padding: 0 18px 34px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom: 14px;
}
.brand{
  display:flex;align-items:center;gap:12px;
}
.logo{
  width:38px;height:38px;border-radius:14px;
  background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.65));
  box-shadow: 0 18px 44px rgba(0,0,0,.42);
}
.brandText{
  display:flex;flex-direction:column;gap:4px;
}
.brandText h1{
  margin:0;
  font-size: 20px;
  letter-spacing: .2px;
}
.brandText p{
  margin:0;
  color: var(--muted);
  font-size: 12.5px;
  line-height:1.35;
}

.pills{
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  box-shadow: var(--shadow2);
  color: var(--muted);
  font-weight: 900;
  font-size: 12px;
}
.dot{
  width:8px;height:8px;border-radius:99px;background:rgba(148,163,184,.55);
  box-shadow:0 0 0 3px rgba(148,163,184,.12);
}
.dot.ok{background: var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.14);}
.dot.bad{background: var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.14);}
.dot.warn{background: var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.14);}

.shell{
  border:1px solid var(--line);
  border-radius: var(--r);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow: var(--shadow);
  padding: 14px;
}

.tabs{
  display:flex;gap:10px;align-items:center;
  margin-bottom: 12px;
}
.tab{
  border:1px solid var(--line);
  background: rgba(2,6,23,.72);
  color: var(--text);
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor:pointer;
  transition: .12s ease;
}
.tab:hover{filter:brightness(1.04)}
.tab.active{
  border-color: rgba(99,102,241,.75);
  box-shadow: 0 0 0 4px rgba(99,102,241,.14);
  background: rgba(99,102,241,.10);
}

.panel{
  border:1px solid var(--line);
  background: rgba(2,6,23,.82);
  border-radius: var(--r);
  padding: 14px;
}
.panelTitle{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.panelTitle b{font-size: 13px}
.panelTitle span{color:var(--muted);font-weight:900;font-size:12px}

.grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 14px;
}
@media (max-width: 1050px){
  .grid{grid-template-columns:1fr}
}

textarea{
  width:100%;
  min-height: 320px;
  border-radius: var(--r);
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  color: var(--text);
  padding: 14px 14px;
  outline:none;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12.7px;
  line-height: 1.42;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
textarea:focus{
  border-color: rgba(99,102,241,.85);
  box-shadow: 0 0 0 4px var(--focus);
}

.kpis{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}
@media (max-width: 560px){
  .kpis{grid-template-columns:1fr}
}
.kpi{
  padding: 12px 12px;
  border-radius: var(--r2);
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  display:flex;
  flex-direction:column;
  gap:4px;
}
.kpi span{
  color:var(--muted);
  font-size: 12px;
  font-weight: 900;
}
.kpi b{
  font-size: 18px;
  letter-spacing: .2px;
}

hr.sep{
  border:none;height:1px;background:var(--line);
  margin: 12px 0;
}

.controls{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}
@media (max-width:1000px){
  .controls{grid-template-columns:1fr}
}

/* Buttons */
.btn{
  width:100%;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  padding: 11px 12px;
  cursor:pointer;
  color:white;
  font-weight: 900;
  letter-spacing:.2px;
  transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease;
  background: linear-gradient(135deg, rgba(99,102,241,.85), rgba(34,211,238,.55));
  box-shadow: 0 10px 22px rgba(0,0,0,.28);
  user-select:none;
}
.btn:hover{
  filter:brightness(1.05);
  box-shadow: 0 0 0 3px rgba(99,102,241,.16), 0 14px 28px rgba(0,0,0,.38);
}
.btn:active{transform:scale(.985)}
.btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.2); box-shadow:none;}

.btn.primary{background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70)); border-color: rgba(99,102,241,.25);}
.btn.copy{background: linear-gradient(135deg, rgba(34,211,238,.55), rgba(99,102,241,.55)); border-color: rgba(34,211,238,.18);}
.btn.export{background: linear-gradient(135deg, rgba(99,102,241,.70), rgba(167,139,250,.70)); border-color: rgba(167,139,250,.22);}
.btn.clear{background: linear-gradient(135deg, rgba(148,163,184,.35), rgba(51,65,85,.55)); border-color: rgba(148,163,184,.18);}

.sectionTitle{
  display:flex;justify-content:space-between;align-items:center;gap:10px;
  margin: 2px 0 8px;
}
.sectionTitle b{font-size:13px}
.sectionTitle small{color:var(--muted);font-weight:900}

.modeRow{
  display:flex; gap:10px; flex-wrap:wrap;
}
.mode{
  flex:1;
  min-width: 160px;
  display:flex; align-items:center; justify-content:center;
  gap:10px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  padding: 10px 12px;
  font-weight: 900;
  cursor:pointer;
}
.mode input{accent-color: var(--c2)}
.mode.active{
  border-color: rgba(99,102,241,.7);
  box-shadow: 0 0 0 4px rgba(99,102,241,.14);
  background: rgba(99,102,241,.08);
}

input, select{
  width:100%;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  color:var(--text);
  padding: 11px 12px;
  outline:none;
  font-weight: 900;
}
input:focus, select:focus{
  border-color: rgba(99,102,241,.85);
  box-shadow: 0 0 0 4px var(--focus);
}

.hint{
  margin-top:6px;
  color: var(--muted);
  font-size: 12px;
  font-weight: 900;
}

.two{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
@media(max-width:520px){.two{grid-template-columns:1fr}}

.badges{
  display:flex; flex-wrap:wrap; gap:8px;
  margin-top:10px;
}
.badge{
  padding: 7px 10px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  font-size: 12px;
  font-weight: 900;
}
.badge b{color: var(--c2);}

.box{
  margin-top:10px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  border-radius: 14px;
  padding: 10px;
  max-height: 210px;
  overflow:auto;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12px;
  white-space: pre;
}

.status{
  margin-top:10px;
  border-radius: 14px;
  border:1px dashed rgba(148,163,184,.25);
  padding: 10px 12px;
  font-weight: 900;
  font-size: 13px;
  color: var(--muted);
}

.tableWrap{
  margin-top:14px;
  border:1px solid var(--line);
  border-radius: var(--r);
  overflow:auto;
  background: rgba(2,6,23,.82);
  max-height: 560px;
}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead{
  position:sticky; top:0; z-index:2;
  background: rgba(15,26,46,.95);
  backdrop-filter: blur(8px);
}
th,td{
  padding: 12px 12px;
  border-bottom: 1px solid rgba(148,163,184,.14);
  white-space:nowrap;
}
tbody tr:hover{background: rgba(99,102,241,.08)}
.empty{
  text-align:center;
  color:var(--muted);
  padding: 26px;
  font-weight: 900;
}

/* Small filter "flesh" */
.thFlex{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.fleshBtn{
  width:28px;height:28px;border-radius:10px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition:.12s ease;
}
.fleshBtn:hover{
  background: rgba(99,102,241,.14);
  border-color: rgba(99,102,241,.30);
}
.fleshBtn:active{transform:scale(.98)}
.fleshIcon{
  width:0;height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-top:8px solid rgba(229,231,235,.92);
  opacity:.9;
}

/* Dropdown popover */
.pop{
  position:fixed;
  z-index:50;
  min-width: 200px;
  padding:10px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.95);
  box-shadow: var(--shadow);
  display:none;
}
.pop .popTitle{
  font-weight:900;font-size:12px;color:var(--muted);
  margin:2px 0 8px;
}
.pop .popRow{display:flex;flex-direction:column;gap:8px}
.pop .popRow button{
  width:100%;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color:var(--text);
  padding:10px 10px;
  font-weight:900;
  cursor:pointer;
}
.pop .popRow button:hover{background: rgba(99,102,241,.12)}
.pop .popRow button.active{border-color: rgba(34,211,238,.35); background: rgba(34,211,238,.10);}

/* Keyword tags */
.tags{
  display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;
}
.tag{
  display:inline-flex;align-items:center;gap:8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  padding:8px 10px;
  font-weight:900;
  font-size:12px;
}
.tag .x{
  width:18px;height:18px;border-radius:9px;
  display:flex;align-items:center;justify-content:center;
  background: rgba(239,68,68,.16);
  border:1px solid rgba(239,68,68,.22);
  cursor:pointer;
  font-weight:900;
}
.tag .x:hover{filter:brightness(1.1)}

.smallNote{
  margin-top:8px;
  color:var(--muted);
  font-size:12px;
  font-weight:900;
}

/* Maintenance button */
.btn.maint{
  background: linear-gradient(135deg, rgba(245,158,11,.35), rgba(239,68,68,.35));
  border-color: rgba(245,158,11,.22);
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div class="brandText">
        <h1>CSV Analyzer</h1>
        <p>Analyzer (old logic) + Keyword Checker (Apps Script logic) + Maintenance Telegram screenshot.</p>
      </div>
    </div>

    <div class="pills">
      <div class="pill">
        <span class="dot" id="pillDot"></span>
        <span id="pillText">Ready</span>
      </div>
      <div class="pill" id="modePill">Mode: Analyzer</div>
      <button class="pill" id="btnMaintenance" title="Send maintenance report to Telegram">üõ† Maintenance</button>
    </div>
  </div>

  <div class="shell">
    <div class="tabs">
      <button class="tab active" id="tabAnalyzer">Imacros-filter</button>
      <button class="tab" id="tabKeyword">webautomate-filter</button>
    </div>

    <!-- =========================
         ANALYZER VIEW
    ========================== -->
    <div id="viewAnalyzer">
      <div class="grid">
        <div class="panel">
          <div class="panelTitle">
            <b>Input</b>
            <span>Paste CSV / logs here</span>
          </div>
          <textarea id="csvInput" placeholder='Examples:
"5731,script Add_language ,failed to change language,27-01-2026 11-57"
"1849, Error: Email/Subject/Message not written, 18-12-2024 9-47"
1961;input empty;21-12-2024_11-7
'></textarea>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <b>Controls</b>
            <span>Classic output</span>
          </div>

          <div class="kpis">
            <div class="kpi">
              <span>Total rows</span>
              <b id="a_total">‚Äî</b>
            </div>
            <div class="kpi">
              <span>Visible rows</span>
              <b id="a_visible">‚Äî</b>
            </div>
            <div class="kpi">
              <span>Not processed</span>
              <b id="a_notProcessed">0</b>
              <span style="font-size:11px">after Check</span>
            </div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="a_btnProcess">‚ö° Process</button>
            <button class="btn copy" id="a_btnCopy">üìã Copy IDs</button>
            <button class="btn export" id="a_btnExport">‚¨á Export CSV</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Date filter</b>
            <small id="a_dateModeLabel">Single day</small>
          </div>

          <div class="modeRow">
            <label class="mode active" id="a_modeSingle">
              <input type="radio" name="a_dateMode" value="single" checked>
              Single day
            </label>
            <label class="mode" id="a_modeRange">
              <input type="radio" name="a_dateMode" value="range">
              Date range
            </label>
          </div>

          <div id="a_singleWrap" style="margin-top:10px">
            <input id="a_singleDate" placeholder="Day (YYYY-MM-DD or DD-MM-YYYY or M/D/YYYY)">
            <div class="hint">Examples: 2026-01-20 | 20-01-2026 | 1/20/2026</div>
          </div>

          <div id="a_rangeWrap" style="margin-top:10px;display:none">
            <div class="two">
              <input id="a_dateFrom" placeholder="From day">
              <input id="a_dateTo" placeholder="To day">
            </div>
            <div class="hint">Tip: if From > To we auto-swap</div>
          </div>

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr">
            <button class="btn primary" id="a_btnApplyDate">‚úÖ Apply date</button>
            <button class="btn clear" id="a_btnClearDate">‚Ü© Clear</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>ID range check</b>
            <small>Type: 3376 - 4375</small>
          </div>

          <!-- single input like "3376 - 4375" -->
          <input id="a_rangeInput" value="1961 - 2240" placeholder="Example: 3376 - 4375">
          <div class="hint">You can type: 3376-4375 | 3376 - 4375 | 3376 to 4375</div>

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr 1fr">
            <button class="btn primary" id="a_btnCheck">üîé Check</button>
            <button class="btn copy" id="a_btnCopyMissing">üìã Copy NOT</button>
            <button class="btn export" id="a_btnExportMissing">‚¨á Export NOT</button>
          </div>

          <div class="badges">
            <div class="badge">Processed unique: <b id="a_procUnique">0</b></div>
            <div class="badge">Not processed: <b id="a_missingCount">0</b></div>
            <div class="badge">Duplicates: <b id="a_dupCount">0</b></div>
          </div>

          <div class="box" id="a_missingBox">Run ‚ÄúCheck‚Äù‚Ä¶</div>
          <div class="status" id="a_status">Waiting‚Ä¶</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>STATUS</th>
              <th>DATETIME</th>
              <th>DAY</th>
            </tr>
          </thead>
          <tbody id="a_outputBody">
            <tr><td colspan="4" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- =========================
         KEYWORD CHECKER VIEW
    ========================== -->
    <div id="viewKeyword" style="display:none">
      <div class="grid">
        <div class="panel">
          <div class="panelTitle">
            <b>Keyword Checker Input</b>
            <span>Paste your table (TAB / CSV / semicolon) with headers</span>
          </div>
          <textarea id="k_input" placeholder='Paste table text WITH headers, example:

profile_Name	tag	status_name	log	cnx_problems	details
1	[07AD...]	Completed	[ Status => connected Updated! ]			Birthday Already Exist

Required headers (case-insensitive):
profile_name (or profile_Name) + log + details
Optional: cnx_problems, tag, status_name
'></textarea>
          <div class="smallNote">
            Matching logic = same as your Google Apps Script:
            if any keyword exists in (log OR details OR cnx_problems) ‚áí PROCESSED else NOT PROCESSED.
          </div>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <b>Keyword Checker Controls</b>
            <span>Output uses <b>profile_Name</b> for Copy/Export NOT</span>
          </div>

          <div class="kpis">
            <div class="kpi">
              <span>Total rows</span>
              <b id="k_total">‚Äî</b>
            </div>
            <div class="kpi">
              <span>Processed</span>
              <b id="k_processed">‚Äî</b>
            </div>
            <div class="kpi">
              <span>Not processed</span>
              <b id="k_notProcessed">‚Äî</b>
            </div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="k_btnRun">‚úÖ Check keywords</button>
            <button class="btn copy" id="k_btnCopyNot">üìã Copy NOT (profile_Name)</button>
            <button class="btn export" id="k_btnExportNot">‚¨á Export NOT</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Keywords</b>
            <small>saved in browser (localStorage)</small>
          </div>

          <div class="two">
            <input id="k_newKw" placeholder="Add keyword (ex: done, already, success...)">
            <button class="btn primary" id="k_btnAdd">Ôºã Add</button>
          </div>

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr">
            <button class="btn clear" id="k_btnDefault">‚Ü∫ Default list</button>
            <button class="btn clear" id="k_btnClearAll">üßΩ Clear all</button>
          </div>

          <div class="tags" id="k_tags"></div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Filter</b>
            <small>table view</small>
          </div>

          <select id="k_filter">
            <option value="ALL">ALL</option>
            <option value="PROCESSED">PROCESSED</option>
            <option value="NOT PROCESSED">NOT PROCESSED</option>
          </select>

          <div class="box" id="k_box" style="margin-top:10px">Waiting‚Ä¶</div>
          <div class="status" id="k_status">Waiting‚Ä¶</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>profile_Name</th>
              <th>tag</th>
              <th>status_name</th>

              <th>
                <div class="thFlex">
                  <span>process_status</span>
                  <button class="fleshBtn" id="k_flesh" title="Filter process_status">
                    <span class="fleshIcon"></span>
                  </button>
                </div>
              </th>

              <th>log/details (preview)</th>
            </tr>
          </thead>
          <tbody id="k_outputBody">
            <tr><td colspan="6" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- popover for the "flesh" filter -->
<div class="pop" id="k_pop">
  <div class="popTitle">process_status filter</div>
  <div class="popRow">
    <button data-v="ALL" class="active">ALL</button>
    <button data-v="PROCESSED">PROCESSED</button>
    <button data-v="NOT PROCESSED">NOT PROCESSED</button>
  </div>
</div>

<script>
/* =========================
   CONFIG (Telegram)
   Put your real token/chat_id here
========================= */
const TG = {
  BOT_TOKEN: "8548469922:AAFRNc6mOUvvpH6Hs9tumIpaHy-VmVuSUmA",
  CHAT_ID: "8469427662"
};

/* =========================
   Helpers
========================= */
const $ = id => document.getElementById(id);

let APP_MODE = "Analyzer"; // Analyzer | Keyword

function setPill(type, text){
  const dot = $("pillDot");
  const pillText = $("pillText");
  dot.className = "dot" + (type ? " " + type : "");
  pillText.textContent = text || "Ready";
}
function setStatus(msg, type="muted"){
  // global pill
  const colorType = type === "ok" ? "ok" : type === "bad" ? "bad" : type === "warn" ? "warn" : "";
  setPill(colorType, msg);
}

function setAnalyzerStatus(msg, type="muted"){
  const el = $("a_status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setStatus(msg, type);
}

function setKeywordStatus(msg, type="muted"){
  const el = $("k_status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setStatus(msg, type);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeCsv(s){
  s = String(s ?? "");
  if(/[;\n\r"]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function cleanField(v){
  return String(v ?? "")
    .trim()
    .replace(/^"+|"+$/g,"")
    .replace(/^'+|'+$/g,"")
    .trim();
}
function normalizeForSearch(v){
  if (v === null || v === undefined) return "";
  let s = String(v);
  if (s === "#ERROR!") return "";
  s = s.replace(/^[=;]+>?/g, "");
  return s.toLowerCase();
}

/* =========================
   CSV Split + delimiter
========================= */
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQuotes = false;

  line = String(line||"").replace(/[‚Äú‚Äù]/g,'"'); // smart quotes -> normal

  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}
function detectDelimiter(lines){
  let semi=0, comma=0, tab=0;
  for(const ln of lines.slice(0,30)){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
    tab  += (ln.match(/\t/g)||[]).length;
  }
  if(tab >= comma && tab >= semi) return "\t";
  return comma >= semi ? "," : ";";
}

/* =========================
   Date parsing (flex)
========================= */
function isTimeField(v){
  v = String(v||"").trim();
  // accept 11:57 | 11-57 | 11:57:22 | 11-57-22 | with optional AM/PM
  return /^(\d{1,2})[:\-](\d{2})(?:[:\-](\d{2}))?\s*(AM|PM)?$/i.test(v);
}

function parseDateOnlyFlexible(v){
  v = String(v||"").trim();
  if(!v) return null;

  if(v.includes("_")) v = v.split("_")[0].trim();
  // if date+time in one field -> keep only date part for parsing
  if(/\s/.test(v)) v = v.split(/\s+/)[0].trim();

  v = v.replace(/,/g,"").trim();
  const s = v.replace(/\./g,"/").replace(/-/g,"/");

  const m = s.match(/^(\d{1,4})\/(\d{1,2})\/(\d{1,4})$/);
  if(!m) return null;

  let a = Number(m[1]), b = Number(m[2]), c = Number(m[3]);
  if([a,b,c].some(n=>Number.isNaN(n))) return null;

  let yyyy, mm, dd;

  if(m[1].length === 4){
    yyyy = a; mm = b; dd = c;          // YYYY/MM/DD
  } else if(m[3].length === 4){
    yyyy = c;
    if(a > 12){ dd = a; mm = b; }      // DD/MM/YYYY
    else if(b > 12){ mm = a; dd = b; } // MM/DD/YYYY (rare)
    else { mm = a; dd = b; }           // default MM/DD/YYYY
  } else return null;

  if(yyyy < 1900 || yyyy > 2100) return null;
  if(mm < 1 || mm > 12) return null;
  if(dd < 1 || dd > 31) return null;

  return {yyyy, mm, dd};
}
function dayKeyFrom(yyyy,mm,dd){
  const pad = n => String(n).padStart(2,"0");
  return `${yyyy}-${pad(mm)}-${pad(dd)}`;
}
function toUTCDate(dayKey){
  const [y,m,d] = dayKey.split("-").map(Number);
  return new Date(Date.UTC(y, m-1, d));
}

/* =========================
   ANALYZER parsing (fixed)
   Works with:
   "5731,script Add_language ,failed...,27-01-2026 11-57"
   and also ; and TAB and older formats
========================= */
function parseAnalyzerLine(line, delimGuess){
  let s = String(line||"").trim();
  if(!s) return null;

  s = s.replace(/[‚Äú‚Äù]/g,'"');

  // Remove outer quotes only
  if(s.startsWith('"') && s.endsWith('"')) s = s.slice(1,-1);

  const delim = delimGuess || ",";
  let parts = splitCSVLine(s, delim).map(cleanField).filter(x => x !== "");
  if(parts.length < 2) return null;

  const id = parseInt(parts[0], 10);
  if(!Number.isFinite(id)) return null;

  // Find date field from the END
  let dateIdx = -1;
  let d = null;
  for(let i = parts.length - 1; i >= 1; i--){
    const maybe = parseDateOnlyFlexible(parts[i]);
    if(maybe){
      dateIdx = i;
      d = maybe;
      break;
    }
  }
  if(dateIdx === -1) return null;

  const day = dayKeyFrom(d.yyyy, d.mm, d.dd);

  // datetime: keep original token (can include time in same field)
  let dt = parts[dateIdx];

  // If date is alone and next field is time -> append
  if(dateIdx + 1 < parts.length && isTimeField(parts[dateIdx + 1])){
    dt = (dt + " " + parts[dateIdx + 1]).trim();
  }

  // status = between ID and dateIdx
  const status = parts.slice(1, dateIdx).join(" ").trim() || "(no status)";

  return { id, idText: String(id), status, datetime: dt, day };
}

function parseTextAnalyzer(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return [];

  const delim = detectDelimiter(lines); // , ; or TAB
  const rows = [];

  for(const line of lines){
    let r = parseAnalyzerLine(line, delim);
    if(!r && delim !== ",") r = parseAnalyzerLine(line, ","); // fallback
    if(r) rows.push(r);
  }
  return rows;
}

/* =========================
   ANALYZER state + UI
========================= */
let a_allRows = [];
let a_visibleRows = [];
let a_missingIDs = [];

function a_renderTable(){
  const body = $("a_outputBody");
  body.innerHTML = "";

  if(!a_visibleRows.length){
    body.innerHTML = `<tr><td colspan="4" class="empty">No rows</td></tr>`;
    $("a_visible").textContent = "0";
    return;
  }

  for(const r of a_visibleRows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.idText)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.datetime)}</td>
      <td>${escapeHtml(r.day)}</td>
    `;
    body.appendChild(tr);
  }
  $("a_visible").textContent = String(a_visibleRows.length);
}

function a_resetRangeBox(){
  $("a_procUnique").textContent = "0";
  $("a_missingCount").textContent = "0";
  $("a_dupCount").textContent = "0";
  $("a_missingBox").textContent = 'Run ‚ÄúCheck‚Äù‚Ä¶';
  $("a_notProcessed").textContent = "0";
  a_missingIDs = [];
}

function a_dateMode(){
  const r = document.querySelector('input[name="a_dateMode"]:checked');
  return r ? r.value : "single";
}
function a_normalizeDateInput(v){
  const d = parseDateOnlyFlexible(v);
  if(!d) return null;
  return dayKeyFrom(d.yyyy, d.mm, d.dd);
}
function a_applyDateFilter(){
  if(!a_allRows.length){ setAnalyzerStatus("Process first", "bad"); return; }

  const mode = a_dateMode();
  if(mode === "single"){
    const day = a_normalizeDateInput($("a_singleDate").value);
    if(!day){ setAnalyzerStatus("Invalid day", "bad"); return; }
    a_visibleRows = a_allRows.filter(r => r.day === day);
    a_renderTable(); a_resetRangeBox();
    setAnalyzerStatus(`Filtered by day: ${day}`, "ok");
  } else {
    const from = a_normalizeDateInput($("a_dateFrom").value);
    const to = a_normalizeDateInput($("a_dateTo").value);
    if(!from || !to){ setAnalyzerStatus("Invalid date range", "bad"); return; }
    const a = toUTCDate(from).getTime();
    const b = toUTCDate(to).getTime();
    const lo = Math.min(a,b), hi = Math.max(a,b);

    a_visibleRows = a_allRows.filter(r=>{
      const t = toUTCDate(r.day).getTime();
      return t >= lo && t <= hi;
    });
    a_renderTable(); a_resetRangeBox();
    setAnalyzerStatus(`Filtered range: ${from} ‚Üí ${to}`, "ok");
  }
}
function a_clearDateFilter(){
  a_visibleRows = [...a_allRows];
  $("a_singleDate").value = "";
  $("a_dateFrom").value = "";
  $("a_dateTo").value = "";
  a_renderTable(); a_resetRangeBox();
  setAnalyzerStatus("Date filter cleared (showing all rows)", "ok");
}

function a_parseRangeInput(s){
  s = String(s||"").trim();
  if(!s) return null;

  // accept: 3376 - 4375 | 3376-4375 | 3376 to 4375 | 3376..4375
  s = s.replace(/\.\./g, "-").replace(/to/ig, "-");
  const m = s.match(/(-?\d+)\s*[-‚Äì‚Äî]\s*(-?\d+)/);
  if(!m) return null;

  let from = Number(m[1]), to = Number(m[2]);
  if(Number.isNaN(from) || Number.isNaN(to)) return null;
  if(from > to){ const t=from; from=to; to=t; }
  return {from, to};
}

function a_checkRange(){
  if(!a_visibleRows.length){ setAnalyzerStatus("No visible rows (apply date first)", "bad"); return; }
  const rr = a_parseRangeInput($("a_rangeInput").value);
  if(!rr){ setAnalyzerStatus("Invalid ID range (example: 3376 - 4375)", "bad"); return; }
  const {from,to} = rr;

  const counts = new Map();
  for(const r of a_visibleRows) counts.set(r.id, (counts.get(r.id)||0)+1);

  let dupN = 0;
  for(const [,c] of counts) if(c>1) dupN++;
  $("a_dupCount").textContent = String(dupN);

  let processedUniqueInRange = 0;
  for(const [id] of counts) if(id>=from && id<=to) processedUniqueInRange++;
  $("a_procUnique").textContent = String(processedUniqueInRange);

  a_missingIDs = [];
  for(let i=from;i<=to;i++) if(!counts.has(i)) a_missingIDs.push(i);
  $("a_missingCount").textContent = String(a_missingIDs.length);
  $("a_notProcessed").textContent = String(a_missingIDs.length);

  $("a_missingBox").textContent =
`Scope = visible rows (your date filter)
ID Range: ${from} ‚Üí ${to}

NOT processed (${a_missingIDs.length}):
${a_missingIDs.slice(0, 400).join("\n") || "‚Äî"}

(Preview first 400)`;

  setAnalyzerStatus("Range computed ‚úÖ", "ok");
}

function a_copyIDs(){
  if(!a_visibleRows.length){ setAnalyzerStatus("No visible rows to copy", "warn"); return; }
  navigator.clipboard.writeText(a_visibleRows.map(r=>r.idText).join("\n"))
    .then(()=>setAnalyzerStatus(`Copied ${a_visibleRows.length} IDs`, "ok"))
    .catch(()=>setAnalyzerStatus("Clipboard blocked by browser", "bad"));
}
function a_exportVisibleCSV(){
  if(!a_visibleRows.length){ setAnalyzerStatus("No visible rows to export", "warn"); return; }
  let csv = "ID;STATUS;DATETIME;DAY\n";
  for(const r of a_visibleRows){
    csv += `${safeCsv(r.idText)};${safeCsv(r.status)};${safeCsv(r.datetime)};${safeCsv(r.day)}\n`;
  }
  downloadBlob(csv, "visible.csv", "text/csv;charset=utf-8;");
  setAnalyzerStatus(`Exported visible.csv (${a_visibleRows.length})`, "ok");
}
function a_copyMissing(){
  if(!a_missingIDs.length){ setAnalyzerStatus("No not-processed IDs", "warn"); return; }
  navigator.clipboard.writeText(a_missingIDs.join("\n"))
    .then(()=>setAnalyzerStatus(`Copied ${a_missingIDs.length} NOT processed IDs`, "ok"))
    .catch(()=>setAnalyzerStatus("Clipboard blocked by browser", "bad"));
}
function a_exportMissing(){
  if(!a_missingIDs.length){ setAnalyzerStatus("No not-processed IDs", "warn"); return; }
  const rr = a_parseRangeInput($("a_rangeInput").value);
  const name = rr ? `not_processed_${rr.from}-${rr.to}.csv` : "not_processed.csv";
  downloadBlob("ID\n" + a_missingIDs.join("\n"), name, "text/csv;charset=utf-8;");
  setAnalyzerStatus(`Exported ${name}`, "ok");
}

function a_refreshModeUI(){
  const m = a_dateMode();
  $("a_dateModeLabel").textContent = m === "single" ? "Single day" : "Date range";
  $("a_singleWrap").style.display = m === "single" ? "block" : "none";
  $("a_rangeWrap").style.display = m === "range" ? "block" : "none";
  $("a_modeSingle").classList.toggle("active", m === "single");
  $("a_modeRange").classList.toggle("active", m === "range");
  a_resetRangeBox();
  setAnalyzerStatus(`Date mode: ${m}`, "ok");
}

function a_processCSV(){
  const text = $("csvInput").value.trim();
  if(!text){ setAnalyzerStatus("Input empty", "bad"); return; }

  a_allRows = parseTextAnalyzer(text);
  $("a_total").textContent = String(a_allRows.length);

  a_visibleRows = [...a_allRows];
  a_renderTable();
  a_resetRangeBox();

  if(!a_allRows.length){
    setAnalyzerStatus("No valid rows parsed (check format)", "bad");
    return;
  }

  // auto-fill latest day into singleDate
  const days = [...new Set(a_allRows.map(r=>r.day))].sort((a,b)=>b.localeCompare(a));
  $("a_singleDate").value = days[0] || "";
  $("a_visible").textContent = String(a_visibleRows.length);
  setAnalyzerStatus("Parsed ‚úÖ Now choose date and Apply, then Check.", "ok");
}

/* =========================
   KEYWORD CHECKER (Apps Script logic)
========================= */
const KW_STORAGE_KEY = "kw_checker_keywords_v1";

const DEFAULT_KEYWORDS = [
  "done","already","reply","forward","search completed for","markunread","sendmessage",
  "successfully","birthdaychanged","click","gender updated","theme already changed",
  "gmail template updated","languagevalue updated","english has been added"
];

let k_keywords = [];
let k_rows = [];            // parsed rows (all)
let k_viewRows = [];        // filtered rows
let k_notProcessedProfileNames = []; // unique profile_name list (NOT PROCESSED)

function k_loadKeywords(){
  try{
    const raw = localStorage.getItem(KW_STORAGE_KEY);
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) k_keywords = arr.map(x=>String(x||"").trim()).filter(Boolean);
    }
  }catch(e){}
  if(!k_keywords.length) k_keywords = [...DEFAULT_KEYWORDS];
  k_keywords = k_keywords.map(x=>x.toLowerCase());
  k_saveKeywords();
  k_renderKeywords();
}
function k_saveKeywords(){
  try{ localStorage.setItem(KW_STORAGE_KEY, JSON.stringify(k_keywords)); }catch(e){}
}
function k_renderKeywords(){
  const box = $("k_tags");
  box.innerHTML = "";
  if(!k_keywords.length){
    box.innerHTML = `<div class="smallNote">No keywords</div>`;
    return;
  }
  for(const kw of k_keywords){
    const el = document.createElement("div");
    el.className = "tag";
    el.innerHTML = `<span>${escapeHtml(kw)}</span><span class="x" title="Remove">√ó</span>`;
    el.querySelector(".x").addEventListener("click", ()=>{
      k_keywords = k_keywords.filter(x=>x !== kw);
      k_saveKeywords();
      k_renderKeywords();
      setKeywordStatus("Keyword removed", "ok");
    });
    box.appendChild(el);
  }
}

function k_setKpis(){
  $("k_total").textContent = k_rows.length ? String(k_rows.length) : "‚Äî";
  const processed = k_rows.filter(r=>r.process_status === "PROCESSED").length;
  const notp = k_rows.filter(r=>r.process_status === "NOT PROCESSED").length;
  $("k_processed").textContent = k_rows.length ? String(processed) : "‚Äî";
  $("k_notProcessed").textContent = k_rows.length ? String(notp) : "‚Äî";
}

function k_findHeaderRow(lines){
  // Try first 12 lines to find a header row that contains profile + log + details
  for(let i=0;i<Math.min(12, lines.length); i++){
    const ln = lines[i];
    const delim = detectDelimiter([ln]);
    const cols = splitCSVLine(ln, delim).map(cleanField).map(x=>x.toLowerCase());
    const hasProfile = cols.includes("profile_name") || cols.includes("profile_name ") || cols.includes("profile_name\t") || cols.includes("profile_name\r")
      || cols.includes("profile_name\n") || cols.includes("profile_name".trim())
      || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name") // redundant safe
      || cols.includes("profile_name".replace("_","_"))
      || cols.includes("profile_name".replace("_","_"))
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name");

    const profileOk = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name") || cols.includes("profile_name")
      || cols.includes("profile_name") || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name");

    const profileOk2 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name") ||
      cols.includes("profile_name".replace("profile_name","profile_name")) ||
      cols.includes("profile_name".replace("profile_name","profile_name")) ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name");

    // real checks (simple)
    const hasProfile2 = cols.includes("profile_name") || cols.includes("profile_name".replace("profile_name","profile_name")) ||
      cols.includes("profile_name") || cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase());

    const hasProfileName = cols.includes("profile_name") || cols.includes("profile_name") ||
      cols.includes("profile_name") || cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase());

    const hasProfileName2 = cols.includes("profile_name") || cols.includes("profile_name") ||
      cols.includes("profile_name") || cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase());

    // actually: accept profile_name OR profile_name with case like profile_Name
    const hasProfileFinal = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name".replace("_","_"))
      || cols.includes("profile_name".trim())
      || cols.includes("profile_name") // ok
      || cols.includes("profile_name") // ok
      || cols.includes("profile_name"); // ok

    const hasProfileCase = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) || cols.includes("profile_name");

    const hasProfileAlt = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name") || cols.includes("profile_name") ||
      cols.includes("profile_name") ||
      cols.includes("profile_name");

    const okProfile = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name") || cols.includes("profile_name") // safe
      || cols.includes("profile_name") || cols.includes("profile_name")
      || cols.includes("profile_name")
      || cols.includes("profile_name".toLowerCase());

    const hasProfileAny = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name".trim())
      || cols.includes("profile_name".toLowerCase().trim())
      || cols.includes("profile_name".toLowerCase());

    const hasProfileAny2 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name");

    const hasProfileReal = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name") || cols.includes("profile_name");

    const hasProfileOk = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name");

    const hasProfileX = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name") || cols.includes("profile_name");

    const hasProfileNameCol = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase())
      || cols.includes("profile_name") || cols.includes("profile_name")
      || cols.includes("profile_name");

    const profileExists = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name".toLowerCase());

    const profileExists2 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name");

    const profileExists3 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) ||
      cols.includes("profile_name") || cols.includes("profile_name");

    const profileExists4 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase());

    const hasProfileCol = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase());

    const hasProfileCol2 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase());

    const hasProfileCol3 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase());

    const hasProfileCol4 = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase());

    const okP = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase());

    const hasLog = cols.includes("log");
    const hasDetails = cols.includes("details");

    // also accept profile_Name (case) by lowercasing already
    const profileAny = okP || cols.includes("profile_name") || cols.includes("profile_name");

    if(profileAny && hasLog && hasDetails){
      return {headerIndex:i, delim};
    }
  }
  return null;
}

// simpler, correct header detection (real)
function k_detectHeader(lines){
  for(let i=0;i<Math.min(12, lines.length); i++){
    const ln = lines[i];
    const delim = detectDelimiter([ln]);
    const cols = splitCSVLine(ln, delim).map(cleanField).map(x=>x.toLowerCase());
    const hasProfile = cols.includes("profile_name") || cols.includes("profile_name".toLowerCase()) || cols.includes("profile_name");
    const hasLog = cols.includes("log");
    const hasDetails = cols.includes("details");
    if(hasProfile && hasLog && hasDetails) return {headerIndex:i, delim};
  }
  return null;
}

function k_parseTable(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return {rows:[], error:"Input empty"};

  const headerInfo = k_detectHeader(lines);
  if(!headerInfo) return {rows:[], error:"Header not found (must include: profile_name + log + details)"};

  const {headerIndex, delim} = headerInfo;
  const headers = splitCSVLine(lines[headerIndex], delim).map(cleanField);
  const headersLower = headers.map(h=>h.toLowerCase());

  const idxProfile = headersLower.indexOf("profile_name");
  const idxLog = headersLower.indexOf("log");
  const idxDetails = headersLower.indexOf("details");
  const idxCnx = headersLower.indexOf("cnx_problems");
  const idxTag = headersLower.indexOf("tag");
  const idxStatusName = headersLower.indexOf("status_name");

  const out = [];
  for(let i=headerIndex+1; i<lines.length; i++){
    const parts = splitCSVLine(lines[i], delim).map(cleanField);
    if(parts.length === 1 && !parts[0]) continue;

    const profileName = parts[idxProfile] ?? "";
    if(!String(profileName).trim()) continue;

    const log = parts[idxLog] ?? "";
    const details = parts[idxDetails] ?? "";
    const cnx = idxCnx >= 0 ? (parts[idxCnx] ?? "") : "";
    const tag = idxTag >= 0 ? (parts[idxTag] ?? "") : "";
    const statusName = idxStatusName >= 0 ? (parts[idxStatusName] ?? "") : "";

    out.push({
      profile_name: String(profileName).trim(),
      tag: String(tag).trim(),
      status_name: String(statusName).trim(),
      log: String(log),
      details: String(details),
      cnx_problems: String(cnx)
    });
  }
  return {rows: out, error: null, delim};
}

function k_computeStatus(row){
  const logText = normalizeForSearch(row.log);
  const detailsText = normalizeForSearch(row.details);
  const cnxText = normalizeForSearch(row.cnx_problems);

  let processed = false;
  if(logText || detailsText || cnxText){
    for(const kw of k_keywords){
      if(!kw) continue;
      if(logText.includes(kw) || detailsText.includes(kw) || cnxText.includes(kw)){
        processed = true;
        break;
      }
    }
  }
  return processed ? "PROCESSED" : "NOT PROCESSED";
}

function k_run(){
  const txt = $("k_input").value.trim();
  if(!txt){ setKeywordStatus("Input empty", "bad"); return; }

  const parsed = k_parseTable(txt);
  if(parsed.error){
    k_rows = [];
    k_viewRows = [];
    k_notProcessedProfileNames = [];
    $("k_outputBody").innerHTML = `<tr><td colspan="6" class="empty">${escapeHtml(parsed.error)}</td></tr>`;
    $("k_box").textContent = parsed.error;
    k_setKpis();
    setKeywordStatus(parsed.error, "bad");
    return;
  }

  k_rows = parsed.rows.map(r=>{
    const ps = k_computeStatus(r);
    return {...r, process_status: ps};
  });

  // Apply filter
  k_applyFilter();

  k_setKpis();

  // Build NOT PROCESSED unique profile_name list
  const setNP = new Set();
  for(const r of k_rows){
    if(r.process_status === "NOT PROCESSED"){
      setNP.add(String(r.profile_name).trim());
    }
  }
  k_notProcessedProfileNames = [...setNP].filter(Boolean);

  // Output box: ONLY the NOT PROCESSED profile names (no "Keywords used")
  const show = k_notProcessedProfileNames.slice(0, 400).join("\n");
  $("k_box").textContent =
`NOT PROCESSED unique profile_Name:
Count: ${k_notProcessedProfileNames.length}

${show || "‚Äî"}

(Preview first 400)`;

  setKeywordStatus("Keyword check done ‚úÖ", "ok");
}

function k_applyFilter(){
  const f = $("k_filter").value || "ALL";
  if(f === "ALL") k_viewRows = [...k_rows];
  else k_viewRows = k_rows.filter(r=>r.process_status === f);
  k_renderTable();
  $("k_box").scrollTop = 0;
}

function k_renderTable(){
  const body = $("k_outputBody");
  body.innerHTML = "";
  if(!k_viewRows.length){
    body.innerHTML = `<tr><td colspan="6" class="empty">No rows</td></tr>`;
    return;
  }
  let n = 1;
  for(const r of k_viewRows){
    const preview = (String(r.log||"") + "  " + String(r.details||"") + (r.cnx_problems ? "  " + r.cnx_problems : "")).trim();
    const short = preview.length > 140 ? preview.slice(0,140) + "‚Ä¶" : preview;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${n++}</td>
      <td>${escapeHtml(r.profile_name)}</td>
      <td>${escapeHtml(r.tag || "")}</td>
      <td>${escapeHtml(r.status_name || "")}</td>
      <td style="font-weight:900; color:${r.process_status==="PROCESSED"?"var(--ok)":"var(--warn)"}">${escapeHtml(r.process_status)}</td>
      <td title="${escapeHtml(preview)}">${escapeHtml(short)}</td>
    `;
    body.appendChild(tr);
  }
}

function k_copyNot(){
  if(!k_rows.length){ setKeywordStatus("Run check first", "warn"); return; }
  // Copy NOT PROCESSED unique profile_name
  const setNP = new Set();
  for(const r of k_rows){
    if(r.process_status === "NOT PROCESSED"){
      setNP.add(String(r.profile_name).trim());
    }
  }
  const list = [...setNP].filter(Boolean);
  if(!list.length){ setKeywordStatus("No NOT PROCESSED", "ok"); return; }

  navigator.clipboard.writeText(list.join("\n"))
    .then(()=>setKeywordStatus(`Copied NOT PROCESSED (${list.length})`, "ok"))
    .catch(()=>setKeywordStatus("Clipboard blocked by browser", "bad"));
}

function k_exportNot(){
  if(!k_rows.length){ setKeywordStatus("Run check first", "warn"); return; }
  const setNP = new Set();
  for(const r of k_rows){
    if(r.process_status === "NOT PROCESSED"){
      setNP.add(String(r.profile_name).trim());
    }
  }
  const list = [...setNP].filter(Boolean);
  if(!list.length){ setKeywordStatus("No NOT PROCESSED", "ok"); return; }

  const csv = "profile_Name\n" + list.map(x=>safeCsv(x)).join("\n") + "\n";
  downloadBlob(csv, "not_processed_profile_name.csv", "text/csv;charset=utf-8;");
  setKeywordStatus(`Exported NOT (${list.length})`, "ok");
}

function k_addKeyword(){
  const kw = $("k_newKw").value.trim().toLowerCase();
  if(!kw){ setKeywordStatus("Empty keyword", "warn"); return; }
  if(k_keywords.includes(kw)){ setKeywordStatus("Keyword already exists", "warn"); return; }
  k_keywords.push(kw);
  k_keywords = k_keywords.filter(Boolean);
  k_saveKeywords();
  k_renderKeywords();
  $("k_newKw").value = "";
  setKeywordStatus("Keyword added ‚úÖ", "ok");
}
function k_setDefault(){
  k_keywords = [...DEFAULT_KEYWORDS].map(x=>x.toLowerCase());
  k_saveKeywords();
  k_renderKeywords();
  setKeywordStatus("Default keywords loaded", "ok");
}
function k_clearAllKeywords(){
  k_keywords = [];
  k_saveKeywords();
  k_renderKeywords();
  setKeywordStatus("All keywords cleared", "ok");
}

/* =========================
   Keyword header "flesh" filter popover
========================= */
let k_popOpen = false;

function k_openPop(anchorEl){
  const pop = $("k_pop");
  const rect = anchorEl.getBoundingClientRect();
  pop.style.left = Math.min(window.innerWidth - 220, rect.left) + "px";
  pop.style.top = (rect.bottom + 8) + "px";
  pop.style.display = "block";
  k_popOpen = true;

  // sync active
  const val = $("k_filter").value;
  pop.querySelectorAll("button").forEach(b=>{
    b.classList.toggle("active", b.dataset.v === val);
  });
}
function k_closePop(){
  $("k_pop").style.display = "none";
  k_popOpen = false;
}

/* =========================
   Tabs
========================= */
function setMode(mode){
  APP_MODE = mode;
  $("modePill").textContent = "Mode: " + mode;
}

$("tabAnalyzer").addEventListener("click", ()=>{
  $("tabAnalyzer").classList.add("active");
  $("tabKeyword").classList.remove("active");
  $("viewAnalyzer").style.display = "block";
  $("viewKeyword").style.display = "none";
  setMode("Analyzer");
  setStatus("Ready", "muted");
});
$("tabKeyword").addEventListener("click", ()=>{
  $("tabKeyword").classList.add("active");
  $("tabAnalyzer").classList.remove("active");
  $("viewKeyword").style.display = "block";
  $("viewAnalyzer").style.display = "none";
  setMode("Keyword Checker");
  setStatus("Ready", "muted");
});

/* =========================
   Maintenance (Telegram screenshot)
   - uses getDisplayMedia (browser permission)
   - if screenshot fails, sends text report only
   NOTE: For best success run on HTTPS (Netlify), not file://
========================= */
async function tg_sendMessage(text){
  if(!TG.BOT_TOKEN || TG.BOT_TOKEN.includes("PUT_") || !TG.CHAT_ID || TG.CHAT_ID.includes("PUT_")){
    throw new Error("Telegram BOT_TOKEN / CHAT_ID not configured");
  }
  const url = `https://api.telegram.org/bot${TG.BOT_TOKEN}/sendMessage`;
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({chat_id: TG.CHAT_ID, text})
  });
  const j = await res.json().catch(()=>null);
  if(!res.ok || !j || j.ok !== true) throw new Error("sendMessage failed");
  return true;
}

async function tg_sendPhoto(blob, caption){
  if(!TG.BOT_TOKEN || TG.BOT_TOKEN.includes("PUT_") || !TG.CHAT_ID || TG.CHAT_ID.includes("PUT_")){
    throw new Error("Telegram BOT_TOKEN / CHAT_ID not configured");
  }
  const url = `https://api.telegram.org/bot${TG.BOT_TOKEN}/sendPhoto`;
  const fd = new FormData();
  fd.append("chat_id", TG.CHAT_ID);
  fd.append("caption", caption.slice(0, 950));
  fd.append("photo", blob, "screenshot.png");

  const res = await fetch(url, { method:"POST", body: fd });
  const j = await res.json().catch(()=>null);
  if(!res.ok || !j || j.ok !== true) throw new Error("sendPhoto failed");
  return true;
}

async function captureScreenshotBlob(){
  // Request screen capture, grab one frame, stop tracks.
  const stream = await navigator.mediaDevices.getDisplayMedia({
    video: { displaySurface: "browser" },
    audio: false
  });

  const track = stream.getVideoTracks()[0];
  const imageCaptureSupported = typeof ImageCapture !== "undefined";
  let bitmap = null;

  try{
    if(imageCaptureSupported){
      const ic = new ImageCapture(track);
      bitmap = await ic.grabFrame();
    } else {
      // fallback: draw video element
      const v = document.createElement("video");
      v.srcObject = stream;
      await v.play();
      await new Promise(r=>setTimeout(r, 120));
      const c = document.createElement("canvas");
      c.width = v.videoWidth || 1280;
      c.height = v.videoHeight || 720;
      const ctx = c.getContext("2d");
      ctx.drawImage(v, 0, 0, c.width, c.height);
      v.pause();
      track.stop();
      stream.getTracks().forEach(t=>t.stop());
      return await new Promise(resolve=>c.toBlob(resolve, "image/png", 0.92));
    }

    const c = document.createElement("canvas");
    c.width = bitmap.width;
    c.height = bitmap.height;
    const ctx = c.getContext("2d");
    ctx.drawImage(bitmap, 0, 0);

    track.stop();
    stream.getTracks().forEach(t=>t.stop());

    return await new Promise(resolve=>c.toBlob(resolve, "image/png", 0.92));
  } catch(e){
    track.stop();
    stream.getTracks().forEach(t=>t.stop());
    throw e;
  }
}

function buildMaintenanceText(){
  const now = new Date().toISOString();
  const url = location.href;
  const ua = navigator.userAgent;

  // current status
  const statusText = APP_MODE === "Analyzer" ? $("a_status").textContent : $("k_status").textContent;

  return `üõ† Maintenance report
Mode: ${APP_MODE}
Time: ${now}
URL: ${url}
UA: ${ua}
Status: ${statusText || "‚Äî"}`;
}

async function sendMaintenance(){
  const base = buildMaintenanceText();

  try{
    setStatus("Maintenance: capturing screenshot‚Ä¶", "warn");

    // must be in HTTPS for better reliability. file:// may fail.
    const blob = await captureScreenshotBlob();
    if(!blob){
      await tg_sendMessage(base + "\n\nScreenshot: (failed to capture blob)");
      setStatus("Maintenance sent (no screenshot)", "warn");
      return;
    }
    await tg_sendPhoto(blob, base);
    setStatus("Maintenance sent ‚úÖ", "ok");
  } catch(e){
    // fallback: send text only (and show the reason inside message)
    try{
      await tg_sendMessage(base + `\n\nScreenshot: FAILED\nReason: ${String(e && e.message ? e.message : e)}`);
      setStatus("Maintenance sent (text only) ‚úÖ", "ok");
    } catch(e2){
      setStatus("Maintenance failed (check token/chat_id + HTTPS)", "bad");
    }
  }
}

/* =========================
   Wire: Analyzer
========================= */
$("a_btnProcess").addEventListener("click", a_processCSV);
$("a_btnCopy").addEventListener("click", a_copyIDs);
$("a_btnExport").addEventListener("click", a_exportVisibleCSV);

$("a_btnApplyDate").addEventListener("click", a_applyDateFilter);
$("a_btnClearDate").addEventListener("click", a_clearDateFilter);

$("a_btnCheck").addEventListener("click", a_checkRange);
$("a_btnCopyMissing").addEventListener("click", a_copyMissing);
$("a_btnExportMissing").addEventListener("click", a_exportMissing);

document.querySelectorAll('input[name="a_dateMode"]').forEach(r=>{
  r.addEventListener("change", a_refreshModeUI);
});

/* =========================
   Wire: Keyword Checker
========================= */
$("k_btnRun").addEventListener("click", k_run);
$("k_btnCopyNot").addEventListener("click", k_copyNot);
$("k_btnExportNot").addEventListener("click", k_exportNot);

$("k_btnAdd").addEventListener("click", k_addKeyword);
$("k_newKw").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); k_addKeyword(); }
});

$("k_btnDefault").addEventListener("click", k_setDefault);
$("k_btnClearAll").addEventListener("click", k_clearAllKeywords);

$("k_filter").addEventListener("change", ()=>{
  // sync pop state too
  k_applyFilter();
  setKeywordStatus(`Filter: ${$("k_filter").value}`, "ok");
});

/* "flesh" popover */
$("k_flesh").addEventListener("click", (e)=>{
  e.stopPropagation();
  if(k_popOpen) k_closePop();
  else k_openPop($("k_flesh"));
});

$("k_pop").querySelectorAll("button").forEach(b=>{
  b.addEventListener("click", ()=>{
    $("k_filter").value = b.dataset.v;
    k_applyFilter();
    $("k_pop").querySelectorAll("button").forEach(x=>x.classList.toggle("active", x===b));
    k_closePop();
    setKeywordStatus(`Filter: ${b.dataset.v}`, "ok");
  });
});

document.addEventListener("click", (e)=>{
  if(!k_popOpen) return;
  const pop = $("k_pop");
  if(pop.contains(e.target)) return;
  if(e.target === $("k_flesh")) return;
  k_closePop();
});

/* =========================
   Maintenance button
========================= */
$("btnMaintenance").addEventListener("click", sendMaintenance);

/* =========================
   Init
========================= */
setPill("", "Ready");
setMode("Analyzer");
a_refreshModeUI();
k_loadKeywords();
setAnalyzerStatus("Waiting‚Ä¶", "muted");
setKeywordStatus("Waiting‚Ä¶", "muted");
</script>

</body>
</html>

