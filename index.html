<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quality Analyzer</title>

  <!-- html2canvas for Maintenance screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0a1022;
      --panel: rgba(255,255,255,0.04);
      --panel2: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.08);
      --text:#e9ecff;
      --muted:#aeb6da;
      --brand1:#6d6bff;
      --brand2:#14d9ff;
      --good:#2ee59d;
      --bad:#ff4d6d;
      --warn:#ffb020;
      --chip:#0f1833;
      --chipStroke: rgba(255,255,255,0.10);
      --shadow: 0 16px 50px rgba(0,0,0,0.55);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(109,107,255,0.35), transparent 55%),
        radial-gradient(1000px 700px at 90% 15%, rgba(20,217,255,0.22), transparent 50%),
        radial-gradient(900px 650px at 50% 95%, rgba(255,77,109,0.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{
      max-width: 1320px;
      margin: 28px auto;
      padding: 0 18px 32px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 320px;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(109,107,255,0.95), rgba(20,217,255,0.9));
      box-shadow: 0 10px 30px rgba(109,107,255,0.25);
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: 0.2px;
      font-weight: 800;
    }
    .brand .sub{
      margin-top:2px;
      color: var(--muted);
      font-size: 12.5px;
    }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      color: var(--muted);
      font-size: 12px;
      max-width: 520px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dot{
      width:9px;height:9px;border-radius:999px;background: var(--warn);
      box-shadow: 0 0 0 3px rgba(255,176,32,0.18);
      flex:0 0 auto;
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 3px rgba(46,229,157,0.16); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(255,77,109,0.14); }

    .btn{
      border:0;
      cursor:pointer;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 700;
      color: var(--text);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.075); border-color: rgba(255,255,255,0.13); }
    .btn:active{ transform: translateY(0px) scale(0.99); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(109,107,255,0.95), rgba(20,217,255,0.75));
      border-color: rgba(255,255,255,0.10);
      box-shadow: 0 12px 40px rgba(109,107,255,0.18);
    }
    .btn.danger{
      background: linear-gradient(90deg, rgba(255,77,109,0.95), rgba(255,176,32,0.55));
      border-color: rgba(255,255,255,0.10);
    }
    .btn.good{
      background: linear-gradient(90deg, rgba(46,229,157,0.95), rgba(20,217,255,0.55));
      border-color: rgba(255,255,255,0.10);
    }
    .btn.small{ padding:8px 12px; border-radius: 12px; font-size: 12.5px; }
    .btn.ghost{
      background: rgba(255,255,255,0.03);
    }

    .card{
      border-radius: var(--radius);
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap:10px;
      padding: 14px 14px 0;
    }
    .tab{
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--muted);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      transition: .12s ease;
    }
    .tab.active{
      color: var(--text);
      background: rgba(109,107,255,0.12);
      border-color: rgba(109,107,255,0.28);
      box-shadow: inset 0 0 0 1px rgba(20,217,255,0.08);
    }

    .page{
      padding: 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      align-items:start;
    }

    @media(max-width: 1050px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width:unset; }
    }

    .panel{
      border-radius: var(--radius);
      background: rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.08);
      overflow:hidden;
    }
    .panel .head{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
    }
    .panel .head h2{
      margin:0;
      font-size: 13.5px;
      letter-spacing: 0.2px;
    }
    .panel .head .hint{
      color: var(--muted);
      font-size: 12px;
    }

    textarea{
      width:100%;
      min-height: 330px;
      resize: vertical;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(109,107,255,0.20);
      outline:none;
      color: var(--text);
      font-family: var(--mono);
      font-size: 12.6px;
      line-height: 1.45;
      box-shadow: inset 0 0 0 1px rgba(20,217,255,0.04);
    }
    textarea:focus{
      border-color: rgba(20,217,255,0.35);
      box-shadow: 0 0 0 3px rgba(20,217,255,0.12);
    }

    .controls{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .kpi-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media(max-width: 560px){
      .kpi-row{ grid-template-columns: 1fr; }
    }
    .kpi{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
    }
    .kpi .label{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .kpi .value{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    .kpi .sub{
      margin-top: 6px;
      font-size: 11.5px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .btn-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media(max-width: 560px){
      .btn-row{ grid-template-columns: 1fr; }
    }

    .section{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .section-title .t{
      font-weight: 900;
      font-size: 12.5px;
      letter-spacing: 0.3px;
    }
    .section-title .r{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    .toggle-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .toggle{
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-weight: 900;
    }
    .toggle .radio{
      width: 12px;height:12px;border-radius:999px;
      border:2px solid rgba(255,255,255,0.35);
      display:inline-block;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.35);
    }
    .toggle.active{
      border-color: rgba(109,107,255,0.30);
      background: rgba(109,107,255,0.08);
    }
    .toggle.active .radio{
      border-color: rgba(20,217,255,0.9);
      box-shadow: 0 0 0 4px rgba(20,217,255,0.12);
      background: rgba(20,217,255,0.8);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .field label{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .field input, .field select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.14);
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      outline:none;
      font-family: var(--sans);
      font-weight: 700;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(20,217,255,0.30);
      box-shadow: 0 0 0 3px rgba(20,217,255,0.10);
    }
    .hint2{
      color: var(--muted);
      font-size: 11.5px;
      font-family: var(--mono);
    }

    .status-box{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .status-pills{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      max-height: 150px;
      overflow:auto;
      padding-right:4px;
    }
    .sp{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-size: 12px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .sp small{
      color: var(--muted);
      font-weight: 800;
      font-size: 11px;
    }
    .sp.active{
      border-color: rgba(109,107,255,0.35);
      background: rgba(109,107,255,0.12);
      box-shadow: inset 0 0 0 1px rgba(20,217,255,0.06);
    }

    .msg{
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.12);
      color: var(--muted);
      font-size: 12.5px;
      font-family: var(--mono);
      min-height: 40px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .msg .dot{ flex:0 0 auto; }

    /* table */
    .table-wrap{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.10);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12.8px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      color: var(--muted);
      font-weight: 900;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      background: rgba(255,255,255,0.02);
      user-select:none;
      position:relative;
      cursor:pointer;
      white-space:nowrap;
    }
    thead th .sort{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chev{
      width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;
      border-top:6px solid rgba(255,255,255,0.35);
      transform: translateY(2px);
      opacity:0.8;
    }
    .chev.up{ border-top:0; border-bottom:6px solid rgba(255,255,255,0.35); transform: translateY(-1px); }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      color: var(--text);
      vertical-align: top;
    }
    tbody tr:hover td{ background: rgba(255,255,255,0.02); }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      white-space:nowrap;
    }
    .badge.good{ border-color: rgba(46,229,157,0.22); background: rgba(46,229,157,0.10); color: #bfffe7; }
    .badge.bad{ border-color: rgba(255,77,109,0.22); background: rgba(255,77,109,0.10); color: #ffd0da; }
    .badge.warn{ border-color: rgba(255,176,32,0.22); background: rgba(255,176,32,0.10); color: #ffe4b8; }
    .mono{ font-family: var(--mono); }
    .muted{ color: var(--muted); }

    /* Keyword chips */
    .kw-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .kw-input{
      flex:1 1 260px;
      min-width: 220px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      color: var(--text);
      font-weight: 800;
      font-size: 12.3px;
    }
    .chip .x{
      width: 18px; height: 18px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,77,109,0.16);
      border: 1px solid rgba(255,77,109,0.20);
      color: #ffd0da;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      line-height:1;
      transform: translateY(-0.5px);
    }
    .chip .x:hover{ background: rgba(255,77,109,0.22); }

    /* Modal */
    .modal-back{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .modal{
      width: min(640px, 100%);
      border-radius: 18px;
      background: rgba(10,16,34,0.95);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 30px 90px rgba(0,0,0,0.70);
      overflow:hidden;
    }
    .modal .mhead{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
    }
    .modal .mhead .title{
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    .modal .mbody{
      padding: 14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .modal .mfoot{
      padding: 12px 16px 16px;
      display:flex;
      gap: 10px;
      justify-content:flex-end;
    }
    .closeX{
      cursor:pointer;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      font-weight: 900;
    }
    .closeX:hover{ background: rgba(0,0,0,0.30); }
    .mini{
      font-size: 12px;
      color: var(--muted);
      line-height:1.5;
    }

    .sessionBox{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,0.10);
      padding-top: 10px;
    }
    details{
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      background: rgba(0,0,0,0.16);
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    details summary{
      cursor:pointer;
      font-weight: 900;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .counts{
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
      font-weight: 800;
    }
	/* Make select dropdown options readable (Windows/Chrome) */
#kwFilter {
  color: #e9ecff !important;
  background: rgba(0,0,0,0.18) !important;
}

#kwFilter option {
  background: #0a1022 !important;
  color: #e9ecff !important;
}

/* Hover/selected feel (not all browsers support) */
#kwFilter option:checked {
  background: #1a2a55 !important;
  color: #e9ecff !important;
}


  </style>
</head>

<body>
  <div class="wrap" id="appRoot">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Analyzer Toolkit</h1>
          <div class="sub">Analyzer (date + status + ID range) + Keyword Checker (Apps Script logic) + Maintenance Telegram screenshot</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="globalPill">
          <span class="dot bad" id="pillDot"></span>
          <span id="pillText">No valid rows parsed (check format)</span>
        </div>
        <button class="btn small ghost" id="btnMaint">ðŸ›  Maintenance</button>
        <button class="btn small ghost" id="btnMaintSettings"></button>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" id="tabAnalyzer">Imacros</div>
        <div class="tab" id="tabKeyword">Webautomate</div>
      </div>

      <div class="page" id="pageAnalyzer">
        <div class="grid">
          <div class="panel">
            <div class="head">
              <h2>Input</h2>
              <div class="hint">Paste CSV / logs here</div>
            </div>
            <div style="padding:12px;">
              <textarea id="anInput" placeholder='"2720,birthday already exist,29-01-2026 13-13"
5731,script Add_language,failed to change language,27-01-2026 11-57
...'></textarea>
              <div class="hint2" style="margin-top:8px;">
                Supported dates: YYYY-MM-DD, DD-MM-YYYY, DD/MM/YYYY, M/D/YYYY â€” time: HH:MM or HH-MM.
                Lines wrapped in quotes like <span class="mono">"2720,...,29-01-2026 13-13"</span> are supported.
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="head">
              <h2>Controls</h2>
              <div class="hint">Classic output</div>
            </div>

            <div class="controls">
              <div class="kpi-row">
                <div class="kpi">
                  <div class="label">Total rows</div>
                  <div class="value" id="anTotal">0</div>
                </div>
                <div class="kpi">
                  <div class="label">Visible rows</div>
                  <div class="value" id="anVisible">0</div>
                </div>
                <div class="kpi">
                  <div class="label">Not processed</div>
                  <div class="value" id="anMissingCount">0</div>
                  <div class="sub">after Check</div>
                </div>
              </div>

              <div class="btn-row">
                <button class="btn primary" id="anProcess">âš¡ Process</button>
                <button class="btn" id="anCopyIds">ðŸ“‹ Copy IDs</button>
                <button class="btn" id="anExportCsv">â¬‡ Export CSV</button>
              </div>

              <div class="section">
                <div class="section-title">
                  <div class="t">Date filter</div>
                  <div class="r" id="anDateModeLabel">Single day</div>
                </div>

                <div class="toggle-row">
                  <div class="toggle active" id="anModeSingle">
                    <span class="radio"></span>
                    <span>Single day</span>
                  </div>
                  <div class="toggle" id="anModeRange">
                    <span class="radio"></span>
                    <span>Date range</span>
                  </div>
                </div>

                <div class="field" id="anSingleField">
                  <label>Day (YYYY-MM-DD or DD-MM-YYYY or M/D/YYYY)</label>
                  <input id="anDaySingle" placeholder="2026-01-20 or 20-01-2026 or 1/20/2026" />
                </div>

                <div class="field" id="anRangeFields" style="display:none;">
                  <label>From (day)</label>
                  <input id="anDayFrom" placeholder="24-01-2026" />
                  <label style="margin-top:10px;">To (day)</label>
                  <input id="anDayTo" placeholder="26-01-2026" />
                  <div class="hint2">Tip: if From > To we auto-swap</div>
                </div>

                <div class="btn-row" style="grid-template-columns: 1fr 1fr;">
                  <button class="btn primary" id="anApplyDate">âœ… Apply date</button>
                  <button class="btn" id="anClearDate">â†© Clear</button>
                </div>
              </div>

              <div class="section">
                <div class="section-title">
                  <div class="t">Status filter</div>
                  <div class="r">Multi-select</div>
                </div>

                <div class="field">
                  <label>Search status</label>
                  <input id="anStatusSearch" placeholder="type to search..." />
                </div>

                <div class="status-box">
                  <div class="hint2">If none selected â†’ all statuses</div>
                  <div class="status-pills" id="anStatusPills"></div>
                  <button class="btn small ghost" id="anClearStatus">Clear status</button>
                </div>
              </div>

              <div class="section">
                <div class="section-title">
                  <div class="t">ID range check</div>
                  <div class="r">Type: <span class="mono">3376 - 4375</span></div>
                </div>
                <div class="field">
                  <label>Range</label>
                  <input id="anRange" placeholder="1961 - 2240" value="1961 - 2240" />
                  <div class="hint2">You can type: <span class="mono">1961-2240</span> | <span class="mono">1961 - 2240</span></div>
                </div>

                <div class="btn-row" style="grid-template-columns: 1fr 1fr 1fr;">
                  <button class="btn good" id="anCheck">ðŸ”Ž Check</button>
                  <button class="btn" id="anCopyNot">ðŸ“‹ Copy NOT</button>
                  <button class="btn" id="anExportNot">â¬‡ Export NOT</button>
                </div>

                <div class="kpi-row" style="grid-template-columns: 1fr 1fr 1fr;">
                  <div class="kpi"><div class="label">Processed unique</div><div class="value" id="anUnique">0</div></div>
                  <div class="kpi"><div class="label">Not processed</div><div class="value" id="anNot">0</div></div>
                  <div class="kpi"><div class="label">Duplicates</div><div class="value" id="anDup">0</div></div>
                </div>

                <div class="msg" id="anMsg"><span class="dot bad"></span><span class="mono">No valid rows parsed (check format)</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-k="id"><span class="sort">ID <span class="chev" id="anSortId"></span></span></th>
                <th data-k="status"><span class="sort">STATUS <span class="chev" id="anSortStatus"></span></span></th>
                <th data-k="datetime"><span class="sort">DATETIME <span class="chev" id="anSortDatetime"></span></span></th>
                <th data-k="day"><span class="sort">DAY <span class="chev" id="anSortDay"></span></span></th>
              </tr>
            </thead>
            <tbody id="anTableBody">
              <tr><td colspan="4" class="muted">No rows</td></tr>
            </tbody>
          </table>
        </div>

      </div>

      <div class="page" id="pageKeyword" style="display:none;">
        <div class="grid">
          <div class="panel">
            <div class="head">
              <h2>Keyword Checker Input</h2>
              <div class="hint">Paste your table (TAB/CSV/; ) with headers</div>
            </div>
            <div style="padding:12px;">
              <textarea id="kwInput" placeholder="profile_Name	tag	status_name	log	cnx_problems	details	script_name	session_name
1	[07AD...]	Completed	[ Status => connected Updated!]			...	CMH1_IT_3(173.225.106.66)
..."></textarea>
              <div class="hint2" style="margin-top:8px;">
                Required headers (case-insensitive): <span class="mono">profile_Name</span> + <span class="mono">log</span> + <span class="mono">details</span>
                (optional: <span class="mono">cnx_problems</span>, <span class="mono">session_name</span>, <span class="mono">script_name</span>, <span class="mono">tag</span>, <span class="mono">status_name</span>)
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="head">
              <h2>Keyword Checker Controls</h2>
              <div class="hint">Same logic as Apps Script</div>
            </div>
            <div class="controls">
              <div class="kpi-row" style="grid-template-columns: 1fr 1fr;">
                <div class="kpi">
                  <div class="label">Total rows</div>
                  <div class="value" id="kwTotal">0</div>
                </div>
                <div class="kpi">
                  <div class="label" id="kwFilterLabel">NOT PROCESSED</div>
                  <div class="value" id="kwCountFiltered">0</div>
                </div>
              </div>

              <div class="btn-row" style="grid-template-columns: 1fr 1fr 1fr;">
                <button class="btn primary" id="kwProcess">âš¡ Process</button>
                <button class="btn" id="kwCopy">ðŸ“‹ Copy</button>
                <button class="btn" id="kwExport">â¬‡ Export</button>
              </div>

              <div class="section">
                <div class="section-title">
                  <div class="t">Keywords</div>
                  <div class="r">saved in browser (localStorage)</div>
                </div>

                <div class="kw-row">
                  <div class="field kw-input" style="margin:0;">
                    <label>Add keyword (ex: done, already, success...)</label>
                    <input id="kwAddInput" placeholder="type keyword then click Add" />
                  </div>
                  <button class="btn primary" id="kwAddBtn">+ Add</button>
                </div>

                <div class="btn-row" style="grid-template-columns: 1fr 1fr;">
                  <button class="btn" id="kwDefault">â†º Default list</button>
                  <button class="btn danger" id="kwClearAll">ðŸ§½ Clear all</button>
                </div>

                <div class="chips" id="kwChips"></div>
              </div>

              <div class="section">
                <div class="section-title">
                  <div class="t">Filter</div>
                  <div class="r">by result type</div>
                </div>

                <div class="field" style="margin-bottom:0;">
                  <label>Show</label>
                  <select id="kwFilter">
                    <option value="NOT_PROCESSED">NOT PROCESSED</option>
                    <option value="DISCONNECTED">DISCONNECTED</option>
                    <option value="PROCESSED">PROCESSED</option>
                    <option value="ALL">ALL</option>
                  </select>
                </div>

                <div class="hint2" style="margin-top:10px;">
                  Copy/Export uses <span class="mono">profile_Name</span> (unique). DISCONNECTED is detected from cnx_problems/log/details/status_name.
                </div>
              </div>

              <div class="msg" id="kwMsg"><span class="dot bad"></span><span class="mono">Paste table then click Process</span></div>

              <div class="sessionBox" id="kwSessionsBox" style="display:none;"></div>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-k="profile_Name"><span class="sort">profile_Name <span class="chev" id="kwSortProfile"></span></span></th>
                <th data-k="tag"><span class="sort">tag <span class="chev" id="kwSortTag"></span></span></th>
                <th data-k="status_name"><span class="sort">status_name <span class="chev" id="kwSortStatusName"></span></span></th>
                <th data-k="process_status"><span class="sort">process_status <span class="chev" id="kwSortProc"></span></span></th>
                <th data-k="session_short"><span class="sort">session <span class="chev" id="kwSortSess"></span></span></th>
                <th data-k="preview"><span class="sort">log/details (preview) <span class="chev" id="kwSortPrev"></span></span></th>
              </tr>
            </thead>
            <tbody id="kwTableBody">
              <tr><td colspan="6" class="muted">No rows</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- Telegram Settings Modal -->
  <div class="modal-back" id="tgModalBack">
    <div class="modal">
      <div class="mhead">
        <div class="title">Telegram settings</div>
        <div class="closeX" id="tgClose">âœ•</div>
      </div>
      <div class="mbody">
        <div class="mini">
          Used only for <b>Maintenance screenshot</b>. Stored locally in your browser (localStorage).
        </div>
        <div class="field">
          <label>Bot token</label>
          <input id="tgToken" placeholder="123456:AA...." />
        </div>
        <div class="field">
          <label>Chat ID</label>
          <input id="tgChat" placeholder="8469427662" />
        </div>
        <div class="mini">
          If screenshot fails: we still send the report message + error details.
        </div>
      </div>
      <div class="mfoot">
        <button class="btn" id="tgCancel">Cancel</button>
        <button class="btn primary" id="tgSave">Save</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  Helpers (shared)
 *  ========================= */
const $ = (id)=>document.getElementById(id);

function setPill(type, text){
  const dot = $("pillDot");
  const msg = $("pillText");
  dot.classList.remove("good","bad");
  if(type==="good") dot.classList.add("good");
  else if(type==="bad") dot.classList.add("bad");
  msg.textContent = text;
}

function cleanField(v){
  if(v===null || v===undefined) return "";
  let s = String(v).trim();
  // strip excel formula-like prefix to avoid broken copy
  s = s.replace(/^[=;]+>?/g, "");
  // unwrap outer quotes if field is quoted
  if((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))){
    s = s.slice(1,-1);
  }
  return s.trim();
}

function normalizeForSearch(v){
  if(v===null || v===undefined) return "";
  let s = String(v);
  if(s==="#ERROR!") return "";
  s = s.replace(/^[=;]+>?/g, "");
  return s.toLowerCase();
}

function detectDelimiter(lines){
  // prefer TAB if any tab exists in header or lines
  const sample = lines.slice(0, 6).join("\n");
  if(sample.includes("\t")) return "\t";
  // else pick between comma/semicolon by frequency
  const commas = (sample.match(/,/g)||[]).length;
  const semis  = (sample.match(/;/g)||[]).length;
  return semis > commas ? ";" : ",";
}

// CSV splitter that respects quotes
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      // toggle quotes
      inQ = !inQ;
      cur += ch;
      continue;
    }
    if(!inQ && ch === delim){
      out.push(cur);
      cur = "";
      continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}

// Parse date only in flexible formats
function parseDateOnlyFlexible(s){
  if(!s) return null;
  const t = String(s).trim();
  // YYYY-MM-DD
  let m = t.match(/\b(\d{4})-(\d{1,2})-(\d{1,2})\b/);
  if(m){
    const yyyy = +m[1], mm=+m[2], dd=+m[3];
    if(mm>=1&&mm<=12&&dd>=1&&dd<=31) return {yyyy,mm,dd, raw:m[0]};
  }
  // DD-MM-YYYY
  m = t.match(/\b(\d{1,2})-(\d{1,2})-(\d{4})\b/);
  if(m){
    const dd=+m[1], mm=+m[2], yyyy=+m[3];
    if(mm>=1&&mm<=12&&dd>=1&&dd<=31) return {yyyy,mm,dd, raw:m[0]};
  }
  // DD/MM/YYYY or M/D/YYYY
  m = t.match(/\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/);
  if(m){
    const a=+m[1], b=+m[2], yyyy=+m[3];
    // ambiguous: assume first is month if <=12 and second <=31? we accept as-is but common is M/D
    // We'll treat as M/D when a<=12 and b<=31; else D/M
    let mm, dd;
    if(a<=12 && b<=31){ mm=a; dd=b; }
    else { dd=a; mm=b; }
    if(mm>=1&&mm<=12&&dd>=1&&dd<=31) return {yyyy,mm,dd, raw:m[0]};
  }
  return null;
}

function pad2(n){ return String(n).padStart(2,"0"); }
function dayKeyFrom(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

function isTimeField(s){
  if(!s) return false;
  const t = String(s).trim();
  return /^\d{1,2}[:\-]\d{2}([:\-]\d{2})?$/.test(t);
}

function normalizeTime(t){
  if(!t) return "";
  const x = String(t).trim().replace(/-/g,":");
  // if HH:MM:SS ok
  return x;
}

function parseRangeInput(s){
  if(!s) return null;
  const t = String(s).trim();
  // allow "a - b" or "a-b" or "a â€” b"
  const m = t.match(/^\s*(\d+)\s*[-â€“â€”]\s*(\d+)\s*$/);
  if(!m) return null;
  let a = parseInt(m[1],10), b = parseInt(m[2],10);
  if(!Number.isFinite(a) || !Number.isFinite(b)) return null;
  if(a>b){ const tmp=a; a=b; b=tmp; }
  return {from:a,to:b};
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function downloadCSV(filename, rows, headers){
  const esc = (v)=>{
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const csv = [
    headers.map(esc).join(","),
    ...rows.map(r => headers.map(h => esc(r[h])).join(","))
  ].join("\n");
  downloadText(filename, csv);
}

function copyToClipboard(text){
  return navigator.clipboard.writeText(text);
}

function safePreview(s, max=120){
  const t = String(s ?? "");
  if(t.length<=max) return t;
  return t.slice(0,max-1)+"â€¦";
}

/** =========================
 *  Tabs
 *  ========================= */
$("tabAnalyzer").onclick = ()=>{
  $("tabAnalyzer").classList.add("active");
  $("tabKeyword").classList.remove("active");
  $("pageAnalyzer").style.display = "";
  $("pageKeyword").style.display = "none";
};
$("tabKeyword").onclick = ()=>{
  $("tabKeyword").classList.add("active");
  $("tabAnalyzer").classList.remove("active");
  $("pageKeyword").style.display = "";
  $("pageAnalyzer").style.display = "none";
};

/** =========================
 *  Analyzer
 *  ========================= */
let anAllRows = [];
let anFilteredRows = [];
let anMissing = [];
let anSelectedStatuses = new Set();
let anStatusCounts = new Map();
let anDateMode = "single"; // single|range
let anActiveDateFilter = null; // {type, day} or {type, fromDay, toDay}
let anSort = { key:"id", dir:"asc" };

function analyzerParseText(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return [];

  const delim = detectDelimiter(lines);
  const rows = [];

  for(let line0 of lines){
    // âœ… FIX: if whole line wrapped in quotes and contains delimiter, unwrap outer quotes
    const t = String(line0).trim();
    const wrappedDouble = t.startsWith('"') && t.endsWith('"');
    const wrappedSingle = t.startsWith("'") && t.endsWith("'");
    if((wrappedDouble || wrappedSingle) && t.includes(delim)){
      line0 = t.slice(1, -1);
    }

    const parts = splitCSVLine(line0, delim).map(cleanField).filter(x => x !== "");
    if(parts.length < 2) continue;

    const id = parseInt(parts[0],10);
    if(!Number.isFinite(id)) continue;

    // Find date field anywhere after id
    let dateIdx = -1, d = null;
    for(let i=1;i<parts.length;i++){
      const maybe = parseDateOnlyFlexible(parts[i]);
      if(maybe){ dateIdx = i; d = maybe; break; }
    }
    if(dateIdx === -1) continue;

    let timeStr = "";
    // time might be next field OR embedded at end of same field
    if(dateIdx + 1 < parts.length && isTimeField(parts[dateIdx + 1])) {
      timeStr = normalizeTime(parts[dateIdx + 1]);
    } else {
      // try to find a time inside current field (like "29-01-2026 13-13")
      const joined = parts[dateIdx];
      const tm = String(joined).match(/(\d{1,2}[:\-]\d{2}(?:[:\-]\d{2})?)/);
      if(tm) timeStr = normalizeTime(tm[1]);
    }

    const day = dayKeyFrom(d.yyyy, d.mm, d.dd);
    const dt = (d.raw + (timeStr ? " " + timeStr : "")).trim();

    // status = everything between id and date field (excluding time field)
    const status = parts.slice(1, dateIdx).join(" ").trim() || "(no status)";

    rows.push({ id, status, datetime: dt, day });
  }
  return rows;
}

function analyzerBuildStatusCounts(rows){
  const map = new Map();
  for(const r of rows){
    const k = r.status || "(no status)";
    map.set(k, (map.get(k)||0)+1);
  }
  anStatusCounts = map;
}

function analyzerRenderStatusPills(){
  const box = $("anStatusPills");
  box.innerHTML = "";
  const search = $("anStatusSearch").value.trim().toLowerCase();

  // sort statuses by count desc
  const arr = [...anStatusCounts.entries()]
    .sort((a,b)=> b[1]-a[1])
    .filter(([st])=> !search || st.toLowerCase().includes(search));

  if(!arr.length){
    box.innerHTML = `<div class="muted">No statuses found</div>`;
    return;
  }

  for(const [st,count] of arr){
    const pill = document.createElement("div");
    pill.className = "sp" + (anSelectedStatuses.has(st) ? " active":"");
    pill.innerHTML = `<span>${st}</span><small>(${count})</small>`;
    pill.onclick = ()=>{
      if(anSelectedStatuses.has(st)) anSelectedStatuses.delete(st);
      else anSelectedStatuses.add(st);
      analyzerApplyFiltersAndRender();
      analyzerRenderStatusPills();
    };
    box.appendChild(pill);
  }
}

function analyzerDateFilterMatch(row){
  if(!anActiveDateFilter) return true;
  if(anActiveDateFilter.type==="single"){
    return row.day === anActiveDateFilter.day;
  }
  if(anActiveDateFilter.type==="range"){
    return row.day >= anActiveDateFilter.fromDay && row.day <= anActiveDateFilter.toDay;
  }
  return true;
}

function analyzerStatusFilterMatch(row){
  if(!anSelectedStatuses.size) return true;
  return anSelectedStatuses.has(row.status);
}

function analyzerApplyFiltersAndRender(){
  anFilteredRows = anAllRows.filter(r => analyzerDateFilterMatch(r) && analyzerStatusFilterMatch(r));

  // sort
  const dir = anSort.dir === "asc" ? 1 : -1;
  anFilteredRows.sort((a,b)=>{
    let va=a[anSort.key], vb=b[anSort.key];
    if(typeof va === "string") va = va.toLowerCase();
    if(typeof vb === "string") vb = vb.toLowerCase();
    if(va<vb) return -1*dir;
    if(va>vb) return 1*dir;
    return 0;
  });

  $("anTotal").textContent = anAllRows.length;
  $("anVisible").textContent = anFilteredRows.length;

  analyzerRenderTable();
  analyzerUpdateSortIcons();
}

function analyzerRenderTable(){
  const body = $("anTableBody");
  if(!anFilteredRows.length){
    body.innerHTML = `<tr><td colspan="4" class="muted">No rows</td></tr>`;
    return;
  }
  body.innerHTML = anFilteredRows.slice(0, 2000).map(r=>{
    return `<tr>
      <td class="mono">${r.id}</td>
      <td>${r.status}</td>
      <td class="mono">${r.datetime}</td>
      <td class="mono">${r.day}</td>
    </tr>`;
  }).join("");
}

function analyzerUpdateSortIcons(){
  const ids = ["id","status","datetime","day"];
  const map = {
    id:$("anSortId"),
    status:$("anSortStatus"),
    datetime:$("anSortDatetime"),
    day:$("anSortDay")
  };
  for(const k of ids){
    map[k].className = "chev";
  }
  const el = map[anSort.key];
  if(!el) return;
  el.className = "chev" + (anSort.dir==="asc" ? " up":"");
}

document.querySelectorAll("#pageAnalyzer thead th").forEach(th=>{
  th.addEventListener("click", ()=>{
    const k = th.getAttribute("data-k");
    if(!k) return;
    if(anSort.key === k){
      anSort.dir = anSort.dir==="asc" ? "desc" : "asc";
    }else{
      anSort.key = k;
      anSort.dir = "asc";
    }
    analyzerApplyFiltersAndRender();
  });
});

$("anStatusSearch").addEventListener("input", analyzerRenderStatusPills);
$("anClearStatus").onclick = ()=>{
  anSelectedStatuses.clear();
  analyzerApplyFiltersAndRender();
  analyzerRenderStatusPills();
};

$("anModeSingle").onclick = ()=>{
  anDateMode="single";
  $("anModeSingle").classList.add("active");
  $("anModeRange").classList.remove("active");
  $("anSingleField").style.display = "";
  $("anRangeFields").style.display = "none";
  $("anDateModeLabel").textContent = "Single day";
};
$("anModeRange").onclick = ()=>{
  anDateMode="range";
  $("anModeRange").classList.add("active");
  $("anModeSingle").classList.remove("active");
  $("anSingleField").style.display = "none";
  $("anRangeFields").style.display = "";
  $("anDateModeLabel").textContent = "Date range";
};

$("anApplyDate").onclick = ()=>{
  if(anDateMode==="single"){
    const d = parseDateOnlyFlexible($("anDaySingle").value);
    if(!d){
      analyzerSetMsg("bad", "Invalid day. Example: 2026-01-20 or 20-01-2026 or 1/20/2026");
      return;
    }
    anActiveDateFilter = {type:"single", day: dayKeyFrom(d.yyyy,d.mm,d.dd)};
  }else{
    const d1 = parseDateOnlyFlexible($("anDayFrom").value);
    const d2 = parseDateOnlyFlexible($("anDayTo").value);
    if(!d1 || !d2){
      analyzerSetMsg("bad", "Invalid range. Fill From and To (day).");
      return;
    }
    let a = dayKeyFrom(d1.yyyy,d1.mm,d1.dd);
    let b = dayKeyFrom(d2.yyyy,d2.mm,d2.dd);
    if(a>b){ const tmp=a; a=b; b=tmp; }
    anActiveDateFilter = {type:"range", fromDay:a, toDay:b};
  }
  analyzerApplyFiltersAndRender();
  analyzerSetMsg("good", "Date filter applied.");
};

$("anClearDate").onclick = ()=>{
  anActiveDateFilter = null;
  $("anDaySingle").value = "";
  $("anDayFrom").value = "";
  $("anDayTo").value = "";
  analyzerApplyFiltersAndRender();
  analyzerSetMsg("good", "Date filter cleared.");
};

function analyzerSetMsg(type, text){
  const box = $("anMsg");
  const dot = box.querySelector(".dot");
  dot.classList.remove("good","bad");
  dot.classList.add(type==="good" ? "good" : "bad");
  box.querySelector("span.mono").textContent = text;
  setPill(type, text);
}

$("anProcess").onclick = ()=>{
  const txt = $("anInput").value || "";
  const rows = analyzerParseText(txt);

  anAllRows = rows;
  anMissing = [];
  $("anMissingCount").textContent = "0";
  $("anUnique").textContent = "0";
  $("anNot").textContent = "0";
  $("anDup").textContent = "0";

  if(!rows.length){
    analyzerBuildStatusCounts([]);
    analyzerRenderStatusPills();
    analyzerApplyFiltersAndRender();
    analyzerSetMsg("bad","No valid rows parsed (check format)");
    return;
  }

  analyzerBuildStatusCounts(rows);
  analyzerRenderStatusPills();
  analyzerApplyFiltersAndRender();
  analyzerSetMsg("good",`Parsed ${rows.length} rows âœ…`);
};

$("anCopyIds").onclick = async ()=>{
  if(!anFilteredRows.length){
    analyzerSetMsg("bad","No visible rows to copy");
    return;
  }
  const s = anFilteredRows.map(r=>r.id).join("\n");
  try{
    await copyToClipboard(s);
    analyzerSetMsg("good",`Copied ${anFilteredRows.length} IDs`);
  }catch(e){
    analyzerSetMsg("bad","Copy failed (browser blocked clipboard)");
  }
};

$("anExportCsv").onclick = ()=>{
  if(!anFilteredRows.length){
    analyzerSetMsg("bad","No visible rows to export");
    return;
  }
  downloadCSV("analyzer_visible.csv", anFilteredRows, ["id","status","datetime","day"]);
  analyzerSetMsg("good",`Exported ${anFilteredRows.length} rows (CSV)`);
};

$("anCheck").onclick = ()=>{
  if(!anFilteredRows.length){
    analyzerSetMsg("bad","No visible rows. Click Process first.");
    return;
  }
  const range = parseRangeInput($("anRange").value);
  if(!range){
    analyzerSetMsg("bad","Invalid range. Example: 1961 - 2240");
    return;
  }

  // Determine missing ids in range based on visible rows
  const ids = anFilteredRows.map(r=>r.id);
  const freq = new Map();
  for(const id of ids) freq.set(id, (freq.get(id)||0)+1);

  let dup = 0;
  for(const [id,c] of freq.entries()) if(c>1) dup += (c-1);

  const uniqueSet = new Set(ids);
  const missing = [];
  for(let x=range.from; x<=range.to; x++){
    if(!uniqueSet.has(x)) missing.push(x);
  }

  anMissing = missing;
  $("anMissingCount").textContent = missing.length;
  $("anUnique").textContent = uniqueSet.size;
  $("anNot").textContent = missing.length;
  $("anDup").textContent = dup;

  analyzerSetMsg("good", `Check done. Missing: ${missing.length}`);
};

$("anCopyNot").onclick = async ()=>{
  if(!anMissing.length){
    analyzerSetMsg("bad","No missing IDs. Click Check first.");
    return;
  }
  try{
    await copyToClipboard(anMissing.join("\n"));
    analyzerSetMsg("good",`Copied NOT PROCESSED (${anMissing.length})`);
  }catch(e){
    analyzerSetMsg("bad","Copy failed (browser blocked clipboard)");
  }
};

$("anExportNot").onclick = ()=>{
  if(!anMissing.length){
    analyzerSetMsg("bad","No missing IDs. Click Check first.");
    return;
  }
  downloadText("not_processed_ids.txt", anMissing.join("\n"));
  analyzerSetMsg("good",`Exported NOT PROCESSED (${anMissing.length})`);
};

/** =========================
 *  Keyword Checker (Apps Script logic)
 *  ========================= */
const KW_STORAGE_KEY = "analyzer_kw_list_v3";
const TG_TOKEN_KEY = "analyzer_tg_token_v1";
const TG_CHAT_KEY = "analyzer_tg_chat_v1";

const DEFAULT_KEYWORDS = [
  "done","already","reply","forward","search completed for","markUnread","sendMessage",
  "successfully","BirthdayChanged","click","Gender Updated","Theme already changed",
  "Gmail Template updated","LanguageValue Updated","English has been added"
].map(x=>x.trim()).filter(Boolean);

let kwKeywords = loadKeywords();
let kwAllRows = [];
let kwVisibleRows = [];
let kwSort = { key:"profile_Name", dir:"asc" };

function loadKeywords(){
  try{
    const raw = localStorage.getItem(KW_STORAGE_KEY);
    if(!raw) return [...DEFAULT_KEYWORDS];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [...DEFAULT_KEYWORDS];
    return arr.map(x=>String(x).trim()).filter(Boolean);
  }catch(e){
    return [...DEFAULT_KEYWORDS];
  }
}
function saveKeywords(){
  localStorage.setItem(KW_STORAGE_KEY, JSON.stringify(kwKeywords));
}

function renderKeywordChips(){
  const box = $("kwChips");
  box.innerHTML = "";
  if(!kwKeywords.length){
    box.innerHTML = `<div class="muted">No keywords</div>`;
    return;
  }
  for(const kw of kwKeywords){
    const c = document.createElement("div");
    c.className = "chip";
    c.innerHTML = `<span>${kw}</span><span class="x" title="remove">Ã—</span>`;
    c.querySelector(".x").onclick = ()=>{
      kwKeywords = kwKeywords.filter(k => k !== kw);
      saveKeywords();
      renderKeywordChips();
    };
    box.appendChild(c);
  }
}

function kwDetectDelimiter(lines){
  return detectDelimiter(lines);
}

function kwParseTable(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trimEnd()).filter(x=>x.trim()!=="");
  if(lines.length < 2) return { rows:[], delim:null, err:"Need header + data rows" };

  const delim = kwDetectDelimiter(lines);
  const headParts = (delim === "\t" ? lines[0].split("\t") : splitCSVLine(lines[0], delim)).map(cleanField);
  const headers = headParts.map(h => h.toLowerCase().trim());

  const idx = (name)=> headers.indexOf(name.toLowerCase());
  const iProfile = idx("profile_name") !== -1 ? idx("profile_name") : idx("profile_name".replace("_","")); // keep
  // handle profile_Name
  const iProfile2 = idx("profile_name") !== -1 ? idx("profile_name") : headers.indexOf("profile_name");
  const iProfile3 = headers.indexOf("profile_name");
  const iProfileName = headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") : headers.indexOf("profile_name");
  // More robust: accept profile_Name or profile_name
  const profileIdx = headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") : headers.indexOf("profile_name");
  // The above doesn't help; do direct alternatives:
  const pIdx = headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") :
               headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") :
               headers.indexOf("profile_name") ;
  // Let's just search alternatives:
  const profileAlt = headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") :
                     headers.indexOf("profile_name".toLowerCase()) ;
  // We'll do a clean fallback:
  const profileNameIdx =
    headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") :
    headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") :
    headers.indexOf("profile_name") ; // placeholder

  // Real: support both "profile_name" and "profile_Name"
  const profileIdx2 = headers.indexOf("profile_name") !== -1 ? headers.indexOf("profile_name") : headers.indexOf("profile_name");
  // This is messy; we do:
  const getIdxAny = (names)=>{
    for(const n of names){
      const j = headers.indexOf(n.toLowerCase());
      if(j!==-1) return j;
    }
    return -1;
  };

  const idxProfile = getIdxAny(["profile_name","profile_Name","profile"]);
  const idxTag = getIdxAny(["tag"]);
  const idxStatusName = getIdxAny(["status_name","status"]);
  const idxLog = getIdxAny(["log"]);
  const idxCnx = getIdxAny(["cnx_problems","cnx_problem","cnx"]);
  const idxDetails = getIdxAny(["details","detail"]);
  const idxScript = getIdxAny(["script_name","script"]);
  const idxSession = getIdxAny(["session_name","session"]);

  if(idxProfile === -1 || idxLog === -1 || idxDetails === -1){
    return { rows:[], delim, err:"Missing required headers: profile_Name + log + details" };
  }

  const rows = [];
  for(let i=1;i<lines.length;i++){
    let line = lines[i];

    // If whole line wrapped in quotes, unwrap (helps CSV paste)
    const t = String(line).trim();
    if((t.startsWith('"') && t.endsWith('"')) || (t.startsWith("'") && t.endsWith("'"))){
      // only unwrap if it likely contains delimiter inside
      if(t.includes(delim)) line = t.slice(1,-1);
    }

    const parts = (delim === "\t") ? line.split("\t") : splitCSVLine(line, delim);
    const vals = parts.map(cleanField);

    const profile_Name = vals[idxProfile] ?? "";
    if(profile_Name === "") continue;

    const tag = idxTag !== -1 ? (vals[idxTag] ?? "") : "";
    const status_name = idxStatusName !== -1 ? (vals[idxStatusName] ?? "") : "";
    const log = vals[idxLog] ?? "";
    const cnx_problems = idxCnx !== -1 ? (vals[idxCnx] ?? "") : "";
    const details = vals[idxDetails] ?? "";
    const script_name = idxScript !== -1 ? (vals[idxScript] ?? "") : "";
    const session_name = idxSession !== -1 ? (vals[idxSession] ?? "") : "";

    const session_short = extractSessionShort(session_name);
    rows.push({
      profile_Name,
      tag,
      status_name,
      log,
      cnx_problems,
      details,
      script_name,
      session_name,
      session_short
    });
  }

  return { rows, delim, err:null };
}

function extractSessionShort(s){
  if(!s) return "";
  const t = String(s).trim();
  const i = t.indexOf("(");
  if(i !== -1) return t.slice(0,i).trim();
  // also remove trailing ip-like patterns if separated by space
  return t.trim();
}

function isDisconnectedRow(r){
  const a = normalizeForSearch(r.cnx_problems);
  const b = normalizeForSearch(r.log);
  const c = normalizeForSearch(r.details);
  const d = normalizeForSearch(r.status_name);
  return /disconnected/.test(a) || /disconnected/.test(b) || /disconnected/.test(c) || /disconnected/.test(d);
}

function computeProcessStatus(row){
  // EXACT Apps Script logic: keyword in log OR details (and we also include cnx_problems) => PROCESSED
  const logText = normalizeForSearch(row.log);
  const detailsText = normalizeForSearch(row.details);
  const cnxText = normalizeForSearch(row.cnx_problems);

  let processed = false;
  if(logText || detailsText || cnxText){
    for(const kw of kwKeywords){
      const k = String(kw).trim().toLowerCase();
      if(!k) continue;
      if(logText.includes(k) || detailsText.includes(k) || cnxText.includes(k)){
        processed = true;
        break;
      }
    }
  }
  return processed ? "PROCESSED" : "NOT PROCESSED";
}

function kwRebuild(){
  const txt = $("kwInput").value || "";
  const parsed = kwParseTable(txt);

  kwAllRows = [];
  if(parsed.err){
    kwSetMsg("bad", parsed.err);
    $("kwTotal").textContent = "0";
    $("kwCountFiltered").textContent = "0";
    $("kwSessionsBox").style.display = "none";
    renderKeywordTable([]);
    setPill("bad", "Keyword Checker: " + parsed.err);
    return;
  }

  const out = parsed.rows.map(r=>{
    const proc = computeProcessStatus(r);
    const disc = isDisconnectedRow(r);
    const preview = `${r.log} ${r.details} ${r.cnx_problems}`.trim();
    return {
      ...r,
      process_status: proc,
      disconnected: disc,
      preview
    };
  });

  kwAllRows = out;
  kwApplyFilterRender();
  kwSetMsg("good", `Processed ${kwAllRows.length} rows âœ… (delim: ${parsed.delim === "\t" ? "TAB" : parsed.delim})`);
  setPill("good", "Keyword check done âœ…");
}

function kwApplyFilterRender(){
  const filter = $("kwFilter").value;

  let visible = kwAllRows;
  if(filter === "PROCESSED"){
    visible = kwAllRows.filter(r => r.process_status === "PROCESSED" && !r.disconnected);
  }else if(filter === "NOT_PROCESSED"){
    visible = kwAllRows.filter(r => r.process_status === "NOT PROCESSED" && !r.disconnected);
  }else if(filter === "DISCONNECTED"){
    visible = kwAllRows.filter(r => r.disconnected);
  }else{
    visible = kwAllRows;
  }

  // sort
  const dir = kwSort.dir === "asc" ? 1 : -1;
  visible.sort((a,b)=>{
    let va=a[kwSort.key], vb=b[kwSort.key];
    if(typeof va === "string") va = va.toLowerCase();
    if(typeof vb === "string") vb = vb.toLowerCase();
    if(va<vb) return -1*dir;
    if(va>vb) return 1*dir;
    return 0;
  });

  kwVisibleRows = visible;

  $("kwTotal").textContent = kwAllRows.length;

  // update right KPI label & count
  const label = filter;
  $("kwFilterLabel").textContent = label.replace("_"," ");
  $("kwCountFiltered").textContent = uniqueProfiles(kwVisibleRows).length;

  // sessions breakdown
  renderSessionBreakdown(filter);

  // table
  renderKeywordTable(kwVisibleRows);
  kwUpdateSortIcons();
}

function uniqueProfiles(rows){
  const set = new Set();
  for(const r of rows) set.add(String(r.profile_Name));
  return [...set];
}

function renderSessionBreakdown(filter){
  const box = $("kwSessionsBox");
  if(!kwAllRows.length){
    box.style.display = "none";
    return;
  }

  // group by session_short (fallback "â€”")
  const groups = new Map();
  for(const r of kwAllRows){
    const s = r.session_short || "â€”";
    if(!groups.has(s)) groups.set(s, []);
    groups.get(s).push(r);
  }

  // build HTML
  const blocks = [];
  const order = [...groups.keys()].sort((a,b)=>a.localeCompare(b));
  for(const sess of order){
    const arr = groups.get(sess);

    const proc = arr.filter(x => x.process_status === "PROCESSED" && !x.disconnected).length;
    const notp = arr.filter(x => x.process_status === "NOT PROCESSED" && !x.disconnected).length;
    const disc = arr.filter(x => x.disconnected).length;

    // list profiles for current filter
    let listRows = arr;
    if(filter === "PROCESSED") listRows = arr.filter(x => x.process_status==="PROCESSED" && !x.disconnected);
    else if(filter === "NOT_PROCESSED") listRows = arr.filter(x => x.process_status==="NOT PROCESSED" && !x.disconnected);
    else if(filter === "DISCONNECTED") listRows = arr.filter(x => x.disconnected);
    else listRows = arr;

    const unique = uniqueProfiles(listRows);

    blocks.push(`
      <details>
        <summary>
          <span class="mono">${escapeHtml(sess)}</span>
          <span class="counts">P:${proc} | N:${notp} | D:${disc} | show:${unique.length}</span>
        </summary>
        <div class="hint2" style="margin-top:10px;">Unique profile_Name (first 300):</div>
        <div class="mono" style="margin-top:8px; white-space:pre-wrap; font-size:12px; color: var(--text);">${escapeHtml(unique.slice(0,300).join("\n"))}</div>
      </details>
    `);
  }

  box.innerHTML = blocks.join("");
  box.style.display = "";
}

function escapeHtml(s){
  return String(s??"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}

function renderKeywordTable(rows){
  const body = $("kwTableBody");
  if(!rows.length){
    body.innerHTML = `<tr><td colspan="6" class="muted">No rows</td></tr>`;
    return;
  }
  body.innerHTML = rows.slice(0,2000).map((r, idx)=>{
    const proc = r.disconnected ? "DISCONNECTED" : r.process_status;
    const badgeClass = r.disconnected ? "warn" : (r.process_status==="PROCESSED" ? "good":"bad");
    const preview = safePreview(r.preview, 150);

    return `<tr>
      <td class="mono">${escapeHtml(r.profile_Name)}</td>
      <td class="mono">${escapeHtml(r.tag || "")}</td>
      <td>${escapeHtml(r.status_name || "")}</td>
      <td><span class="badge ${badgeClass}">${escapeHtml(proc)}</span></td>
      <td class="mono">${escapeHtml(r.session_short || "")}</td>
      <td class="mono">${escapeHtml(preview)}</td>
    </tr>`;
  }).join("");
}

function kwSetMsg(type, text){
  const box = $("kwMsg");
  const dot = box.querySelector(".dot");
  dot.classList.remove("good","bad");
  dot.classList.add(type==="good" ? "good" : "bad");
  box.querySelector("span.mono").textContent = text;
}

function kwUpdateSortIcons(){
  const map = {
    profile_Name:$("kwSortProfile"),
    tag:$("kwSortTag"),
    status_name:$("kwSortStatusName"),
    process_status:$("kwSortProc"),
    session_short:$("kwSortSess"),
    preview:$("kwSortPrev")
  };
  for(const k in map){
    map[k].className = "chev";
  }
  const el = map[kwSort.key];
  if(!el) return;
  el.className = "chev" + (kwSort.dir==="asc" ? " up":"");
}

document.querySelectorAll("#pageKeyword thead th").forEach(th=>{
  th.addEventListener("click", ()=>{
    const k = th.getAttribute("data-k");
    if(!k) return;
    if(kwSort.key === k){
      kwSort.dir = kwSort.dir==="asc" ? "desc" : "asc";
    }else{
      kwSort.key = k;
      kwSort.dir = "asc";
    }
    kwApplyFilterRender();
  });
});

$("kwProcess").onclick = kwRebuild;

$("kwFilter").onchange = ()=>{
  kwApplyFilterRender();
};

$("kwCopy").onclick = async ()=>{
  if(!kwVisibleRows.length){
    kwSetMsg("bad","No rows to copy. Click Process first.");
    return;
  }
  // copy unique profile_Name
  const uniq = uniqueProfiles(kwVisibleRows);
  try{
    await copyToClipboard(uniq.join("\n"));
    kwSetMsg("good",`Copied ${uniq.length} profile_Name âœ…`);
    setPill("good", `Copied ${uniq.length}`);
  }catch(e){
    kwSetMsg("bad","Copy failed (browser blocked clipboard)");
  }
};

$("kwExport").onclick = ()=>{
  if(!kwVisibleRows.length){
    kwSetMsg("bad","No rows to export. Click Process first.");
    return;
  }
  const filter = $("kwFilter").value;
  const uniq = uniqueProfiles(kwVisibleRows);
  downloadText(`${filter.toLowerCase()}_profiles.txt`, uniq.join("\n"));
  kwSetMsg("good",`Exported ${uniq.length} profile_Name âœ…`);
};

$("kwAddBtn").onclick = ()=>{
  const v = $("kwAddInput").value.trim();
  if(!v) return;
  const low = v.toLowerCase();
  if(!kwKeywords.map(x=>x.toLowerCase()).includes(low)){
    kwKeywords.push(v);
    kwKeywords = kwKeywords.map(x=>String(x).trim()).filter(Boolean);
    saveKeywords();
    renderKeywordChips();
    $("kwAddInput").value = "";
    kwSetMsg("good","Keyword added âœ…");
  }else{
    kwSetMsg("bad","Keyword already exists");
  }
};

$("kwAddInput").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    $("kwAddBtn").click();
  }
});

$("kwDefault").onclick = ()=>{
  kwKeywords = [...DEFAULT_KEYWORDS];
  saveKeywords();
  renderKeywordChips();
  kwSetMsg("good","Default list loaded âœ…");
};

$("kwClearAll").onclick = ()=>{
  kwKeywords = [];
  saveKeywords();
  renderKeywordChips();
  kwSetMsg("good","Keywords cleared âœ…");
};

/** =========================
 *  Maintenance (Telegram screenshot)
 *  ========================= */
function getTgCreds(){
  const token = localStorage.getItem(TG_TOKEN_KEY) || "";
  const chat = localStorage.getItem(TG_CHAT_KEY) || "";
  return {token, chat};
}
function setTgCreds(token, chat){
  localStorage.setItem(TG_TOKEN_KEY, token || "");
  localStorage.setItem(TG_CHAT_KEY, chat || "");
}

function openTgModal(){
  const {token, chat} = getTgCreds();
  $("tgToken").value = token;
  $("tgChat").value = chat;
  $("tgModalBack").style.display = "flex";
}
function closeTgModal(){
  $("tgModalBack").style.display = "none";
}

$("btnMaintSettings").onclick = openTgModal;
$("tgClose").onclick = closeTgModal;
$("tgCancel").onclick = closeTgModal;
$("tgModalBack").addEventListener("click",(e)=>{
  if(e.target === $("tgModalBack")) closeTgModal();
});
$("tgSave").onclick = ()=>{
  const token = $("tgToken").value.trim();
  const chat = $("tgChat").value.trim();
  setTgCreds(token, chat);
  closeTgModal();
  setPill("good","Telegram settings saved âœ…");
};

async function sendTelegramPhoto(token, chatId, caption, blob){
  const url = `https://api.telegram.org/bot${token}/sendPhoto`;
  const form = new FormData();
  form.append("chat_id", chatId);
  form.append("caption", caption);
  form.append("photo", blob, "screenshot.png");
  const res = await fetch(url, { method:"POST", body: form });
  const data = await res.json().catch(()=>({ok:false, description:"Invalid JSON"}));
  if(!data.ok) throw new Error(data.description || "Telegram sendPhoto failed");
  return data;
}

async function sendTelegramMessage(token, chatId, text){
  const url = `https://api.telegram.org/bot${token}/sendMessage`;
  const form = new FormData();
  form.append("chat_id", chatId);
  form.append("text", text);
  const res = await fetch(url, { method:"POST", body: form });
  const data = await res.json().catch(()=>({ok:false, description:"Invalid JSON"}));
  if(!data.ok) throw new Error(data.description || "Telegram sendMessage failed");
  return data;
}

function buildMaintenanceReport(mode){
  const now = new Date().toISOString();
  const ua = navigator.userAgent;
  const url = location.href;
  const pill = $("pillText").textContent;

  return [
    "ðŸ›  Maintenance report",
    `Mode: ${mode}`,
    `Time: ${now}`,
    `URL: ${url}`,
    `UA: ${ua}`,
    `Status: ${pill}`
  ].join("\n");
}

async function captureScreenshotBlob(){
  // small delay to allow UI to settle
  await new Promise(r=>setTimeout(r, 120));
  const canvas = await html2canvas(document.body, {
    backgroundColor: null,
    scale: 1.5,
    useCORS: true
  });
  return await new Promise((resolve, reject)=>{
    canvas.toBlob((blob)=>{
      if(!blob) return reject(new Error("Failed to create screenshot blob"));
      resolve(blob);
    }, "image/png", 0.95);
  });
}

$("btnMaint").onclick = async ()=>{
  const {token, chat} = getTgCreds();
  if(!token || !chat){
    setPill("bad","Set Telegram token/chat first (âš™ Telegram)");
    openTgModal();
    return;
  }

  const mode = $("pageKeyword").style.display === "none" ? "Analyzer" : "Keyword Checker";
  const report = buildMaintenanceReport(mode);

  setPill("good","Maintenance: capturing screenshotâ€¦");

  try{
    const blob = await captureScreenshotBlob();
    await sendTelegramPhoto(token, chat, report, blob);
    setPill("good","Maintenance sent âœ… (screenshot + report)");
  }catch(err){
    // fallback: send message only
    try{
      await sendTelegramMessage(token, chat, report + "\n\nâš  Screenshot failed: " + String(err.message || err));
      setPill("bad","Screenshot failed, but report sent âœ…");
    }catch(e2){
      setPill("bad","Maintenance failed: " + String(e2.message || e2));
    }
  }
};

/** =========================
 *  Init
 *  ========================= */
renderKeywordChips();
setPill("bad","No valid rows parsed (check format)");

// make analyzer show correct sort icon at start
analyzerUpdateSortIcons();
kwUpdateSortIcons();
</script>
</body>
</html>
