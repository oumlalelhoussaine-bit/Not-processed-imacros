<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Imacros Analyzer</title>

<style>
:root{
  --bg0:#070b14;
  --bg1:#0b1220;
  --panel:rgba(2,6,23,.82);
  --line:rgba(148,163,184,.16);

  --text:#e5e7eb;
  --muted:#94a3b8;

  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --shadow2: 0 10px 28px rgba(0,0,0,.35);

  --focus: rgba(99,102,241,.22);

  --violet:#6366f1;
  --teal:#22d3ee;

  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --r:18px;
  --r2:14px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(900px 520px at 10% 0%, rgba(99,102,241,.32), transparent 60%),
    radial-gradient(650px 420px at 92% 8%, rgba(34,211,238,.20), transparent 60%),
    radial-gradient(800px 520px at 45% 100%, rgba(34,197,94,.10), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

.container{max-width:1420px;margin:28px auto;padding:0 18px 30px}
.header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:14px}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:42px;height:42px;border-radius:14px;
  background: radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
              linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70));
  box-shadow:0 12px 26px rgba(0,0,0,.35);
}
.brand h1{margin:0;font-size:24px;letter-spacing:.2px}
.brand p{margin:3px 0 0;color:var(--muted);font-size:12.8px}
.rightBadges{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.pill{
  display:inline-flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.03);box-shadow:var(--shadow2);
  color:var(--muted);font-weight:800;font-size:12px
}
.dot{width:8px;height:8px;border-radius:99px;background:rgba(148,163,184,.55);box-shadow:0 0 0 3px rgba(148,163,184,.12)}
.dot.ok{background:var(--ok);box-shadow:0 0 0 3px rgba(34,197,94,.14)}
.dot.bad{background:var(--bad);box-shadow:0 0 0 3px rgba(239,68,68,.14)}
.dot.warn{background:var(--warn);box-shadow:0 0 0 3px rgba(245,158,11,.14)}

.shell{
  border:1px solid var(--line);
  border-radius:var(--r);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
  padding:16px;
}
.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
@media (max-width:1050px){.grid{grid-template-columns:1fr}}

.panel{border:1px solid var(--line);background:var(--panel);border-radius:var(--r);padding:14px}
.panelTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.panelTitle b{font-size:13px}
.panelTitle span{color:var(--muted);font-weight:800;font-size:12px}

textarea{
  width:100%;min-height:320px;border-radius:var(--r);
  border:1px solid var(--line);background:rgba(2,6,23,.88);color:var(--text);
  padding:14px;outline:none;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size:12.7px;line-height:1.45;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
textarea:focus{border-color:rgba(99,102,241,.85);box-shadow:0 0 0 4px var(--focus)}

.kpis{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:1050px){.kpis{grid-template-columns:1fr 1fr}}
.kpi{
  padding:12px;border-radius:var(--r2);border:1px solid var(--line);
  background:rgba(255,255,255,.03);display:flex;flex-direction:column;gap:4px
}
.kpi span{color:var(--muted);font-size:12px;font-weight:800}
.kpi b{font-size:18px;letter-spacing:.2px}

hr.sep{border:none;height:1px;background:var(--line);margin:12px 0}

.controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media (max-width:1050px){.controls{grid-template-columns:1fr}}
.btn{
  width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.10);
  padding:11px 12px;cursor:pointer;color:white;font-weight:900;letter-spacing:.2px;
  transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
  box-shadow:0 10px 22px rgba(0,0,0,.28);
}
.btn:hover{filter:brightness(1.05);box-shadow:0 0 0 3px rgba(99,102,241,.14),0 14px 28px rgba(0,0,0,.38)}
.btn:active{transform:scale(.985)}
.btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;filter:grayscale(.2)}
.btn.process{background:linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70))}
.btn.copy{background:linear-gradient(135deg, rgba(34,211,238,.58), rgba(99,102,241,.58))}
.btn.export{background:linear-gradient(135deg, rgba(99,102,241,.70), rgba(167,139,250,.70))}
.btn.apply{background:linear-gradient(135deg, rgba(99,102,241,.90), rgba(34,211,238,.55))}
.btn.clear{background:linear-gradient(135deg, rgba(148,163,184,.30), rgba(51,65,85,.55))}
.btn.check{background:linear-gradient(135deg, rgba(245,158,11,.75), rgba(99,102,241,.65))}
.btn.copyMissing{background:linear-gradient(135deg, rgba(34,197,94,.75), rgba(34,211,238,.55))}
.btn.exportMissing{background:linear-gradient(135deg, rgba(239,68,68,.75), rgba(99,102,241,.55))}

.sectionTitle{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:2px 0 8px}
.sectionTitle b{font-size:13px}
.sectionTitle small{color:var(--muted);font-weight:800}

.modeRow{display:flex;gap:10px;flex-wrap:wrap}
.mode{
  flex:1;min-width:160px;display:flex;align-items:center;justify-content:center;gap:10px;
  border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.02);
  padding:10px 12px;font-weight:900;cursor:pointer
}
.mode input{accent-color:var(--teal)}
.mode.active{border-color:rgba(99,102,241,.7);box-shadow:0 0 0 4px rgba(99,102,241,.12);background:rgba(99,102,241,.07)}

input{
  width:100%;border-radius:14px;border:1px solid var(--line);
  background:rgba(2,6,23,.88);color:var(--text);
  padding:11px 12px;outline:none;font-weight:900
}
input:focus{border-color:rgba(99,102,241,.85);box-shadow:0 0 0 4px var(--focus)}
.hint{margin-top:6px;color:var(--muted);font-size:12px;font-weight:800}

.two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:520px){.two{grid-template-columns:1fr}}

.badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.badge{
  padding:7px 10px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.03);font-size:12px;font-weight:900
}
.badge b{color:var(--teal)}

.box{
  margin-top:10px;border:1px solid var(--line);background:rgba(2,6,23,.88);
  border-radius:14px;padding:10px;max-height:220px;overflow:auto;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size:12px;white-space:pre;
}
.status{
  margin-top:10px;border-radius:14px;border:1px dashed rgba(148,163,184,.25);
  padding:10px 12px;font-weight:800;font-size:13px;color:var(--muted);
}

.statusList{margin-top:10px;border:1px solid var(--line);background:rgba(255,255,255,.02);border-radius:14px;padding:10px}
.statusHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.statusHeader b{font-size:12.5px}
.statusHeader small{color:var(--muted);font-weight:900}
.statusItems{
  display:flex;flex-wrap:wrap;gap:8px;
  max-height:120px;overflow:auto;padding-right:4px
}
.pillItem{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(2,6,23,.65);
  cursor:pointer;font-weight:900;font-size:12px;
}
.pillItem:hover{border-color:rgba(34,211,238,.25)}
.pillItem.active{
  background:linear-gradient(135deg, rgba(99,102,241,.75), rgba(34,211,238,.45));
  border-color:rgba(99,102,241,.35);
}
.pillItem em{font-style:normal;color:var(--muted);font-weight:900}

.tableWrap{
  margin-top:16px;border:1px solid var(--line);border-radius:var(--r);
  overflow:auto;background:rgba(2,6,23,.78);max-height:560px
}
table{width:100%;border-collapse:collapse;font-size:13px}
thead{position:sticky;top:0;z-index:2;background:rgba(15,26,46,.95);backdrop-filter:blur(8px)}
th,td{padding:12px;border-bottom:1px solid rgba(148,163,184,.14);white-space:nowrap}
tbody tr:hover{background:rgba(99,102,241,.08)}
.empty{text-align:center;color:var(--muted);padding:26px;font-weight:800}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>CSV Analyzer</h1>
        <p>Process logs ‚Üí filter (date + status) ‚Üí check ID range ‚Üí list NOT processed IDs.</p>
      </div>
    </div>

    <div class="rightBadges">
      <div class="pill"><span class="dot warn"></span> Tip: Process ‚Üí Apply filters ‚Üí Check</div>
      <div class="pill" id="pill">
        <span class="dot" id="pillDot"></span>
        <span id="pillText">Ready</span>
      </div>
    </div>
  </div>

  <div class="shell">
    <div class="grid">
      <div class="panel">
        <div class="panelTitle">
          <b>Input</b>
          <span>Paste CSV / logs (date can be anywhere in the line)</span>
        </div>
        <textarea id="csvInput" placeholder='Examples:
"4276,success,profile picture changed 23-01-2026 3-42"
"4338,Translate succes,1/20/2026, 12:51:15 AM,AI art,#EANF#,Romanian"
2504, search Nathan passed successfully,2026-01-16
1961,input empty,21-12-2024_11-7
'></textarea>
      </div>

      <div class="panel">
        <div class="panelTitle">
          <b>Controls</b>
          <span>Filters affect table + range check</span>
        </div>

        <div class="kpis">
          <div class="kpi">
            <span>Total parsed</span>
            <b id="total">‚Äî</b>
            <span style="margin-top:6px" id="daysLabel">Days: ‚Äî</span>
          </div>
          <div class="kpi">
            <span>Visible rows</span>
            <b id="count">‚Äî</b>
            <span style="margin-top:6px" id="scopeLabel">‚Äî</span>
          </div>
          <div class="kpi">
            <span>Not processed</span>
            <b id="missingKpi">0</b>
            <span style="margin-top:6px">after Check</span>
          </div>
        </div>

        <hr class="sep">

        <div class="controls">
          <button class="btn process" id="btnProcess">‚ö° Process</button>
          <button class="btn copy" id="btnCopy">üìã Copy IDs</button>
          <button class="btn export" id="btnExport">‚¨á Export CSV</button>
        </div>

        <hr class="sep">

        <div class="sectionTitle">
          <b>Date filter</b>
          <small id="dateModeLabel">Single day</small>
        </div>

        <div class="modeRow">
          <label class="mode active" id="modeSingle">
            <input type="radio" name="dateMode" value="single" checked>
            Single day
          </label>
          <label class="mode" id="modeRange">
            <input type="radio" name="dateMode" value="range">
            Date range
          </label>
        </div>

        <div id="singleWrap" style="margin-top:10px">
          <input id="singleDate" placeholder="Day (YYYY-MM-DD or DD-MM-YYYY or M/D/YYYY)">
          <div class="hint">Examples: 2026-01-20 | 20-01-2026 | 1/20/2026</div>
        </div>

        <div id="rangeWrap" style="margin-top:10px;display:none">
          <div class="two">
            <input id="dateFrom" placeholder="From day">
            <input id="dateTo" placeholder="To day">
          </div>
          <div class="hint">Tip: if From > To we auto-swap</div>
        </div>

        <hr class="sep">

        <div class="sectionTitle">
          <b>Status filter</b>
          <small>Multi-select (normalized)</small>
        </div>

        <div class="statusList">
          <div class="statusHeader">
            <b>Available statuses</b>
            <div style="display:flex;gap:10px;align-items:center">
              <small id="statusHint">If none selected ‚Üí all statuses</small>
              <button class="btn clear" id="btnClearStatus" style="padding:8px 10px;border-radius:12px;box-shadow:none;font-weight:900">Clear</button>
            </div>
          </div>
          <div class="statusItems" id="statusItems">
            <span class="hint">Process to load statuses‚Ä¶</span>
          </div>
        </div>

        <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr">
          <button class="btn apply" id="btnApplyFilters">‚úÖ Apply filters</button>
          <button class="btn clear" id="btnClearFilters">‚Ü© Clear filters</button>
        </div>

        <hr class="sep">

        <div class="sectionTitle">
          <b>ID range check</b>
          <small>Compare on visible rows</small>
        </div>

        <div class="two">
          <input id="fromId" type="number" value="1961" min="0" placeholder="From ID">
          <input id="toId" type="number" value="2240" min="0" placeholder="To ID">
        </div>

        <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr 1fr">
          <button class="btn check" id="btnRange">üîé Check</button>
          <button class="btn copyMissing" id="btnCopyMissing">üìã Copy not</button>
          <button class="btn exportMissing" id="btnExportMissing">‚¨á Export not</button>
        </div>

        <div class="badges">
          <div class="badge">Processed unique: <b id="procInRange">0</b></div>
          <div class="badge">Not processed: <b id="missingCount">0</b></div>
          <div class="badge">Duplicates: <b id="dupCount">0</b></div>
        </div>

        <div class="box" id="missingBox">Run ‚ÄúCheck‚Äù‚Ä¶</div>
        <div class="status" id="status">Waiting‚Ä¶</div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr><th>ID</th><th>STATUS</th><th>DATETIME</th><th>DAY</th></tr>
        </thead>
        <tbody id="outputBody">
          <tr><td colspan="4" class="empty">No data yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

function setPill(type, text){
  const dot = $("pillDot");
  const pillText = $("pillText");
  dot.className = "dot" + (type ? " " + type : "");
  pillText.textContent = text || "Ready";
}
function setStatus(msg, type="muted"){
  const el = $("status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setPill(type === "ok" ? "ok" : type === "bad" ? "bad" : type === "warn" ? "warn" : "", msg);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeCsv(s){
  s = String(s ?? "");
  if(/[;\n\r"]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function cleanField(v){
  return String(v ?? "")
    .trim()
    .replace(/^"+|"+$/g,"")
    .replace(/^'+|'+$/g,"")
    .trim();
}
function normalizeLine(line){
  return String(line ?? "")
    .replace(/[\u201C\u201D\u00AB\u00BB]/g, '"')
    .replace(/[\u2018\u2019]/g, "'")
    .replace(/\u00A0/g, " ")
    .trim();
}
function extractFirstInt(s){
  const m = String(s ?? "").match(/\d+/);
  return m ? parseInt(m[0], 10) : NaN;
}

/* ===== date utils ===== */
function dayKeyFrom(yyyy,mm,dd){
  const pad = n => String(n).padStart(2,"0");
  return `${yyyy}-${pad(mm)}-${pad(dd)}`;
}
function toUTCDate(dayKey){
  const [y,m,d] = dayKey.split("-").map(Number);
  return new Date(Date.UTC(y, m-1, d));
}
function isValidYMD(y,m,d){
  return y>=1900 && y<=2100 && m>=1 && m<=12 && d>=1 && d<=31;
}
function parseDateOnlyFlexible(v){
  v = String(v||"").trim();
  if(!v) return null;

  if(v.includes("_")) v = v.split("_")[0].trim();
  if(/\s/.test(v)) v = v.split(/\s+/)[0].trim();

  v = v.replace(/,/g,"").trim();
  const s = v.replace(/\./g,"/").replace(/-/g,"/");

  const m = s.match(/^(\d{1,4})\/(\d{1,2})\/(\d{1,4})$/);
  if(!m) return null;

  let a = Number(m[1]), b = Number(m[2]), c = Number(m[3]);
  if([a,b,c].some(n=>Number.isNaN(n))) return null;

  let yyyy, mm, dd;
  if(m[1].length === 4){
    yyyy = a; mm = b; dd = c;
  } else if(m[3].length === 4){
    yyyy = c;
    if(a > 12){ dd = a; mm = b; }
    else if(b > 12){ mm = a; dd = b; }
    else { mm = a; dd = b; }
  } else return null;

  if(!isValidYMD(yyyy,mm,dd)) return null;
  return {yyyy, mm, dd};
}

/* ‚úÖ NEW: find date anywhere in a string (fix your case) */
function findDateInString(text){
  const s = String(text || "");

  // 1) yyyy-mm-dd / yyyy/mm/dd
  let m = s.match(/\b(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})\b/);
  let yyyy, mm, dd, dateRaw;

  if(m){
    yyyy = Number(m[1]); mm = Number(m[2]); dd = Number(m[3]); dateRaw = m[0];
  } else {
    // 2) dd-mm-yyyy OR mm-dd-yyyy (we apply same heuristic)
    m = s.match(/\b(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})\b/);
    if(!m) return null;

    const a = Number(m[1]), b = Number(m[2]);
    yyyy = Number(m[3]);
    if(a > 12){ dd = a; mm = b; } else { mm = a; dd = b; }
    dateRaw = m[0];
  }

  if(!isValidYMD(yyyy,mm,dd)) return null;

  // optional time right after date: " 3-42" or " 12:51:15 AM"
  const after = s.slice(s.indexOf(dateRaw) + dateRaw.length);
  const tm = after.match(/^\s+(\d{1,2})[-:](\d{2})(?:[-:](\d{2}))?\s*(AM|PM)?/i);
  const timeRaw = tm ? tm[0].trim() : "";

  const day = dayKeyFrom(yyyy,mm,dd);
  const datetime = (dateRaw + (timeRaw ? " " + timeRaw : "")).trim();

  return { yyyy, mm, dd, day, datetime };
}

/* ===== delimiter + csv split ===== */
function detectDelimiter(lines){
  let semi=0, comma=0;
  for(const ln of lines.slice(0,30)){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
  }
  return comma >= semi ? "," : ";";
}
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* ===== status normalization ===== */
const STATUS_RULES = [
  { re: /\b(passed successfully|success|succeeded|ok|activated|completed|done|forwarded)\b/i, out: "SUCCESS" },
  { re: /\b(failed|fail|error|wrong password|captcha|disconnected|blocked|denied)\b/i, out: "FAILED" },
  { re: /\b(pending|processing|in progress|waiting|queue)\b/i, out: "PENDING" },
  { re: /\b(skipped|skip|ignored)\b/i, out: "SKIPPED" },
  { re: /\b(not processed|not_processed|unprocessed)\b/i, out: "NOT_PROCESSED" },
];
function normalizeStatusFromText(fullLine, partsAfterId){
  const text = String(fullLine || "");
  for (const r of STATUS_RULES){
    if (r.re.test(text)) return r.out;
  }
  const joined = (partsAfterId || []).join(" ");
  for (const r of STATUS_RULES){
    if (r.re.test(joined)) return r.out;
  }
  if(partsAfterId && partsAfterId.length){
    const t = String(partsAfterId[0] || "").toUpperCase();
    if(["SUCCESS","SUCCES","OK","PASSED"].includes(t)) return "SUCCESS";
    if(["FAILED","FAIL","ERROR"].includes(t)) return "FAILED";
  }
  return "UNKNOWN";
}

/* ===== parsing ===== */
function parseQuotedLine(line){
  let s = normalizeLine(line);
  if(!(s.startsWith('"') && s.endsWith('"'))) return null;
  const inside = s.slice(1,-1).trim();

  const firstComma = inside.indexOf(",");
  if(firstComma === -1) return null;
  const id = extractFirstInt(inside.slice(0, firstComma));
  if(!Number.isFinite(id)) return null;

  const rest = inside.slice(firstComma+1);
  const parts = rest.split(",").map(x=>x.trim()).filter(Boolean);

  // find date anywhere (fix)
  let found = null;
  for(const p of parts){
    found = findDateInString(p) || (parseDateOnlyFlexible(p) ? { ...parseDateOnlyFlexible(p), day: dayKeyFrom(parseDateOnlyFlexible(p).yyyy, parseDateOnlyFlexible(p).mm, parseDateOnlyFlexible(p).dd), datetime: p } : null);
    if(found) break;
  }
  if(!found) found = findDateInString(inside) || findDateInString(line);
  if(!found) return null;

  const status = normalizeStatusFromText(line, parts);
  return { id, idText:String(id), status, datetime: found.datetime, day: found.day };
}

function parseUnquotedLine(line, delim){
  let ln = normalizeLine(line);
  if(!ln) return null;

  if((ln.startsWith('"') && ln.endsWith('"')) || (ln.startsWith("'") && ln.endsWith("'"))){
    ln = ln.slice(1,-1).trim();
  }

  const partsRaw = splitCSVLine(ln, delim).map(cleanField).filter(v => v !== "");
  if(partsRaw.length < 2) return null;

  // find ID anywhere
  let id = NaN;
  let cutIdx = -1;
  for(let i=0;i<partsRaw.length;i++){
    const candidate = extractFirstInt(partsRaw[i]);
    if(Number.isFinite(candidate)){ id = candidate; cutIdx = i; break; }
  }
  if(!Number.isFinite(id)) return null;

  const tail = partsRaw.slice(cutIdx+1);

  // find date anywhere
  let found = null;
  for(const t of tail){
    found = findDateInString(t);
    if(found) break;
    const d = parseDateOnlyFlexible(t);
    if(d){ found = { day: dayKeyFrom(d.yyyy,d.mm,d.dd), datetime: t }; break; }
  }
  if(!found) found = findDateInString(line);
  if(!found) return null;

  const status = normalizeStatusFromText(line, tail);
  return { id, idText:String(id), status, datetime: found.datetime, day: found.day };
}

function parseText(text){
  const lines = String(text||"")
    .replace(/\r/g,"")
    .split("\n")
    .map(normalizeLine)
    .filter(Boolean);
  if(!lines.length) return [];
  const delim = detectDelimiter(lines);
  const rows = [];
  for(const line of lines){
    const r = parseQuotedLine(line) || parseUnquotedLine(line, delim);
    if(r) rows.push(r);
  }
  return rows;
}

/* ===== app state ===== */
let allRows = [];
let visibleRows = [];
let missingIDs = [];
let statusCounts = new Map();
let selectedStatuses = new Set();

function renderTable(){
  const body = $("outputBody");
  body.innerHTML = "";
  if(!visibleRows.length){
    body.innerHTML = `<tr><td colspan="4" class="empty">No rows</td></tr>`;
    $("count").textContent = "0";
    $("scopeLabel").textContent = "‚Äî";
    return;
  }
  for(const r of visibleRows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.idText)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.datetime)}</td>
      <td>${escapeHtml(r.day)}</td>
    `;
    body.appendChild(tr);
  }
  $("count").textContent = String(visibleRows.length);
  $("scopeLabel").textContent = `${visibleRows.length} rows`;
}
function resetRangeBox(){
  $("procInRange").textContent = "0";
  $("missingCount").textContent = "0";
  $("dupCount").textContent = "0";
  $("missingKpi").textContent = "0";
  $("missingBox").textContent = 'Run ‚ÄúCheck‚Äù‚Ä¶';
  missingIDs = [];
}

function dateMode(){
  const r = document.querySelector('input[name="dateMode"]:checked');
  return r ? r.value : "single";
}
function normalizeDateInput(v){
  const d = parseDateOnlyFlexible(v) || (findDateInString(v) ? {yyyy:findDateInString(v).yyyy,mm:findDateInString(v).mm,dd:findDateInString(v).dd} : null);
  if(!d) return null;
  return dayKeyFrom(d.yyyy, d.mm, d.dd);
}

function applyFilters(){
  if(!allRows.length){ setStatus("Process first", "bad"); return; }
  const mode = dateMode();
  let rows = allRows;

  if(mode === "single"){
    const day = normalizeDateInput($("singleDate").value);
    if(!day){ setStatus("Invalid day", "bad"); return; }
    rows = rows.filter(r => r.day === day);
  } else {
    const from = normalizeDateInput($("dateFrom").value);
    const to = normalizeDateInput($("dateTo").value);
    if(!from || !to){ setStatus("Invalid date range", "bad"); return; }
    const a = toUTCDate(from).getTime();
    const b = toUTCDate(to).getTime();
    const lo = Math.min(a,b), hi = Math.max(a,b);
    rows = rows.filter(r=>{
      const t = toUTCDate(r.day).getTime();
      return t >= lo && t <= hi;
    });
  }

  if(selectedStatuses.size){
    rows = rows.filter(r => selectedStatuses.has(r.status));
  }

  visibleRows = rows;
  renderTable();
  resetRangeBox();
  setStatus(`Filters applied (${visibleRows.length} rows)`, "ok");
}

function clearFilters(){
  visibleRows = [...allRows];
  $("singleDate").value = "";
  $("dateFrom").value = "";
  $("dateTo").value = "";
  selectedStatuses.clear();
  renderStatusPills();
  renderTable();
  resetRangeBox();
  setStatus("Filters cleared (showing all rows)", "ok");
}

function normalizeNumRange(a,b){
  let from = Number(a), to = Number(b);
  if(Number.isNaN(from) || Number.isNaN(to)) return null;
  if(from > to){ const t=from; from=to; to=t; }
  return {from,to};
}

function checkRange(){
  if(!visibleRows.length){ setStatus("No visible rows (apply filters first)", "bad"); return; }
  const rr = normalizeNumRange($("fromId").value, $("toId").value);
  if(!rr){ setStatus("Invalid ID range", "bad"); return; }
  const {from,to} = rr;

  const counts = new Map();
  for(const r of visibleRows) counts.set(r.id, (counts.get(r.id)||0)+1);

  let dupN = 0;
  for(const [,c] of counts) if(c>1) dupN++;
  $("dupCount").textContent = String(dupN);

  let processedUniqueInRange = 0;
  for(const [id] of counts) if(id>=from && id<=to) processedUniqueInRange++;
  $("procInRange").textContent = String(processedUniqueInRange);

  missingIDs = [];
  for(let i=from;i<=to;i++) if(!counts.has(i)) missingIDs.push(i);
  $("missingCount").textContent = String(missingIDs.length);
  $("missingKpi").textContent = String(missingIDs.length);

  $("missingBox").textContent =
`Scope = visible rows (your filters)
ID Range: ${from} ‚Üí ${to}

NOT processed (${missingIDs.length}):
${missingIDs.slice(0, 400).join("\n") || "‚Äî"}

(Preview first 400)`;

  setStatus("Range computed ‚úÖ", "ok");
}

function copyIDs(){
  if(!visibleRows.length){ setStatus("No visible rows to copy", "warn"); return; }
  navigator.clipboard.writeText(visibleRows.map(r=>r.idText).join("\n"))
    .then(()=>setStatus(`Copied ${visibleRows.length} IDs`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function exportVisibleCSV(){
  if(!visibleRows.length){ setStatus("No visible rows to export", "warn"); return; }
  let csv = "ID;STATUS;DATETIME;DAY\n";
  for(const r of visibleRows){
    csv += `${safeCsv(r.idText)};${safeCsv(r.status)};${safeCsv(r.datetime)};${safeCsv(r.day)}\n`;
  }
  downloadBlob(csv, "visible.csv", "text/csv;charset=utf-8;");
  setStatus(`Exported visible.csv (${visibleRows.length})`, "ok");
}
function copyMissing(){
  if(!missingIDs.length){ setStatus("No not-processed IDs", "warn"); return; }
  navigator.clipboard.writeText(missingIDs.join("\n"))
    .then(()=>setStatus(`Copied ${missingIDs.length} not processed IDs`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function exportMissing(){
  if(!missingIDs.length){ setStatus("No not-processed IDs", "warn"); return; }
  const rr = normalizeNumRange($("fromId").value, $("toId").value);
  const name = rr ? `not_processed_${rr.from}-${rr.to}.csv` : "not_processed.csv";
  downloadBlob("ID\n" + missingIDs.join("\n"), name, "text/csv;charset=utf-8;");
  setStatus(`Exported ${name}`, "ok");
}

/* ===== status UI ===== */
function buildStatusCounts(){
  statusCounts = new Map();
  for(const r of allRows){
    statusCounts.set(r.status, (statusCounts.get(r.status)||0)+1);
  }
}
function renderStatusPills(){
  const wrap = $("statusItems");
  wrap.innerHTML = "";
  const entries = [...statusCounts.entries()].sort((a,b)=> b[1]-a[1]);

  const filtered = entries.filter(([k]) => k !== "UNKNOWN"); // hide UNKNOWN (noise)
  if(!filtered.length){
    wrap.innerHTML = `<span class="hint">No statuses found</span>`;
    return;
  }

  for(const [k,c] of filtered){
    const el = document.createElement("div");
    el.className = "pillItem" + (selectedStatuses.has(k) ? " active" : "");
    el.innerHTML = `${escapeHtml(k)} <em>(${c})</em>`;
    el.onclick = ()=>{
      if(selectedStatuses.has(k)) selectedStatuses.delete(k);
      else selectedStatuses.add(k);
      renderStatusPills();
      resetRangeBox();
      setStatus(selectedStatuses.size ? `Selected status: ${[...selectedStatuses].join(", ")}` : "No status selected (all statuses)", "ok");
    };
    wrap.appendChild(el);
  }
}
function clearStatusSelection(){
  selectedStatuses.clear();
  renderStatusPills();
  resetRangeBox();
  setStatus("Status cleared (all statuses)", "ok");
}

/* ===== date mode UI ===== */
function refreshModeUI(){
  const m = dateMode();
  $("dateModeLabel").textContent = m === "single" ? "Single day" : "Date range";
  $("singleWrap").style.display = m === "single" ? "block" : "none";
  $("rangeWrap").style.display = m === "range" ? "block" : "none";
  $("modeSingle").classList.toggle("active", m === "single");
  $("modeRange").classList.toggle("active", m === "range");
  resetRangeBox();
  setStatus(`Date mode: ${m}`, "ok");
}

function processCSV(){
  const text = $("csvInput").value.trim();
  if(!text){ setStatus("Input empty", "bad"); return; }

  allRows = parseText(text);
  $("total").textContent = String(allRows.length);

  const days = [...new Set(allRows.map(r=>r.day))].sort((a,b)=>b.localeCompare(a));
  $("daysLabel").textContent = days.length ? ("Days: " + days.slice(0,3).join(", ") + (days.length>3 ? " ‚Ä¶" : "")) : "Days: ‚Äî";

  visibleRows = [...allRows];
  renderTable();
  resetRangeBox();

  buildStatusCounts();
  selectedStatuses.clear();
  renderStatusPills();

  if(!allRows.length){
    setStatus("No valid rows parsed (check format). This version detects date inside text like '... 23-01-2026 3-42'.", "bad");
    return;
  }

  $("singleDate").value = days[0] || "";
  setStatus("Parsed ‚úÖ Now set date/status then Apply filters ‚Üí Check.", "ok");
}

/* Wire */
$("btnProcess").addEventListener("click", processCSV);
$("btnCopy").addEventListener("click", copyIDs);
$("btnExport").addEventListener("click", exportVisibleCSV);

$("btnApplyFilters").addEventListener("click", applyFilters);
$("btnClearFilters").addEventListener("click", clearFilters);

$("btnRange").addEventListener("click", checkRange);
$("btnCopyMissing").addEventListener("click", copyMissing);
$("btnExportMissing").addEventListener("click", exportMissing);

$("btnClearStatus").addEventListener("click", clearStatusSelection);

document.querySelectorAll('input[name="dateMode"]').forEach(r=>{
  r.addEventListener("change", refreshModeUI);
});

setPill("", "Ready");
refreshModeUI();
</script>
</body>
</html>
