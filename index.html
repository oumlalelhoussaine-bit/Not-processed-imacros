<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV Analyzer imacro</title>

<style>
:root{
  --bg:#0b1020;
  --surface:#0f1730;
  --surface2:#101b3a;
  --panel:#0c1226;
  --border:rgba(148,163,184,.16);
  --text:#e9eefc;
  --muted:#9aa7c2;

  --brand:#6d5efc;
  --brand2:#27d7ff;
  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --shadow2: 0 10px 25px rgba(0,0,0,.35);
  --ring: 0 0 0 4px rgba(109,94,252,.18);

  --r:18px;
  --r2:14px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--sans);
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 10% 0%, rgba(109,94,252,.25), transparent 60%),
    radial-gradient(900px 500px at 90% 10%, rgba(39,215,255,.14), transparent 60%),
    radial-gradient(900px 500px at 60% 100%, rgba(34,197,94,.10), transparent 55%),
    linear-gradient(180deg, #070b16, var(--bg));
}

.wrap{
  max-width: 1440px;
  margin: 28px auto;
  padding: 0 18px 28px;
}

/* Topbar */
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  margin-bottom: 14px;
}
.brand{
  display:flex;
  align-items:center;
  gap:12px;
}
.logo{
  width:40px;height:40px;border-radius:14px;
  background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(39,215,255,.65));
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
  position:relative;
}
.logo:after{
  content:"";
  position:absolute; inset:10px;
  border-radius:10px;
  background: rgba(255,255,255,.15);
}
.brand h1{
  font-size: 20px;
  margin:0;
  letter-spacing:.2px;
}
.brand p{
  margin:3px 0 0;
  font-size:12.5px;
  color:var(--muted);
}

.rightStatus{
  display:flex;
  align-items:center;
  gap:10px;
}
.pill{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px;
  border-radius: 999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  box-shadow: var(--shadow2);
  color:var(--muted);
  font-weight:800;
  font-size:12px;
  max-width: 520px;
}
.dot{
  width:9px;height:9px;border-radius:999px;
  background: rgba(148,163,184,.55);
  box-shadow: 0 0 0 3px rgba(148,163,184,.12);
}
.dot.ok{ background: var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.14); }
.dot.bad{ background: var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.14); }
.dot.warn{ background: var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.14); }

.hotkeys{
  display:none;
  padding:10px 12px;
  border-radius: 999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  color:var(--muted);
  font-size:12px;
  font-weight:800;
}
@media(min-width:1100px){ .hotkeys{display:block;} }

/* Layout */
.shell{
  border: 1px solid var(--border);
  border-radius: var(--r);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow: var(--shadow);
  padding: 14px;
}

.grid{
  display:grid;
  grid-template-columns: 1.15fr .85fr;
  gap: 14px;
}
@media(max-width:1050px){
  .grid{grid-template-columns:1fr;}
}

.card{
  border: 1px solid var(--border);
  background: rgba(10,14,30,.78);
  border-radius: var(--r);
  padding: 14px;
}

/* Headers inside cards */
.cardHead{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
  margin-bottom: 10px;
}
.cardHead .title{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.cardHead .title b{
  font-size: 13px;
  letter-spacing:.3px;
}
.cardHead .title span{
  color: var(--muted);
  font-size: 12px;
  font-weight: 700;
}
.smallTag{
  font-size: 12px;
  font-weight: 900;
  color: rgba(233,238,252,.9);
  padding: 8px 10px;
  border-radius: 999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
}

/* Input */
textarea{
  width:100%;
  min-height: 360px;
  border-radius: var(--r);
  border:1px solid var(--border);
  background: rgba(6,10,22,.88);
  color: var(--text);
  padding: 14px;
  outline:none;
  font-family: var(--mono);
  font-size: 12.6px;
  line-height: 1.45;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
textarea:focus{
  border-color: rgba(109,94,252,.55);
  box-shadow: var(--ring);
}

/* KPI Row */
.kpis{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:10px;
  margin-bottom: 12px;
}
@media(max-width:520px){ .kpis{grid-template-columns:1fr;} }
.kpi{
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  border-radius: var(--r2);
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.kpi span{
  color: var(--muted);
  font-weight:800;
  font-size: 12px;
}
.kpi b{
  font-size: 18px;
  letter-spacing:.2px;
}
.kpi .mini{
  font-family: var(--mono);
  font-size: 12px;
  color: rgba(154,167,194,.9);
}

/* Buttons */
.btnRow{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:10px;
}
@media(max-width:520px){ .btnRow{grid-template-columns:1fr;} }

.btn{
  border:none;
  border-radius: 14px;
  padding: 12px 12px;
  font-weight: 900;
  letter-spacing:.2px;
  color:white;
  cursor:pointer;
  transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
  box-shadow: 0 12px 24px rgba(0,0,0,.28);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}
.btn:active{transform:scale(.985)}
.btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
.btn.primary{
  background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(39,215,255,.65));
}
.btn.secondary{
  background: linear-gradient(135deg, rgba(39,215,255,.45), rgba(109,94,252,.55));
}
.btn.ghost{
  background: rgba(255,255,255,.05);
  border: 1px solid var(--border);
  box-shadow:none;
}
.btn:hover{filter:brightness(1.05)}

/* Sections inside control card */
.section{
  margin-top: 12px;
  border-top: 1px solid rgba(148,163,184,.12);
  padding-top: 12px;
}
.sectionHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.sectionHead b{font-size:13px}
.sectionHead small{color:var(--muted);font-weight:800}

/* Segmented controls */
.segment{
  display:flex;
  gap:10px;
}
.segBtn{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding: 11px 12px;
  border-radius: 14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  font-weight: 900;
  cursor:pointer;
  user-select:none;
}
.segBtn input{accent-color: var(--brand2)}
.segBtn.active{
  border-color: rgba(109,94,252,.6);
  background: rgba(109,94,252,.12);
  box-shadow: 0 0 0 4px rgba(109,94,252,.12);
}

.two{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media(max-width:520px){ .two{grid-template-columns:1fr;} }

input{
  width:100%;
  border-radius: 14px;
  border:1px solid var(--border);
  background: rgba(6,10,22,.88);
  color:var(--text);
  padding: 11px 12px;
  outline:none;
  font-weight: 900;
}
input:focus{
  border-color: rgba(109,94,252,.55);
  box-shadow: var(--ring);
}
.hint{
  margin-top: 7px;
  color: var(--muted);
  font-size: 12px;
  font-weight: 800;
}

/* Status pills */
.pills{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.pillOpt{
  cursor:pointer;
  user-select:none;
  padding: 8px 10px;
  border-radius: 999px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(255,255,255,.03);
  font-weight: 900;
  font-size: 12px;
}
.pillOpt.on{
  border-color: rgba(39,215,255,.35);
  background: rgba(39,215,255,.10);
  box-shadow: 0 0 0 3px rgba(39,215,255,.08);
}
.pillOpt small{opacity:.75;font-weight:900}
.miniActions{
  display:flex;
  gap:10px;
  align-items:center;
}
.miniBtn{
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
}

/* Results box */
.box{
  border:1px solid var(--border);
  background: rgba(6,10,22,.88);
  border-radius: 14px;
  padding: 10px;
  max-height: 220px;
  overflow:auto;
  font-family: var(--mono);
  font-size: 12px;
  white-space: pre;
}
.badges{
  display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;
}
.badge{
  padding: 7px 10px;
  border-radius: 999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  font-size: 12px;
  font-weight: 900;
}
.badge b{color: var(--brand2);}

/* Table */
.tableWrap{
  margin-top: 14px;
  border:1px solid var(--border);
  border-radius: var(--r);
  overflow:auto;
  background: rgba(10,14,30,.70);
  max-height: 560px;
}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead{
  position:sticky; top:0; z-index:2;
  background: rgba(16,27,58,.92);
  backdrop-filter: blur(8px);
}
th,td{
  padding: 12px 12px;
  border-bottom: 1px solid rgba(148,163,184,.14);
  white-space:nowrap;
}
tbody tr:hover{background: rgba(109,94,252,.08)}
.empty{
  text-align:center;
  color:var(--muted);
  padding: 26px;
  font-weight: 800;
}

/* Footer status line */
.statusLine{
  margin-top: 10px;
  border-radius: 14px;
  border:1px dashed rgba(148,163,184,.24);
  padding: 10px 12px;
  font-weight: 800;
  font-size: 13px;
  color: var(--muted);
}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>CSV Analyzer</h1>
        <p>Process logs ‚Üí filter (date + status) ‚Üí check ID range ‚Üí list NOT processed IDs.</p>
      </div>
    </div>

    <div class="rightStatus">
      <div class="hotkeys">Tip: Process ‚Üí Apply filters ‚Üí Check</div>
      <div class="pill" id="pill">
        <span class="dot" id="pillDot"></span>
        <span id="pillText">Ready</span>
      </div>
    </div>
  </div>

  <div class="shell">
    <div class="grid">

      <!-- LEFT: INPUT -->
      <div class="card">
        <div class="cardHead">
          <div class="title">
            <b>Input</b>
            <span>Paste CSV / logs (date can be anywhere in the line)</span>
          </div>
          <div class="smallTag">Smart parse</div>
        </div>

        <textarea id="csvInput" placeholder='Examples:
"5377,FAILED,2025-11-17 17:00"
"5385,Alright ..,SUCCESS,Verify your email,2025-11-17 17:02"
13:47:53,"2504, search Nathan...,2026-01-16"
4476;Failed;20-01-2026 20-10;something
'></textarea>
      </div>

      <!-- RIGHT: CONTROLS -->
      <div class="card">
        <div class="cardHead">
          <div class="title">
            <b>Controls</b>
            <span>Filters affect table + range check</span>
          </div>
          <div class="smallTag">Professional</div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <span>Total parsed</span>
            <b id="total">‚Äî</b>
            <div class="mini" id="kpiDays">‚Äî</div>
          </div>
          <div class="kpi">
            <span>Visible rows</span>
            <b id="count">‚Äî</b>
            <div class="mini" id="kpiScope">‚Äî</div>
          </div>
          <div class="kpi">
            <span>Not processed</span>
            <b id="missingCount">0</b>
            <div class="mini">after Check</div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnProcess">‚ö° Process</button>
          <button class="btn secondary" id="btnCopy">üìã Copy IDs</button>
          <button class="btn ghost" id="btnExport">‚¨á Export CSV</button>
        </div>

        <!-- Date filter -->
        <div class="section">
          <div class="sectionHead">
            <b>Date filter</b>
            <small id="dateModeLabel">Single day</small>
          </div>

          <div class="segment">
            <label class="segBtn active" id="modeSingle">
              <input type="radio" name="dateMode" value="single" checked>
              Single day
            </label>
            <label class="segBtn" id="modeRange">
              <input type="radio" name="dateMode" value="range">
              Date range
            </label>
          </div>

          <div id="singleWrap" style="margin-top:10px">
            <input id="singleDate" placeholder="Day (YYYY-MM-DD or DD-MM-YYYY or M/D/YYYY)">
            <div class="hint">Examples: 2026-01-20 | 20-01-2026 | 1/20/2026</div>
          </div>

          <div id="rangeWrap" style="margin-top:10px;display:none">
            <div class="two">
              <input id="dateFrom" placeholder="From day">
              <input id="dateTo" placeholder="To day">
            </div>
            <div class="hint">If From > To we auto-swap</div>
          </div>
        </div>

        <!-- Status filter -->
        <div class="section">
          <div class="sectionHead">
            <b>Status filter</b>
            <small>Multi-select</small>
          </div>

          <div class="miniActions" style="margin-bottom:8px">
            <button class="miniBtn" id="btnStatusClear">Clear status</button>
            <div class="hint" style="margin:0;">If none selected ‚Üí all statuses</div>
          </div>

          <div class="pills" id="statusPills">
            <div class="empty" style="padding:8px;">Process first‚Ä¶</div>
          </div>
        </div>

        <!-- Apply / Clear -->
        <div class="section">
          <div class="btnRow" style="grid-template-columns: 1fr 1fr;">
            <button class="btn primary" id="btnApplyFilters">‚úÖ Apply filters</button>
            <button class="btn ghost" id="btnClearFilters">‚Ü© Clear filters</button>
          </div>
        </div>

        <!-- Range -->
        <div class="section">
          <div class="sectionHead">
            <b>ID range check</b>
            <small id="scopeLabel">‚Äî</small>
          </div>

          <div class="two">
            <input id="fromId" type="number" value="1961" min="0" placeholder="From ID">
            <input id="toId" type="number" value="2240" min="0" placeholder="To ID">
          </div>

          <div class="btnRow" style="margin-top:10px;">
            <button class="btn primary" id="btnRange">üîé Check</button>
            <button class="btn secondary" id="btnCopyMissing">üìã Copy not</button>
            <button class="btn ghost" id="btnExportMissing">‚¨á Export not</button>
          </div>

          <div class="badges">
            <div class="badge">Processed unique: <b id="procInRange">0</b></div>
            <div class="badge">Duplicates: <b id="dupCount">0</b></div>
          </div>

          <div class="box" id="missingBox" style="margin-top:10px">Run ‚ÄúCheck‚Äù‚Ä¶</div>
          <div class="statusLine" id="status">Waiting‚Ä¶</div>
        </div>

      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>STATUS</th>
            <th>DATETIME</th>
            <th>DAY</th>
          </tr>
        </thead>
        <tbody id="outputBody">
          <tr><td colspan="4" class="empty">No data yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* =========================
   Helpers
========================= */
const $ = id => document.getElementById(id);

function setPill(type, text){
  const dot = $("pillDot");
  const pillText = $("pillText");
  dot.className = "dot" + (type ? " " + type : "");
  pillText.textContent = text || "Ready";
}
function setStatus(msg, type="muted"){
  const el = $("status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setPill(type === "ok" ? "ok" : type === "bad" ? "bad" : type === "warn" ? "warn" : "", msg);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeCsv(s){
  s = String(s ?? "");
  if(/[;\n\r"]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function cleanField(v){
  return String(v ?? "")
    .trim()
    .replace(/^"+|"+$/g,"")
    .replace(/^'+|'+$/g,"")
    .trim();
}

/* =========================
   Smart date + time detection
========================= */
function isTimeField(v){
  v = String(v||"").trim();
  return /^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/i.test(v);
}
function parseDateOnlyFlexible(v){
  v = String(v||"").trim();
  if(!v) return null;

  // if token contains time after space or underscore, keep date only for parsing
  if(v.includes("_")) v = v.split("_")[0].trim();
  if(/\s/.test(v)) v = v.split(/\s+/)[0].trim();

  v = v.replace(/,/g,"").trim();
  const s = v.replace(/\./g,"/").replace(/-/g,"/");

  const m = s.match(/^(\d{1,4})\/(\d{1,2})\/(\d{1,4})$/);
  if(!m) return null;

  let a = Number(m[1]), b = Number(m[2]), c = Number(m[3]);
  if([a,b,c].some(n=>Number.isNaN(n))) return null;

  let yyyy, mm, dd;

  if(m[1].length === 4){
    yyyy = a; mm = b; dd = c;          // YYYY/MM/DD
  } else if(m[3].length === 4){
    yyyy = c;
    if(a > 12){ dd = a; mm = b; }      // DD/MM/YYYY
    else if(b > 12){ mm = a; dd = b; } // MM/DD/YYYY (rare)
    else { mm = a; dd = b; }           // default MM/DD/YYYY
  } else return null;

  if(yyyy < 1900 || yyyy > 2100) return null;
  if(mm < 1 || mm > 12) return null;
  if(dd < 1 || dd > 31) return null;

  return {yyyy, mm, dd};
}
function dayKeyFrom(yyyy,mm,dd){
  const pad = n => String(n).padStart(2,"0");
  return `${yyyy}-${pad(mm)}-${pad(dd)}`;
}
function toUTCDate(dayKey){
  const [y,m,d] = dayKey.split("-").map(Number);
  return new Date(Date.UTC(y, m-1, d));
}

/* =========================
   CSV splitting
========================= */
function detectDelimiter(lines){
  let semi=0, comma=0;
  for(const ln of lines.slice(0,30)){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
  }
  return comma >= semi ? "," : ";";
}
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* =========================
   NEW: robust row parser
   - find first numeric ID anywhere
   - find date token anywhere (scan from end)
   - extract STATUS token if exists (SUCCESS/FAILED/etc)
========================= */
const KNOWN_STATUS = new Set([
  "success","succeeded","ok","passed","pass",
  "failed","fail","error","done","completed","complete",
  "pending","processing","not processed","skipped","skip"
]);

function looksLikeStatusToken(v){
  const s = String(v||"").trim();
  if(!s) return false;
  const k = s.toLowerCase();
  if(KNOWN_STATUS.has(k)) return true;
  // handle things like SUCCESS, FAILED, DONE, ERROR with punctuation
  const k2 = k.replace(/[^a-z\s]/g,"").trim();
  return KNOWN_STATUS.has(k2);
}

function parseLineToRow(line, delim){
  let ln = line.trim();
  if(!ln) return null;

  // If whole line is quoted: strip outer quotes (common in your data)
  if((ln.startsWith('"') && ln.endsWith('"')) || (ln.startsWith("'") && ln.endsWith("'"))){
    ln = ln.slice(1,-1).trim();
  }

  // Split
  const partsRaw = splitCSVLine(ln, delim).map(cleanField).filter(v => v !== "");
  if(partsRaw.length < 2) return null;

  // Find ID anywhere
  let idIndex = -1;
  let id = null;
  for(let i=0;i<partsRaw.length;i++){
    const candidate = parseInt(partsRaw[i], 10);
    if(Number.isFinite(candidate)){
      idIndex = i;
      id = candidate;
      break;
    }
  }
  if(idIndex === -1) return null;

  // Consider only tail after ID
  const tail = partsRaw.slice(idIndex + 1);
  if(!tail.length) return null;

  // Find date token anywhere in tail (scan from end is safer)
  let dateIdx = -1;
  let parsedDate = null;
  for(let i=tail.length-1;i>=0;i--){
    const maybe = parseDateOnlyFlexible(tail[i]);
    if(maybe){
      dateIdx = i;
      parsedDate = maybe;
      break;
    }
  }
  if(dateIdx === -1) return null;

  const day = dayKeyFrom(parsedDate.yyyy, parsedDate.mm, parsedDate.dd);

  // Build datetime string (keep original token + time if next token is time)
  let datetime = tail[dateIdx];
  const next = tail[dateIdx + 1];
  if(next && isTimeField(next) && !/\d{1,2}:\d{2}/.test(datetime)){
    datetime = (datetime + " " + next).trim();
  }

  // Extract status: look for known status token within tail excluding date zone
  let status = "";
  for(let i=0;i<tail.length;i++){
    if(i === dateIdx || i === dateIdx+1) continue;
    if(looksLikeStatusToken(tail[i])){
      status = tail[i];
      break;
    }
  }
  // fallback: first token in tail (before date) if no known status
  if(!status){
    const beforeDate = tail.slice(0, dateIdx);
    status = beforeDate.find(x => x.trim()) || "(no status)";
  }

  return {
    id,
    idText: String(id),
    status,
    datetime,
    day
  };
}

function parseText(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return [];
  const delim = detectDelimiter(lines);

  const rows = [];
  for(const line of lines){
    // Try with detected delimiter
    const row = parseLineToRow(line, delim);
    if(row){ rows.push(row); continue; }
    // Fallback: try other delimiter (sometimes mixed files)
    const alt = delim === "," ? ";" : ",";
    const row2 = parseLineToRow(line, alt);
    if(row2) rows.push(row2);
  }
  return rows;
}

/* =========================
   App state
========================= */
let allRows = [];
let visibleRows = [];
let missingIDs = [];
let statusSet = new Set();
let selectedStatuses = new Set();

function statusKey(s){ return String(s||"").trim().toLowerCase(); }

/* =========================
   UI Render
========================= */
function renderTable(){
  const body = $("outputBody");
  body.innerHTML = "";
  if(!visibleRows.length){
    body.innerHTML = `<tr><td colspan="4" class="empty">No rows</td></tr>`;
    $("count").textContent = "0";
    $("kpiScope").textContent = "‚Äî";
    $("scopeLabel").textContent = "‚Äî";
    return;
  }

  for(const r of visibleRows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.idText)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.datetime)}</td>
      <td>${escapeHtml(r.day)}</td>
    `;
    body.appendChild(tr);
  }

  $("count").textContent = String(visibleRows.length);
  $("kpiScope").textContent = "Filters applied";
  $("scopeLabel").textContent = `${visibleRows.length} rows`;
}

function resetRangeBox(){
  $("procInRange").textContent = "0";
  $("missingCount").textContent = "0";
  $("dupCount").textContent = "0";
  $("missingBox").textContent = 'Run ‚ÄúCheck‚Äù‚Ä¶';
  missingIDs = [];
}

function buildStatusPills(){
  const el = $("statusPills");
  el.innerHTML = "";

  if(!statusSet.size){
    el.innerHTML = `<div class="empty" style="padding:8px;">No statuses found</div>`;
    return;
  }

  const counts = new Map();
  const labelByKey = new Map();
  for(const r of allRows){
    const k = statusKey(r.status);
    counts.set(k, (counts.get(k)||0)+1);
    if(!labelByKey.has(k)) labelByKey.set(k, r.status);
  }

  const keys = [...counts.keys()].sort((a,b)=> (counts.get(b)-counts.get(a)) || a.localeCompare(b));
  for(const k of keys){
    const label = labelByKey.get(k) || k;
    const count = counts.get(k) || 0;

    const pill = document.createElement("div");
    pill.className = "pillOpt" + (selectedStatuses.has(k) ? " on" : "");
    pill.innerHTML = `${escapeHtml(label)} <small>(${count})</small>`;
    pill.addEventListener("click", ()=>{
      if(selectedStatuses.has(k)) selectedStatuses.delete(k);
      else selectedStatuses.add(k);
      buildStatusPills();
    });
    el.appendChild(pill);
  }
}

/* =========================
   Date mode + filters
========================= */
function dateMode(){
  const r = document.querySelector('input[name="dateMode"]:checked');
  return r ? r.value : "single";
}
function normalizeDateInput(v){
  const d = parseDateOnlyFlexible(v);
  if(!d) return null;
  return dayKeyFrom(d.yyyy, d.mm, d.dd);
}

function applyFilters(){
  if(!allRows.length){ setStatus("Process first", "bad"); return; }

  const mode = dateMode();
  let filtered = [];

  if(mode === "single"){
    const day = normalizeDateInput($("singleDate").value);
    if(!day){ setStatus("Invalid day", "bad"); return; }
    filtered = allRows.filter(r => r.day === day);
  } else {
    const from = normalizeDateInput($("dateFrom").value);
    const to = normalizeDateInput($("dateTo").value);
    if(!from || !to){ setStatus("Invalid date range", "bad"); return; }
    const a = toUTCDate(from).getTime();
    const b = toUTCDate(to).getTime();
    const lo = Math.min(a,b), hi = Math.max(a,b);
    filtered = allRows.filter(r=>{
      const t = toUTCDate(r.day).getTime();
      return t >= lo && t <= hi;
    });
  }

  if(selectedStatuses.size){
    filtered = filtered.filter(r => selectedStatuses.has(statusKey(r.status)));
  }

  visibleRows = filtered;
  renderTable();
  resetRangeBox();

  const stInfo = selectedStatuses.size ? ` + status(${selectedStatuses.size})` : " + status(ALL)";
  setStatus(`Applied ‚úÖ (${visibleRows.length} rows${stInfo})`, "ok");
}

function clearFilters(){
  visibleRows = [...allRows];
  $("singleDate").value = "";
  $("dateFrom").value = "";
  $("dateTo").value = "";
  selectedStatuses.clear();
  buildStatusPills();
  renderTable();
  resetRangeBox();
  setStatus("Filters cleared (all rows)", "ok");
}

function clearStatusSelection(){
  selectedStatuses.clear();
  buildStatusPills();
  setStatus("Status cleared (ALL statuses)", "ok");
}

/* =========================
   Range check
========================= */
function normalizeNumRange(a,b){
  let from = Number(a), to = Number(b);
  if(Number.isNaN(from) || Number.isNaN(to)) return null;
  if(from > to){ const t=from; from=to; to=t; }
  return {from,to};
}

function checkRange(){
  if(!visibleRows.length){ setStatus("No visible rows (apply filters first)", "bad"); return; }
  const rr = normalizeNumRange($("fromId").value, $("toId").value);
  if(!rr){ setStatus("Invalid ID range", "bad"); return; }

  const {from,to} = rr;
  const counts = new Map();
  for(const r of visibleRows) counts.set(r.id, (counts.get(r.id)||0)+1);

  let dupN = 0;
  for(const [,c] of counts) if(c>1) dupN++;
  $("dupCount").textContent = String(dupN);

  let processedUniqueInRange = 0;
  for(const [id] of counts) if(id>=from && id<=to) processedUniqueInRange++;
  $("procInRange").textContent = String(processedUniqueInRange);

  missingIDs = [];
  for(let i=from;i<=to;i++) if(!counts.has(i)) missingIDs.push(i);

  $("missingCount").textContent = String(missingIDs.length);

  $("missingBox").textContent =
`Scope = visible rows (date + status filters)
ID Range: ${from} ‚Üí ${to}

NOT processed (${missingIDs.length}):
${missingIDs.slice(0, 400).join("\n") || "‚Äî"}

(Preview first 400)`;

  setStatus("Range computed ‚úÖ", "ok");
}

/* =========================
   Copy / Export
========================= */
function copyIDs(){
  if(!visibleRows.length){ setStatus("No visible rows to copy", "warn"); return; }
  navigator.clipboard.writeText(visibleRows.map(r=>r.idText).join("\n"))
    .then(()=>setStatus(`Copied ${visibleRows.length} IDs`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function exportVisibleCSV(){
  if(!visibleRows.length){ setStatus("No visible rows to export", "warn"); return; }
  let csv = "ID;STATUS;DATETIME;DAY\n";
  for(const r of visibleRows){
    csv += `${safeCsv(r.idText)};${safeCsv(r.status)};${safeCsv(r.datetime)};${safeCsv(r.day)}\n`;
  }
  downloadBlob(csv, "visible.csv", "text/csv;charset=utf-8;");
  setStatus(`Exported visible.csv (${visibleRows.length})`, "ok");
}
function copyMissing(){
  if(!missingIDs.length){ setStatus("No not-processed IDs", "warn"); return; }
  navigator.clipboard.writeText(missingIDs.join("\n"))
    .then(()=>setStatus(`Copied ${missingIDs.length} not processed IDs`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function exportMissing(){
  if(!missingIDs.length){ setStatus("No not-processed IDs", "warn"); return; }
  const rr = normalizeNumRange($("fromId").value, $("toId").value);
  const name = rr ? `not_processed_${rr.from}-${rr.to}.csv` : "not_processed.csv";
  downloadBlob("ID\n" + missingIDs.join("\n"), name, "text/csv;charset=utf-8;");
  setStatus(`Exported ${name}`, "ok");
}

/* =========================
   Process
========================= */
function processCSV(){
  const text = $("csvInput").value.trim();
  if(!text){ setStatus("Input empty", "bad"); return; }

  allRows = parseText(text);
  $("total").textContent = String(allRows.length);

  const days = [...new Set(allRows.map(r=>r.day))].sort((a,b)=>b.localeCompare(a));
  $("kpiDays").textContent = days.length ? `Days: ${days.slice(0,3).join(", ")}${days.length>3?" ‚Ä¶":""}` : "Days: ‚Äî";

  statusSet = new Set();
  for(const r of allRows) statusSet.add(statusKey(r.status));
  selectedStatuses.clear();
  buildStatusPills();

  visibleRows = [...allRows];
  renderTable();
  resetRangeBox();

  if(!allRows.length){
    setStatus("No valid rows parsed (check format)", "bad");
    return;
  }

  $("singleDate").value = days[0] || "";
  $("kpiScope").textContent = "No filter yet";
  setStatus("Parsed ‚úÖ Select date/status then Apply filters.", "ok");
}

/* Mode UI */
function refreshModeUI(){
  const m = dateMode();
  $("dateModeLabel").textContent = m === "single" ? "Single day" : "Date range";
  $("singleWrap").style.display = m === "single" ? "block" : "none";
  $("rangeWrap").style.display = m === "range" ? "block" : "none";
  $("modeSingle").classList.toggle("active", m === "single");
  $("modeRange").classList.toggle("active", m === "range");
  resetRangeBox();
  setStatus(`Date mode: ${m}`, "ok");
}

/* Wire */
$("btnProcess").addEventListener("click", processCSV);
$("btnCopy").addEventListener("click", copyIDs);
$("btnExport").addEventListener("click", exportVisibleCSV);

$("btnApplyFilters").addEventListener("click", applyFilters);
$("btnClearFilters").addEventListener("click", clearFilters);

$("btnStatusClear").addEventListener("click", clearStatusSelection);

$("btnRange").addEventListener("click", checkRange);
$("btnCopyMissing").addEventListener("click", copyMissing);
$("btnExportMissing").addEventListener("click", exportMissing);

document.querySelectorAll('input[name="dateMode"]').forEach(r=>{
  r.addEventListener("change", refreshModeUI);
});

setPill("", "Ready");
refreshModeUI();
</script>
</body>
</html>
