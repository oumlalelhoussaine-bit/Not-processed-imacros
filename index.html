<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV Analyzer + Keyword Checker (Pro)</title>

<style>
:root{
  --bg0:#070b14;
  --bg1:#0b1220;
  --card:#0f1a2e;
  --line:rgba(148,163,184,.18);

  --text:#e5e7eb;
  --muted:#94a3b8;

  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --shadow2: 0 10px 30px rgba(0,0,0,.35);

  --focus: rgba(99,102,241,.22);

  --c1:#6366f1;      /* indigo */
  --c2:#22d3ee;      /* cyan */
  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --r:18px;
  --r2:14px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(900px 520px at 10% 0%, rgba(99,102,241,.35), transparent 60%),
    radial-gradient(650px 420px at 92% 8%, rgba(34,211,238,.22), transparent 60%),
    radial-gradient(800px 520px at 45% 100%, rgba(34,197,94,.10), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

.container{
  max-width: 1440px;
  margin: 26px auto;
  padding: 0 18px 34px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom: 14px;
}
.brand{
  display:flex;
  align-items:center;
  gap:12px;
}
.logo{
  width:44px;height:44px;border-radius:14px;
  background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70));
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
}
.brandText{display:flex;flex-direction:column;gap:3px}
.brandText h1{
  margin:0;
  font-size: 22px;
  letter-spacing: .2px;
}
.brandText p{
  margin:0;
  color: var(--muted);
  font-size: 12.5px;
}

.rightHeader{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  box-shadow: var(--shadow2);
  color: var(--muted);
  font-weight: 900;
  font-size: 12px;
}
.dot{
  width:8px;height:8px;border-radius:99px;background:rgba(148,163,184,.55);
  box-shadow:0 0 0 3px rgba(148,163,184,.12);
}
.dot.ok{background: var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.14);}
.dot.bad{background: var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.14);}
.dot.warn{background: var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.14);}

.shell{
  border:1px solid var(--line);
  border-radius: var(--r);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow: var(--shadow);
  padding: 14px;
}

.tabs{
  display:flex;
  gap:10px;
  margin-bottom: 12px;
}
.tabBtn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 14px;
  font-weight: 900;
  cursor:pointer;
  transition: box-shadow .12s ease, transform .08s ease, border-color .12s ease, background .12s ease;
}
.tabBtn:hover{box-shadow: 0 0 0 4px rgba(99,102,241,.12)}
.tabBtn.active{
  background: rgba(99,102,241,.10);
  border-color: rgba(99,102,241,.55);
  box-shadow: 0 0 0 4px rgba(99,102,241,.14);
}
.tabPanel{display:none}
.tabPanel.active{display:block}

.grid{
  display:grid;
  grid-template-columns: 1.25fr .75fr;
  gap: 16px;
}
@media (max-width: 1000px){
  .grid{grid-template-columns:1fr}
}

.panel{
  border:1px solid var(--line);
  background: rgba(2,6,23,.82);
  border-radius: var(--r);
  padding: 14px;
}
.panelTitle{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.panelTitle b{font-size: 13px}
.panelTitle span{color:var(--muted);font-weight:900;font-size:12px}

textarea{
  width:100%;
  min-height: 310px;
  border-radius: var(--r);
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  color: var(--text);
  padding: 14px 14px;
  outline:none;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12.7px;
  line-height: 1.42;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
textarea:focus{
  border-color: rgba(99,102,241,.85);
  box-shadow: 0 0 0 4px var(--focus);
}

.kpis{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}
@media (max-width:1000px){
  .kpis{grid-template-columns:1fr}
}
.kpi{
  padding: 12px 12px;
  border-radius: var(--r2);
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  display:flex;
  flex-direction:column;
  gap:4px;
}
.kpi span{
  color:var(--muted);
  font-size: 12px;
  font-weight: 900;
}
.kpi b{
  font-size: 18px;
  letter-spacing: .2px;
}

hr.sep{
  border:none;height:1px;background:var(--line);
  margin: 12px 0;
}

/* Buttons */
.controls{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}
@media (max-width:1000px){
  .controls{grid-template-columns:1fr}
}

.btn{
  width:100%;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  padding: 11px 12px;
  cursor:pointer;
  color:white;
  font-weight: 950;
  letter-spacing:.2px;
  transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease;
  background: linear-gradient(135deg, rgba(99,102,241,.85), rgba(34,211,238,.55));
  box-shadow: 0 10px 22px rgba(0,0,0,.28);
}
.btn:hover{
  filter:brightness(1.05);
  box-shadow: 0 0 0 3px rgba(99,102,241,.16), 0 14px 28px rgba(0,0,0,.38);
}
.btn:active{transform:scale(.985)}
.btn:disabled{
  opacity:.55; cursor:not-allowed; filter:grayscale(.2);
  box-shadow:none;
}

.btn.primary{ background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70)); }
.btn.copy{ background: linear-gradient(135deg, rgba(34,211,238,.40), rgba(99,102,241,.55)); }
.btn.export{ background: linear-gradient(135deg, rgba(99,102,241,.62), rgba(167,139,250,.62)); }
.btn.neutral{ background: linear-gradient(135deg, rgba(148,163,184,.28), rgba(51,65,85,.52)); }

.sectionTitle{
  display:flex;justify-content:space-between;align-items:center;gap:10px;
  margin: 2px 0 8px;
}
.sectionTitle b{font-size:13px}
.sectionTitle small{color:var(--muted);font-weight:900}

.modeRow{
  display:flex; gap:10px; flex-wrap:wrap;
}
.mode{
  flex:1;
  min-width: 160px;
  display:flex; align-items:center; justify-content:center;
  gap:10px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  padding: 10px 12px;
  font-weight: 950;
  cursor:pointer;
}
.mode input{accent-color: var(--c2)}
.mode.active{
  border-color: rgba(99,102,241,.7);
  box-shadow: 0 0 0 4px rgba(99,102,241,.14);
  background: rgba(99,102,241,.08);
}

input, select{
  width:100%;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  color:var(--text);
  padding: 11px 12px;
  outline:none;
  font-weight: 900;
}
input:focus, select:focus{
  border-color: rgba(99,102,241,.85);
  box-shadow: 0 0 0 4px var(--focus);
}
.hint{
  margin-top:6px;
  color: var(--muted);
  font-size: 12px;
  font-weight: 900;
}

.two{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
@media(max-width:500px){.two{grid-template-columns:1fr}}

.badges{
  display:flex; flex-wrap:wrap; gap:8px;
  margin-top:10px;
}
.badge{
  padding: 7px 10px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  font-size: 12px;
  font-weight: 950;
}
.badge b{color: var(--c2);}

.box{
  margin-top:10px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  border-radius: 14px;
  padding: 10px;
  max-height: 210px;
  overflow:auto;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12px;
  white-space: pre;
}

.status{
  margin-top:10px;
  border-radius: 14px;
  border:1px dashed rgba(148,163,184,.25);
  padding: 10px 12px;
  font-weight: 900;
  font-size: 13px;
  color: var(--muted);
}

/* Table */
.tableWrap{
  margin-top:16px;
  border:1px solid var(--line);
  border-radius: var(--r);
  overflow:auto;
  background: rgba(2,6,23,.82);
  max-height: 520px;
}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead{
  position:sticky; top:0; z-index:2;
  background: rgba(15,26,46,.95);
  backdrop-filter: blur(8px);
}
th,td{
  padding: 12px 12px;
  border-bottom: 1px solid rgba(148,163,184,.14);
  white-space:nowrap;
}
tbody tr:hover{background: rgba(99,102,241,.08)}
.empty{
  text-align:center;
  color:var(--muted);
  padding: 26px;
  font-weight: 900;
}
td.good{color: var(--ok); font-weight: 950}
td.bad{color: rgba(248,113,113,.95); font-weight: 950}

/* Keyword chips */
.chips{
  display:flex; flex-wrap:wrap; gap:8px;
  padding: 8px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
}
.chip{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid rgba(148,163,184,.18);
  background: rgba(2,6,23,.70);
  font-weight: 900;
  font-size: 12px;
  color: var(--text);
}
.chip button{
  border:none;
  background: rgba(239,68,68,.16);
  color: rgba(248,113,113,.95);
  border-radius: 999px;
  width:20px;height:20px;
  cursor:pointer;
  font-weight: 950;
}

/* Small filter dropdown in table header */
.thFlex{
  display:flex; align-items:center; gap:8px;
}
.filterBtn{
  margin-left:auto;
  border:1px solid rgba(148,163,184,.18);
  background: rgba(255,255,255,.03);
  color: var(--muted);
  border-radius: 10px;
  padding: 4px 8px;
  cursor:pointer;
  font-weight: 950;
}
.filterBtn:hover{box-shadow: 0 0 0 3px rgba(99,102,241,.12); color: var(--text)}
.filterMenu{
  position:absolute;
  right: 12px;
  top: 44px;
  width: 220px;
  border:1px solid rgba(148,163,184,.18);
  background: rgba(2,6,23,.95);
  border-radius: 14px;
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  overflow:hidden;
  display:none;
}
.filterMenu.open{display:block}
.filterMenu .item{
  padding: 10px 12px;
  cursor:pointer;
  font-weight: 950;
  color: var(--text);
  border-bottom: 1px solid rgba(148,163,184,.12);
}
.filterMenu .item:last-child{border-bottom:none}
.filterMenu .item:hover{background: rgba(99,102,241,.10)}
.filterMenu .item small{color: var(--muted); font-weight: 900}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div class="brandText">
        <h1>CSV Analyzer</h1>
        <p>Analyzer (old logic) + Keyword Checker (same logic as your GAS script)</p>
      </div>
    </div>

    <div class="rightHeader">
      <div class="pill"><span class="dot warn" id="tipDot"></span><span id="tipText">Tip: Process ‚Üí Apply filters ‚Üí Check</span></div>
      <div class="pill" id="pill"><span class="dot" id="pillDot"></span><span id="pillText">Ready</span></div>
    </div>
  </div>

  <div class="shell">

    <div class="tabs">
      <button class="tabBtn active" id="tabAnalyzer">Imacro-filter</button>
      <button class="tabBtn" id="tabKeyword">webautomate-filter</button>
    </div>

    <!-- ===================== Analyzer ===================== -->
    <section class="tabPanel active" id="panelAnalyzer">
      <div class="grid">

        <div class="panel">
          <div class="panelTitle">
            <b>Input</b>
            <span>Paste CSV / logs here</span>
          </div>
          <textarea id="csvInput" placeholder='Examples:
"4338,Translate succes,1/20/2026, 12:51:15 AM,AI art,#EANF#,Romanian"
2504, search Nathan passed successfully,2026-01-16
1961,input empty,21-12-2024_11-7
4476,success,profile picture changed,23-01-2026 3-42
'></textarea>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <b>Controls</b>
            <span>Classic output</span>
          </div>

          <div class="kpis">
            <div class="kpi"><span>Total rows</span><b id="a_total">‚Äî</b></div>
            <div class="kpi"><span>Visible rows</span><b id="a_count">‚Äî</b></div>
            <div class="kpi"><span>Not processed</span><b id="a_missingCountTop">‚Äî</b></div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="btnProcess">‚ö° Process</button>
            <button class="btn copy" id="btnCopy">üìã Copy IDs</button>
            <button class="btn export" id="btnExport">‚¨á Export CSV</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Date filter</b>
            <small id="dateModeLabel">Single day</small>
          </div>

          <div class="modeRow">
            <label class="mode active" id="modeSingle">
              <input type="radio" name="dateMode" value="single" checked>
              Single day
            </label>
            <label class="mode" id="modeRange">
              <input type="radio" name="dateMode" value="range">
              Date range
            </label>
          </div>

          <div id="singleWrap" style="margin-top:10px">
            <input id="singleDate" placeholder="Day (YYYY-MM-DD or DD-MM-YYYY or M/D/YYYY)">
            <div class="hint">Examples: 2026-01-20 | 20-01-2026 | 1/20/2026</div>
          </div>

          <div id="rangeWrap" style="margin-top:10px;display:none">
            <div class="two">
              <input id="dateFrom" placeholder="From day">
              <input id="dateTo" placeholder="To day">
            </div>
            <div class="hint">Tip: if From &gt; To we auto-swap</div>
          </div>

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr">
            <button class="btn primary" id="btnApplyDate">‚úÖ Apply date</button>
            <button class="btn neutral" id="btnClearDate">‚Ü© Clear</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>ID range check</b>
            <small class="hint" style="margin:0">Type: <span style="color:var(--c2);font-weight:950">3376 - 4375</span></small>
          </div>

          <input id="idRange" placeholder="1961 - 2240">

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr 1fr">
            <button class="btn primary" id="btnRange">üîé Check</button>
            <button class="btn copy" id="btnCopyMissing">üìã Copy NOT</button>
            <button class="btn export" id="btnExportMissing">‚¨á Export NOT</button>
          </div>

          <div class="badges">
            <div class="badge">Processed unique: <b id="procInRange">0</b></div>
            <div class="badge">Not processed: <b id="missingCount">0</b></div>
            <div class="badge">Duplicates: <b id="dupCount">0</b></div>
          </div>

          <div class="box" id="missingBox">Run ‚ÄúCheck‚Äù‚Ä¶</div>
          <div class="status" id="status">Waiting‚Ä¶</div>
        </div>

      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>STATUS</th>
              <th>DATETIME</th>
              <th>DAY</th>
            </tr>
          </thead>
          <tbody id="outputBody">
            <tr><td colspan="4" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===================== Keyword Checker ===================== -->
    <section class="tabPanel" id="panelKeyword">
      <div class="grid">

        <div class="panel">
          <div class="panelTitle">
            <b>Input</b>
            <span>Paste table text (Google Sheets TAB) or CSV (must include header: profile_Name ... log ... details)</span>
          </div>
          <textarea id="kwInput" placeholder='Example (TAB from Sheets):
profile_Name	tag	status_name	log	cnx_problems	details
1	[07AD44462586F926]	Completed	[ Status =&gt; connected Updated!] ; BirthdayChanged		...'></textarea>
        </div>

        <div class="panel" style="position:relative">
          <div class="panelTitle">
            <b>Keyword Checker</b>
            <span>Same logic as GAS: keyword in (log/details/cnx_problems) ‚áí PROCESSED</span>
          </div>

          <div class="kpis">
            <div class="kpi"><span>Total rows</span><b id="k_total">‚Äî</b></div>
            <div class="kpi"><span>Processed</span><b id="k_processed">‚Äî</b></div>
            <div class="kpi"><span>Not processed</span><b id="k_not">‚Äî</b></div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="btnKwCheck">‚úÖ Check keywords</button>
            <button class="btn copy" id="btnKwCopyNot">üìã Copy NOT (profile_Name)</button>
            <button class="btn export" id="btnKwExportNot">‚¨á Export NOT</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Keywords</b>
            <small>stored in browser (localStorage)</small>
          </div>

          <div class="two">
            <input id="kwNew" placeholder="Add keyword (ex: done, already, success...)">
            <button class="btn primary" id="btnKwAdd">Ôºã Add</button>
          </div>

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr 1fr">
            <button class="btn neutral" id="btnKwDefault">‚Ü∫ Default list</button>
            <button class="btn neutral" id="btnKwNormalize">‚ú® Normalize</button>
            <button class="btn neutral" id="btnKwClearAll">üßπ Clear all</button>
          </div>

          <div class="hint" style="margin-top:10px">
            Matching is <b>case-insensitive</b>. If no keyword matches ‚Üí row becomes <b>NOT PROCESSED</b>.
          </div>

          <div style="margin-top:10px" class="chips" id="kwChips"></div>

          <div class="box" id="kwBox">Paste input then click ‚ÄúCheck keywords‚Äù‚Ä¶</div>
          <div class="status" id="kwStatus">Waiting‚Ä¶</div>
        </div>

      </div>

      <div class="tableWrap" style="margin-top:16px; position:relative">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>profile_Name</th>
              <th>tag</th>
              <th>status_name</th>

              <!-- process_status with filter -->
              <th style="position:relative" id="thProcessStatus">
                <div class="thFlex">
                  <span>process_status</span>
                  <button class="filterBtn" id="btnPsFilter">‚ñæ</button>
                </div>
                <div class="filterMenu" id="psMenu">
                  <div class="item" data-ps="ALL">All <small>(show everything)</small></div>
                  <div class="item" data-ps="PROCESSED">PROCESSED <small>(only processed)</small></div>
                  <div class="item" data-ps="NOT PROCESSED">NOT PROCESSED <small>(only not processed)</small></div>
                </div>
              </th>

              <th>log/details (preview)</th>
            </tr>
          </thead>
          <tbody id="kwBody">
            <tr><td colspan="6" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </div>
</div>

<script>
/* =========================================================
   Small utilities
========================================================= */
const $ = id => document.getElementById(id);

function setPill(type, text){
  const dot = $("pillDot");
  const pillText = $("pillText");
  dot.className = "dot" + (type ? " " + type : "");
  pillText.textContent = text || "Ready";
}
function setStatus(msg, type="muted"){
  const el = $("status");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
  setPill(type === "ok" ? "ok" : type === "bad" ? "bad" : type === "warn" ? "warn" : "", msg);
}
function setKwStatus(msg, type="muted"){
  const el = $("kwStatus");
  el.textContent = msg;
  el.style.color =
    type === "ok" ? "var(--ok)" :
    type === "bad" ? "var(--bad)" :
    type === "warn" ? "var(--warn)" : "var(--muted)";
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeCsv(s){
  s = String(s ?? "");
  if(/[;\n\r"]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function cleanField(v){
  return String(v ?? "")
    .trim()
    .replace(/^"+|"+$/g,"")
    .replace(/^'+|'+$/g,"")
    .trim();
}

/* =========================================================
   Analyzer (old logic) ‚Äì with better time support
========================================================= */
let allRows = [];
let visibleRows = [];
let missingIDs = [];

function isTimeField(v){
  v = String(v||"").trim().replace(/"+$/,"");
  // supports: 12:51, 12:51:15, 12:51 AM, 3-42, 3-42-10, 3-42 PM
  return /^(\d{1,2})([:\-])(\d{2})(?:\2(\d{2}))?\s*(AM|PM)?$/i.test(v);
}
function normalizeTime(v){
  v = String(v||"").trim().replace(/"+$/,"");
  const m = v.match(/^(\d{1,2})([:\-])(\d{2})(?:\2(\d{2}))?\s*(AM|PM)?$/i);
  if(!m) return v;
  const hh = m[1], mm = m[3], ss = m[4], ap = m[5] ? " " + m[5].toUpperCase() : "";
  return hh + ":" + mm + (ss ? ":" + ss : "") + ap;
}

/* Date parsing (flex)
   Supports:
   - 2026-01-16
   - 16-01-2026
   - 1/20/2026
   - 21-12-2024_11-7 (we take the date)
*/
function parseDateOnlyFlexible(v){
  v = String(v||"").trim();
  if(!v) return null;

  // keep only date part
  if(v.includes("_")) v = v.split("_")[0].trim();
  if(/\s/.test(v)) v = v.split(/\s+/)[0].trim();

  v = v.replace(/,/g,"").trim();
  const s = v.replace(/\./g,"/").replace(/-/g,"/");

  const m = s.match(/^(\d{1,4})\/(\d{1,2})\/(\d{1,4})$/);
  if(!m) return null;

  let a = Number(m[1]), b = Number(m[2]), c = Number(m[3]);
  if([a,b,c].some(n=>Number.isNaN(n))) return null;

  let yyyy, mm, dd;

  if(m[1].length === 4){
    yyyy = a; mm = b; dd = c;          // YYYY/MM/DD
  } else if(m[3].length === 4){
    yyyy = c;
    if(a > 12){ dd = a; mm = b; }      // DD/MM/YYYY
    else if(b > 12){ mm = a; dd = b; } // MM/DD/YYYY (rare)
    else { mm = a; dd = b; }           // default MM/DD/YYYY
  } else return null;

  if(yyyy < 1900 || yyyy > 2100) return null;
  if(mm < 1 || mm > 12) return null;
  if(dd < 1 || dd > 31) return null;

  return {yyyy, mm, dd};
}
function dayKeyFrom(yyyy,mm,dd){
  const pad = n => String(n).padStart(2,"0");
  return `${yyyy}-${pad(mm)}-${pad(dd)}`;
}
function toUTCDate(dayKey){
  const [y,m,d] = dayKey.split("-").map(Number);
  return new Date(Date.UTC(y, m-1, d));
}

function parseWholeQuotedCommaLine(line){
  let s = line.trim();
  if(!(s.startsWith('"') && s.endsWith('"'))) return null;
  s = s.slice(1,-1);

  const commas = [];
  for(let i=0;i<s.length;i++) if(s[i] === ",") commas.push(i);
  if(commas.length < 3) return null;

  // assume pattern: id, status, date, time, ...
  const c1 = commas[0], c2 = commas[1], c3 = commas[2];
  const c4 = commas[3] ?? -1;

  const idStr = s.slice(0,c1).trim();
  const id = parseInt(idStr,10);
  if(!Number.isFinite(id)) return null;

  const status = s.slice(c1+1, c2).trim();
  const dateStr = s.slice(c2+1, c3).trim();
  const timeStr = c4 !== -1 ? s.slice(c3+1, c4).trim() : "";

  const d = parseDateOnlyFlexible(dateStr);
  if(!d) return null;

  const day = dayKeyFrom(d.yyyy, d.mm, d.dd);
  const t = isTimeField(timeStr) ? normalizeTime(timeStr) : "";
  const dt = (dateStr + (t ? " " + t : "")).trim();

  return { id, idText:String(id), status: status || "(no status)", datetime: dt, day };
}

function detectDelimiter(lines){
  let semi=0, comma=0, tab=0;
  for(const ln of lines.slice(0,30)){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
    tab += (ln.match(/\t/g)||[]).length;
  }
  if(tab > Math.max(semi,comma)) return "\t";
  return comma >= semi ? "," : ";";
}
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}

function parseText(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return [];

  const delim = detectDelimiter(lines);
  const rows = [];

  for(const line0 of lines){
    const q = parseWholeQuotedCommaLine(line0);
    if(q){ rows.push(q); continue; }

    const parts = splitCSVLine(line0, delim).map(cleanField).filter(x => x !== "");
    if(parts.length < 2) continue;

    const id = parseInt(parts[0],10);
    if(!Number.isFinite(id)) continue;

    // find first date token anywhere
    let dateIdx = -1, d = null;
    for(let i=1;i<parts.length;i++){
      const maybe = parseDateOnlyFlexible(parts[i]);
      if(maybe){ dateIdx = i; d = maybe; break; }
    }
    if(dateIdx === -1) continue;

    let timeStr = "";
    if(dateIdx + 1 < parts.length && isTimeField(parts[dateIdx + 1])) timeStr = normalizeTime(parts[dateIdx + 1]);

    const day = dayKeyFrom(d.yyyy, d.mm, d.dd);
    const dt = (parts[dateIdx] + (timeStr ? " " + timeStr : "")).trim();
    const status = parts.slice(1, dateIdx).join(" ").trim() || "(no status)";

    rows.push({ id, idText:String(id), status, datetime: dt, day });
  }

  return rows;
}

function renderAnalyzerTable(){
  const body = $("outputBody");
  body.innerHTML = "";

  if(!visibleRows.length){
    body.innerHTML = `<tr><td colspan="4" class="empty">No rows</td></tr>`;
    $("a_count").textContent = "0";
    return;
  }

  for(const r of visibleRows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.idText)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.datetime)}</td>
      <td>${escapeHtml(r.day)}</td>
    `;
    body.appendChild(tr);
  }
  $("a_count").textContent = String(visibleRows.length);
}

function resetAnalyzerRangeBox(){
  $("procInRange").textContent = "0";
  $("missingCount").textContent = "0";
  $("dupCount").textContent = "0";
  $("missingBox").textContent = 'Run ‚ÄúCheck‚Äù‚Ä¶';
  $("a_missingCountTop").textContent = "0";
  missingIDs = [];
}

function analyzerDateMode(){
  const r = document.querySelector('input[name="dateMode"]:checked');
  return r ? r.value : "single";
}
function normalizeDateInput(v){
  const d = parseDateOnlyFlexible(v);
  if(!d) return null;
  return dayKeyFrom(d.yyyy, d.mm, d.dd);
}
function applyAnalyzerDateFilter(){
  if(!allRows.length){ setStatus("Process first", "bad"); return; }

  const mode = analyzerDateMode();
  if(mode === "single"){
    const day = normalizeDateInput($("singleDate").value);
    if(!day){ setStatus("Invalid day", "bad"); return; }
    visibleRows = allRows.filter(r => r.day === day);
    renderAnalyzerTable(); resetAnalyzerRangeBox();
    setStatus(`Filtered by day: ${day}`, "ok");
  } else {
    const from = normalizeDateInput($("dateFrom").value);
    const to = normalizeDateInput($("dateTo").value);
    if(!from || !to){ setStatus("Invalid date range", "bad"); return; }
    const a = toUTCDate(from).getTime();
    const b = toUTCDate(to).getTime();
    const lo = Math.min(a,b), hi = Math.max(a,b);

    visibleRows = allRows.filter(r=>{
      const t = toUTCDate(r.day).getTime();
      return t >= lo && t <= hi;
    });
    renderAnalyzerTable(); resetAnalyzerRangeBox();
    setStatus(`Filtered range: ${from} ‚Üí ${to}`, "ok");
  }
}
function clearAnalyzerDateFilter(){
  visibleRows = [...allRows];
  $("singleDate").value = "";
  $("dateFrom").value = "";
  $("dateTo").value = "";
  renderAnalyzerTable(); resetAnalyzerRangeBox();
  setStatus("Date filter cleared (showing all rows)", "ok");
}

function parseRangeInput(str){
  str = String(str || "").trim();
  if(!str) return null;
  // accepts: "1961-2240" | "1961 - 2240" | "1961‚Äì2240"
  const m = str.replace(/[‚Äì‚Äî]/g,"-").match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
  if(!m) return null;
  let from = Number(m[1]), to = Number(m[2]);
  if(!Number.isFinite(from) || !Number.isFinite(to)) return null;
  if(from > to){ const t=from; from=to; to=t; }
  return {from,to};
}

function checkAnalyzerRange(){
  if(!visibleRows.length){ setStatus("No visible rows (apply date first)", "bad"); return; }

  const rr = parseRangeInput($("idRange").value);
  if(!rr){ setStatus("Invalid ID range (type: 3376 - 4375)", "bad"); return; }
  const {from,to} = rr;

  const counts = new Map();
  for(const r of visibleRows) counts.set(r.id, (counts.get(r.id)||0)+1);

  let dupN = 0;
  for(const [,c] of counts) if(c>1) dupN++;
  $("dupCount").textContent = String(dupN);

  let processedUniqueInRange = 0;
  for(const [id] of counts) if(id>=from && id<=to) processedUniqueInRange++;
  $("procInRange").textContent = String(processedUniqueInRange);

  missingIDs = [];
  for(let i=from;i<=to;i++) if(!counts.has(i)) missingIDs.push(i);
  $("missingCount").textContent = String(missingIDs.length);
  $("a_missingCountTop").textContent = String(missingIDs.length);

  $("missingBox").textContent =
`Scope = visible rows (your date filter)
ID Range: ${from} ‚Üí ${to}

NOT processed (${missingIDs.length}):
${missingIDs.slice(0, 400).join("\n") || "‚Äî"}

(Preview first 400)`;

  setStatus("Range computed ‚úÖ", "ok");
}

function analyzerCopyIDs(){
  if(!visibleRows.length){ setStatus("No visible rows to copy", "warn"); return; }
  navigator.clipboard.writeText(visibleRows.map(r=>r.idText).join("\n"))
    .then(()=>setStatus(`Copied ${visibleRows.length} IDs`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function analyzerExportVisibleCSV(){
  if(!visibleRows.length){ setStatus("No visible rows to export", "warn"); return; }
  let csv = "ID;STATUS;DATETIME;DAY\n";
  for(const r of visibleRows){
    csv += `${safeCsv(r.idText)};${safeCsv(r.status)};${safeCsv(r.datetime)};${safeCsv(r.day)}\n`;
  }
  downloadBlob(csv, "visible.csv", "text/csv;charset=utf-8;");
  setStatus(`Exported visible.csv (${visibleRows.length})`, "ok");
}
function analyzerCopyMissing(){
  if(!missingIDs.length){ setStatus("No not-processed IDs", "warn"); return; }
  navigator.clipboard.writeText(missingIDs.join("\n"))
    .then(()=>setStatus(`Copied ${missingIDs.length} not processed IDs`, "ok"))
    .catch(()=>setStatus("Clipboard blocked by browser", "bad"));
}
function analyzerExportMissing(){
  if(!missingIDs.length){ setStatus("No not-processed IDs", "warn"); return; }
  const rr = parseRangeInput($("idRange").value);
  const name = rr ? `not_processed_${rr.from}-${rr.to}.csv` : "not_processed.csv";
  downloadBlob("ID\n" + missingIDs.join("\n"), name, "text/csv;charset=utf-8;");
  setStatus(`Exported ${name}`, "ok");
}

function processAnalyzer(){
  const text = $("csvInput").value.trim();
  if(!text){ setStatus("Input empty", "bad"); return; }

  allRows = parseText(text);
  $("a_total").textContent = String(allRows.length);

  visibleRows = [...allRows];
  renderAnalyzerTable();
  resetAnalyzerRangeBox();

  if(!allRows.length){
    setStatus("No valid rows parsed (check format)", "bad");
    return;
  }

  // auto-fill latest day into singleDate
  const days = [...new Set(allRows.map(r=>r.day))].sort((a,b)=>b.localeCompare(a));
  $("singleDate").value = days[0] || "";
  setStatus("Parsed ‚úÖ Now choose date and Apply, then Check.", "ok");
}

/* Analyzer UI mode */
function refreshAnalyzerModeUI(){
  const m = analyzerDateMode();
  $("dateModeLabel").textContent = m === "single" ? "Single day" : "Date range";
  $("singleWrap").style.display = m === "single" ? "block" : "none";
  $("rangeWrap").style.display = m === "range" ? "block" : "none";
  $("modeSingle").classList.toggle("active", m === "single");
  $("modeRange").classList.toggle("active", m === "range");
  resetAnalyzerRangeBox();
  setStatus(`Date mode: ${m}`, "ok");
}

/* =========================================================
   Keyword Checker ‚Äì SAME logic as your GAS script
   processed = (log/details/cnx_problems contains any keyword)
========================================================= */
const KW_STORAGE_KEY = "csv_analyzer_keywords_v1";

const DEFAULT_KEYWORDS = [
  "done","already","reply","forward","search completed for","markunread","sendmessage","successfully",
  "birthdaychanged","click","gender updated","theme already changed","gmail template updated",
  "languagevalue updated","english has been added"
];

function normalizeForSearchLikeGAS(v){
  if (v === null || v === undefined) return "";
  let s = String(v);
  if (s === "#ERROR!") return "";
  // GAS: s.replace(/^[=;]+>?/g, '')
  s = s.replace(/^[=;]+>?/g, "");
  return s.toLowerCase();
}

function loadKeywords(){
  try{
    const raw = localStorage.getItem(KW_STORAGE_KEY);
    if(!raw) return [...DEFAULT_KEYWORDS];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [...DEFAULT_KEYWORDS];
    return arr.map(x=>String(x||"")).filter(Boolean);
  }catch(e){
    return [...DEFAULT_KEYWORDS];
  }
}
function saveKeywords(list){
  localStorage.setItem(KW_STORAGE_KEY, JSON.stringify(list));
}
let keywords = loadKeywords();

function normalizeKeywordList(list){
  const out = [];
  const seen = new Set();
  for(const k0 of list){
    const k = String(k0||"").trim().toLowerCase();
    if(!k) continue;
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(k);
  }
  return out;
}

function renderKwChips(){
  const wrap = $("kwChips");
  wrap.innerHTML = "";
  const list = normalizeKeywordList(keywords);
  keywords = list;
  saveKeywords(keywords);

  if(!keywords.length){
    wrap.innerHTML = `<span class="hint">No keywords. Add some or restore default.</span>`;
    return;
  }

  for(const kw of keywords){
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `<span>${escapeHtml(kw)}</span>`;
    const x = document.createElement("button");
    x.textContent = "√ó";
    x.title = "Remove";
    x.addEventListener("click", ()=>{
      keywords = keywords.filter(k=>k !== kw);
      renderKwChips();
    });
    chip.appendChild(x);
    wrap.appendChild(chip);
  }
}

/* Parse TAB/CSV table */
function detectTableDelimiter(text){
  const lines = text.replace(/\r/g,"").split("\n").map(l=>l.trimEnd()).filter(Boolean);
  if(!lines.length) return null;
  const sample = lines.slice(0, 8).join("\n");
  const tabs = (sample.match(/\t/g)||[]).length;
  const commas = (sample.match(/,/g)||[]).length;
  const semis = (sample.match(/;/g)||[]).length;
  if(tabs > Math.max(commas, semis)) return "\t";
  // if looks like CSV with commas
  if(commas >= semis) return ",";
  return ";";
}

function splitRowSmart(line, delim){
  // if TAB => easiest
  if(delim === "\t") return line.split("\t");
  // CSV-like => quoted splitting
  return splitCSVLine(line, delim);
}

function parseKeywordTable(text){
  const lines = text.replace(/\r/g,"").split("\n").map(l=>l.trimEnd()).filter(Boolean);
  if(lines.length < 2) return { rows: [], delim: null, headers: [] };

  const delim = detectTableDelimiter(text);
  const headCells = splitRowSmart(lines[0], delim).map(cleanField);
  const headers = headCells.map(h => String(h||"").trim());

  // header map (lower)
  const hLower = headers.map(h => h.toLowerCase());

  const idxProfile = hLower.indexOf("profile_name");
  const idxTag = hLower.indexOf("tag");
  const idxStatusName = hLower.indexOf("status_name");
  const idxLog = hLower.indexOf("log");
  const idxDetails = hLower.indexOf("details");
  const idxCnx = hLower.indexOf("cnx_problems");

  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cells = splitRowSmart(lines[i], delim).map(cleanField);
    if(cells.every(c => String(c).trim() === "")) continue;

    const profileName = idxProfile !== -1 ? (cells[idxProfile] ?? "") : (cells[0] ?? "");
    const tag = idxTag !== -1 ? (cells[idxTag] ?? "") : "";
    const statusName = idxStatusName !== -1 ? (cells[idxStatusName] ?? "") : "";

    const rawLog = idxLog !== -1 ? (cells[idxLog] ?? "") : "";
    const rawDetails = idxDetails !== -1 ? (cells[idxDetails] ?? "") : "";
    const rawCnx = idxCnx !== -1 ? (cells[idxCnx] ?? "") : "";

    const logText = normalizeForSearchLikeGAS(rawLog);
    const detailsText = normalizeForSearchLikeGAS(rawDetails);
    const cnxText = normalizeForSearchLikeGAS(rawCnx);

    let processed = false;
    const kwList = normalizeKeywordList(keywords);

    if(logText || detailsText || cnxText){
      for(const kw of kwList){
        if(!kw) continue;
        if(logText.includes(kw) || detailsText.includes(kw) || cnxText.includes(kw)){
          processed = true;
          break;
        }
      }
    }

    const processStatus = processed ? "PROCESSED" : "NOT PROCESSED";
    const preview = [rawLog, rawCnx, rawDetails].map(x=>String(x||"").trim()).filter(Boolean).join(" | ");

    rows.push({
      n: rows.length + 1,
      profile_Name: String(profileName||"").trim(),
      tag: String(tag||"").trim(),
      status_name: String(statusName||"").trim(),
      process_status: processStatus,
      preview,
      __processed: processed
    });
  }

  return { rows, delim, headers };
}

let kwAllRows = [];
let kwVisibleRows = [];
let kwNotList = [];
let kwProcessFilter = "ALL"; // ALL | PROCESSED | NOT PROCESSED

function applyKwProcessFilter(){
  if(kwProcessFilter === "PROCESSED") kwVisibleRows = kwAllRows.filter(r => r.process_status === "PROCESSED");
  else if(kwProcessFilter === "NOT PROCESSED") kwVisibleRows = kwAllRows.filter(r => r.process_status === "NOT PROCESSED");
  else kwVisibleRows = [...kwAllRows];
}

function recomputeKwStats(){
  // Stats should reflect current visible rows (because user asked for filter)
  const total = kwVisibleRows.length;
  const proc = kwVisibleRows.filter(r=>r.process_status === "PROCESSED").length;
  const notp = kwVisibleRows.filter(r=>r.process_status === "NOT PROCESSED").length;

  $("k_total").textContent = String(total);
  $("k_processed").textContent = String(proc);
  $("k_not").textContent = String(notp);

  // Not list should be unique profile_Name (from visible rows)
  const set = new Set();
  kwNotList = [];
  for(const r of kwVisibleRows){
    if(r.process_status === "NOT PROCESSED"){
      const pn = String(r.profile_Name||"").trim();
      if(pn && !set.has(pn)){
        set.add(pn);
        kwNotList.push(pn);
      }
    }
  }
}

function renderKwTable(){
  const body = $("kwBody");
  body.innerHTML = "";
  if(!kwVisibleRows.length){
    body.innerHTML = `<tr><td colspan="6" class="empty">No rows</td></tr>`;
    return;
  }

  for(const r of kwVisibleRows){
    const tr = document.createElement("tr");
    const cls = r.process_status === "PROCESSED" ? "good" : "bad";
    tr.innerHTML = `
      <td>${escapeHtml(r.n)}</td>
      <td>${escapeHtml(r.profile_Name)}</td>
      <td>${escapeHtml(r.tag)}</td>
      <td>${escapeHtml(r.status_name)}</td>
      <td class="${cls}">${escapeHtml(r.process_status)}</td>
      <td title="${escapeHtml(r.preview)}">${escapeHtml(r.preview).slice(0,120)}${r.preview.length>120 ? "‚Ä¶" : ""}</td>
    `;
    body.appendChild(tr);
  }
}

function renderKwBox(delimLabel){
  const used = normalizeKeywordList(keywords);
  const first = kwNotList.slice(0, 200);

  $("kwBox").textContent =
`Parsed rows (visible): ${kwVisibleRows.length}   (delim: ${delimLabel || "?"})
Process_status filter: ${kwProcessFilter}


NOT PROCESSED unique profile_Name (first ${Math.min(200, kwNotList.length)}):
${first.join("\n") || "‚Äî"}`;
}

function runKeywordCheck(){
  const text = $("kwInput").value.trim();
  if(!text){ setKwStatus("Input empty", "bad"); return; }

  const parsed = parseKeywordTable(text);
  kwAllRows = parsed.rows || [];

  applyKwProcessFilter();
  recomputeKwStats();
  renderKwTable();
  renderKwBox(parsed.delim === "\t" ? "TAB" : parsed.delim);

  if(!kwAllRows.length){
    setKwStatus("No valid rows parsed (check header / delimiter)", "bad");
    return;
  }

  setKwStatus("Keyword check done ‚úÖ", "ok");
  setPill("ok", "Keyword check done ‚úÖ");
}

function copyKwNot(){
  if(!kwNotList.length){ setKwStatus("No NOT PROCESSED profile_Name", "warn"); return; }
  navigator.clipboard.writeText(kwNotList.join("\n"))
    .then(()=>setKwStatus(`Copied ${kwNotList.length} profile_Name`, "ok"))
    .catch(()=>setKwStatus("Clipboard blocked by browser", "bad"));
}
function exportKwNot(){
  if(!kwNotList.length){ setKwStatus("No NOT PROCESSED profile_Name", "warn"); return; }
  const csv = "profile_Name\n" + kwNotList.map(safeCsv).join("\n");
  downloadBlob(csv, "not_processed_profile_name.csv", "text/csv;charset=utf-8;");
  setKwStatus(`Exported not_processed_profile_name.csv (${kwNotList.length})`, "ok");
}

/* =========================================================
   Tabs
========================================================= */
function activateTab(which){
  const isAnalyzer = which === "analyzer";
  $("tabAnalyzer").classList.toggle("active", isAnalyzer);
  $("tabKeyword").classList.toggle("active", !isAnalyzer);
  $("panelAnalyzer").classList.toggle("active", isAnalyzer);
  $("panelKeyword").classList.toggle("active", !isAnalyzer);

  setPill("", "Ready");
}
$("tabAnalyzer").addEventListener("click", ()=>activateTab("analyzer"));
$("tabKeyword").addEventListener("click", ()=>activateTab("keyword"));

/* =========================================================
   Wire Analyzer events
========================================================= */
$("btnProcess").addEventListener("click", processAnalyzer);
$("btnCopy").addEventListener("click", analyzerCopyIDs);
$("btnExport").addEventListener("click", analyzerExportVisibleCSV);
$("btnApplyDate").addEventListener("click", applyAnalyzerDateFilter);
$("btnClearDate").addEventListener("click", clearAnalyzerDateFilter);
$("btnRange").addEventListener("click", checkAnalyzerRange);
$("btnCopyMissing").addEventListener("click", analyzerCopyMissing);
$("btnExportMissing").addEventListener("click", analyzerExportMissing);
document.querySelectorAll('input[name="dateMode"]').forEach(r=>{
  r.addEventListener("change", refreshAnalyzerModeUI);
});
refreshAnalyzerModeUI();
setPill("", "Ready");

/* =========================================================
   Wire Keyword Checker events
========================================================= */
renderKwChips();

$("btnKwCheck").addEventListener("click", runKeywordCheck);
$("btnKwCopyNot").addEventListener("click", copyKwNot);
$("btnKwExportNot").addEventListener("click", exportKwNot);

$("btnKwAdd").addEventListener("click", ()=>{
  const v = $("kwNew").value.trim();
  if(!v) return;
  keywords = normalizeKeywordList([...keywords, v]);
  $("kwNew").value = "";
  renderKwChips();
  setKwStatus("Keyword added ‚úÖ", "ok");
});

$("btnKwDefault").addEventListener("click", ()=>{
  keywords = normalizeKeywordList([...DEFAULT_KEYWORDS]);
  renderKwChips();
  setKwStatus("Default keywords restored ‚úÖ", "ok");
});

$("btnKwNormalize").addEventListener("click", ()=>{
  keywords = normalizeKeywordList([...keywords]);
  renderKwChips();
  setKwStatus("Keywords normalized ‚úÖ", "ok");
});

$("btnKwClearAll").addEventListener("click", ()=>{
  keywords = [];
  renderKwChips();
  setKwStatus("Keywords cleared", "warn");
});

/* =========================================================
   process_status column filter (dropdown)
========================================================= */
function closePsMenu(){ $("psMenu").classList.remove("open"); }
$("btnPsFilter").addEventListener("click", (e)=>{
  e.stopPropagation();
  $("psMenu").classList.toggle("open");
});

$("psMenu").addEventListener("click", (e)=>{
  const item = e.target.closest(".item");
  if(!item) return;
  kwProcessFilter = item.getAttribute("data-ps") || "ALL";
  closePsMenu();

  applyKwProcessFilter();
  recomputeKwStats();
  renderKwTable();
  renderKwBox("TAB/CSV");
  setKwStatus(`Filter: ${kwProcessFilter}`, "ok");
});

document.addEventListener("click", (e)=>{
  const menu = $("psMenu");
  if(menu.classList.contains("open")){
    const th = $("thProcessStatus");
    if(th && !th.contains(e.target)) closePsMenu();
  }
});
</script>
</body>
</html>
