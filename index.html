<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV Analyzer + Keyword Checker (One File)</title>
<style>
:root{
  --bg0:#070b14;
  --bg1:#0b1220;
  --card:#0f1a2e;
  --panel: rgba(2,6,23,.82);
  --line:rgba(148,163,184,.18);

  --text:#e5e7eb;
  --muted:#94a3b8;

  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --shadow2: 0 10px 30px rgba(0,0,0,.35);

  --focus: rgba(99,102,241,.22);

  --c1:#6366f1;
  --c2:#22d3ee;
  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --r:18px;
  --r2:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(900px 520px at 10% 0%, rgba(99,102,241,.35), transparent 60%),
    radial-gradient(650px 420px at 92% 8%, rgba(34,211,238,.22), transparent 60%),
    radial-gradient(800px 520px at 45% 100%, rgba(34,197,94,.10), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}
.container{max-width: 1400px; margin: 22px auto; padding: 0 18px 28px;}
.header{
  display:flex; align-items:center; justify-content:space-between;
  gap:14px; margin-bottom:12px;
}
.brand{display:flex; align-items:center; gap:12px;}
.logo{
  width:44px;height:44px;border-radius:14px;
  background: linear-gradient(135deg, rgba(99,102,241,.9), rgba(34,211,238,.6));
  box-shadow: var(--shadow2);
}
.brand h1{margin:0; font-size:22px; letter-spacing:.2px;}
.brand p{margin:3px 0 0; color:var(--muted); font-size:12px; font-weight:800}
.badgeRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
.pill{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:999px;
  border:1px solid var(--line); background: rgba(255,255,255,.03);
  box-shadow: var(--shadow2); color: var(--muted);
  font-weight:900; font-size:12px;
}
.dot{width:8px;height:8px;border-radius:99px;background:rgba(148,163,184,.55); box-shadow:0 0 0 3px rgba(148,163,184,.12);}
.dot.ok{background: var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.14);}
.dot.bad{background: var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.14);}
.dot.warn{background: var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.14);}

.shell{
  border:1px solid var(--line);
  border-radius: var(--r);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow: var(--shadow);
  padding: 12px;
}

.tabs{
  display:flex; gap:10px; padding:10px; border-radius: var(--r);
  border:1px solid var(--line); background: rgba(2,6,23,.55);
  margin-bottom: 12px;
}
.tabBtn{
  padding: 10px 14px; border-radius: 14px; border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color: var(--text); font-weight: 900; cursor:pointer;
}
.tabBtn.active{
  border-color: rgba(99,102,241,.6);
  background: rgba(99,102,241,.12);
  box-shadow: 0 0 0 4px rgba(99,102,241,.12);
}

.grid{display:grid; grid-template-columns: 1.25fr .75fr; gap: 12px;}
@media (max-width: 1050px){ .grid{grid-template-columns:1fr} }

.panel{
  border:1px solid var(--line);
  background: var(--panel);
  border-radius: var(--r);
  padding: 12px;
}
.panelTitle{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; margin-bottom: 10px;
}
.panelTitle b{font-size: 13px}
.panelTitle span{color:var(--muted);font-weight:900;font-size:12px}

textarea{
  width:100%; min-height: 320px; border-radius: var(--r);
  border:1px solid var(--line); background: rgba(2,6,23,.88);
  color: var(--text); padding: 14px; outline:none;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12.7px; line-height: 1.42;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
textarea:focus{ border-color: rgba(99,102,241,.85); box-shadow: 0 0 0 4px var(--focus); }

.kpis{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
@media (max-width: 1050px){ .kpis{grid-template-columns:1fr 1fr} }
.kpi{
  padding: 12px; border-radius: var(--r2);
  border:1px solid var(--line); background: rgba(255,255,255,.03);
  display:flex; flex-direction:column; gap:4px;
}
.kpi span{color:var(--muted); font-size:12px; font-weight:900}
.kpi b{font-size:18px}

hr.sep{border:none;height:1px;background:var(--line); margin: 12px 0;}

.controls{display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;}
@media (max-width:1050px){ .controls{grid-template-columns:1fr} }

.btn{
  width:100%; border-radius: 14px; border:1px solid rgba(255,255,255,.10);
  padding: 11px 12px; cursor:pointer; color:white;
  font-weight: 900; letter-spacing:.2px;
  transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease;
  background: linear-gradient(135deg, rgba(99,102,241,.85), rgba(34,211,238,.55));
  box-shadow: 0 10px 22px rgba(0,0,0,.28);
}
.btn:hover{filter:brightness(1.05); box-shadow: 0 0 0 3px rgba(99,102,241,.16), 0 14px 28px rgba(0,0,0,.38);}
.btn:active{transform:scale(.985)}
.btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.2); box-shadow:none;}

.btn.primary{background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.70)); border-color: rgba(99,102,241,.25);}
.btn.secondary{background: linear-gradient(135deg, rgba(34,211,238,.45), rgba(99,102,241,.45)); border-color: rgba(34,211,238,.18);}
.btn.export{background: linear-gradient(135deg, rgba(99,102,241,.70), rgba(167,139,250,.70)); border-color: rgba(167,139,250,.22);}
.btn.neutral{background: linear-gradient(135deg, rgba(148,163,184,.35), rgba(51,65,85,.55)); border-color: rgba(148,163,184,.18);}

.sectionTitle{display:flex;justify-content:space-between;align-items:center;gap:10px; margin: 2px 0 8px;}
.sectionTitle b{font-size:13px}
.sectionTitle small{color:var(--muted);font-weight:900}

.modeRow{display:flex; gap:10px; flex-wrap:wrap;}
.mode{
  flex:1; min-width: 160px;
  display:flex; align-items:center; justify-content:center; gap:10px;
  border-radius: 14px; border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  padding: 10px 12px; font-weight: 900; cursor:pointer;
}
.mode input{accent-color: var(--c2)}
.mode.active{border-color: rgba(99,102,241,.7); box-shadow: 0 0 0 4px rgba(99,102,241,.14); background: rgba(99,102,241,.08);}

input{
  width:100%; border-radius: 14px; border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  color:var(--text); padding: 11px 12px; outline:none; font-weight: 900;
}
input:focus{border-color: rgba(99,102,241,.85); box-shadow: 0 0 0 4px var(--focus);}
.hint{margin-top:6px; color: var(--muted); font-size: 12px; font-weight: 900;}
.two{display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}
@media(max-width:500px){.two{grid-template-columns:1fr}}

.badges{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
.badge{
  padding: 7px 10px; border-radius: 999px;
  border:1px solid var(--line); background: rgba(255,255,255,.03);
  font-size: 12px; font-weight: 900;
}
.badge b{color: var(--c2);}
.box{
  margin-top:10px; border:1px solid var(--line);
  background: rgba(2,6,23,.88);
  border-radius: 14px; padding: 10px;
  max-height: 220px; overflow:auto;
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size: 12px; white-space: pre;
}
.status{
  margin-top:10px;
  border-radius: 14px;
  border:1px dashed rgba(148,163,184,.25);
  padding: 10px 12px;
  font-weight: 900;
  font-size: 13px;
  color: var(--muted);
}

.tableWrap{
  margin-top:12px; border:1px solid var(--line);
  border-radius: var(--r); overflow:auto; background: rgba(2,6,23,.82);
  max-height: 520px;
}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead{
  position:sticky; top:0; z-index:2;
  background: rgba(15,26,46,.95);
  backdrop-filter: blur(8px);
}
th,td{
  padding: 12px 12px;
  border-bottom: 1px solid rgba(148,163,184,.14);
  white-space:nowrap;
}
tbody tr:hover{background: rgba(99,102,241,.08)}
.empty{text-align:center; color:var(--muted); padding: 26px; font-weight: 900;}

.smallNote{color:var(--muted); font-size:12px; font-weight:900;}
.hidden{display:none !important;}
.rightTopRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}

.keywordChips{
  display:flex; flex-wrap:wrap; gap:8px;
  border:1px solid var(--line); background: rgba(255,255,255,.02);
  border-radius: 14px; padding: 10px; max-height: 120px; overflow:auto;
}
.chip{
  display:inline-flex; gap:8px; align-items:center;
  padding: 6px 10px; border-radius: 999px;
  border:1px solid rgba(148,163,184,.20);
  background: rgba(255,255,255,.03);
  font-size:12px; font-weight:900;
}
.chip button{
  background: transparent; border: none; color: #fca5a5;
  cursor:pointer; font-weight:900;
}
.filterIcon{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius: 10px;
  border:1px solid var(--line); background: rgba(255,255,255,.03);
  cursor:pointer;
}
.filterMenu{
  position:absolute; right:10px; top:44px;
  border:1px solid var(--line);
  background: rgba(2,6,23,.96);
  border-radius: 14px;
  box-shadow: var(--shadow2);
  min-width: 180px;
  overflow:hidden;
  z-index: 10;
}
.filterMenu button{
  width:100%;
  text-align:left;
  padding: 10px 12px;
  border:none;
  background: transparent;
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
}
.filterMenu button:hover{ background: rgba(99,102,241,.12); }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>CSV Analyzer</h1>
        <p>Analyzer (old logic) + Keyword Checker (same GAS logic) + Maintenance (Telegram)</p>
      </div>
    </div>

    <div class="badgeRow">
      <button class="pill" id="btnTestTelegram" title="Send a test message to Telegram">
        <span class="dot warn"></span> Test Telegram
      </button>
      <button class="pill" id="btnMaintenance" title="Send maintenance report + screenshot to admin">
        <span class="dot ok"></span> üõ† Maintenance
      </button>
      <div class="pill" id="pill">
        <span class="dot" id="pillDot"></span>
        <span id="pillText">Ready</span>
      </div>
    </div>
  </div>

  <div class="shell">
    <div class="tabs">
      <button class="tabBtn active" id="tabAnalyzer">Analyzer</button>
      <button class="tabBtn" id="tabKeyword">Keyword Checker</button>
    </div>

    <!-- ===================== ANALYZER VIEW ===================== -->
    <div id="viewAnalyzer">
      <div class="grid">
        <div class="panel">
          <div class="panelTitle">
            <b>Input</b>
            <span>Paste CSV / logs here</span>
          </div>
          <textarea id="a_csvInput" placeholder='Examples:
"4338,Translate succes,1/20/2026, 12:51:15 AM,AI art,#EANF#,Romanian"
2504;search completed;2026-01-16
1961,Error: Email/Subject/Message not written,18-12-2024 9-39
'></textarea>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <b>Controls</b>
            <span>Classic output</span>
          </div>

          <div class="kpis">
            <div class="kpi"><span>Total rows</span><b id="a_total">‚Äî</b></div>
            <div class="kpi"><span>Visible rows</span><b id="a_count">‚Äî</b></div>
            <div class="kpi"><span>Not processed</span><b id="a_missingCountKpi">‚Äî</b></div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="a_btnProcess">‚ö° Process</button>
            <button class="btn secondary" id="a_btnCopy">üìã Copy IDs</button>
            <button class="btn export" id="a_btnExport">‚¨á Export CSV</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Date filter</b>
            <small id="a_dateModeLabel">Single day</small>
          </div>

          <div class="modeRow">
            <label class="mode active" id="a_modeSingle">
              <input type="radio" name="a_dateMode" value="single" checked>
              Single day
            </label>
            <label class="mode" id="a_modeRange">
              <input type="radio" name="a_dateMode" value="range">
              Date range
            </label>
          </div>

          <div id="a_singleWrap" style="margin-top:10px">
            <input id="a_singleDate" placeholder="Day (YYYY-MM-DD or DD-MM-YYYY or M/D/YYYY)">
            <div class="hint">Examples: 2026-01-20 | 20-01-2026 | 1/20/2026</div>
          </div>

          <div id="a_rangeWrap" style="margin-top:10px;display:none">
            <div class="two">
              <input id="a_dateFrom" placeholder="From day">
              <input id="a_dateTo" placeholder="To day">
            </div>
            <div class="hint">Tip: if From > To we auto-swap</div>
          </div>

          <div class="controls" style="margin-top:10px;grid-template-columns:1fr 1fr">
            <button class="btn primary" id="a_btnApplyDate">‚úÖ Apply date</button>
            <button class="btn neutral" id="a_btnClearDate">‚Ü© Clear</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>ID range check</b>
            <small class="smallNote">Type: <span style="color:var(--c2)">3376 - 4375</span></small>
          </div>

          <input id="a_rangeInput" placeholder="1961 - 2240">

          <div class="controls" style="margin-top:10px">
            <button class="btn primary" id="a_btnRange">üîé Check</button>
            <button class="btn secondary" id="a_btnCopyMissing">üìã Copy NOT</button>
            <button class="btn export" id="a_btnExportMissing">‚¨á Export NOT</button>
          </div>

          <div class="badges">
            <div class="badge">Processed unique: <b id="a_procInRange">0</b></div>
            <div class="badge">Not processed: <b id="a_missingCount">0</b></div>
            <div class="badge">Duplicates: <b id="a_dupCount">0</b></div>
          </div>

          <div class="box" id="a_missingBox">Run ‚ÄúCheck‚Äù‚Ä¶</div>
          <div class="status" id="a_statusText">Waiting‚Ä¶</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>STATUS</th>
              <th>DATETIME</th>
              <th>DAY</th>
            </tr>
          </thead>
          <tbody id="a_outputBody">
            <tr><td colspan="4" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===================== KEYWORD CHECKER VIEW ===================== -->
    <div id="viewKeyword" class="hidden">
      <div class="grid">
        <div class="panel">
          <div class="panelTitle">
            <b>Input</b>
            <span>Paste table text / CSV (must include headers)</span>
          </div>
          <textarea id="k_input" placeholder='Example (TAB from Google Sheets):
profile_Name	tag	status_name	log	cnx_problems	details
1	[07AD4446...]	Completed	[ Status => connected Updated!]		[LastConnectedDate Updated!]
'></textarea>
          <div class="smallNote" style="margin-top:10px">
            Must include header columns: <b>profile_Name</b> + (log / details / cnx_problems).  
            Matching = case-insensitive, same as GAS.
          </div>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <b>Keyword Checker</b>
            <span>Same logic as GAS: keyword in (log/details/cnx_problems) => PROCESSED</span>
          </div>

          <div class="kpis">
            <div class="kpi"><span>Total rows</span><b id="k_total">‚Äî</b></div>
            <div class="kpi"><span>Processed</span><b id="k_processed">‚Äî</b></div>
            <div class="kpi"><span>Not processed</span><b id="k_notProcessed">‚Äî</b></div>
          </div>

          <hr class="sep">

          <div class="controls">
            <button class="btn primary" id="k_btnCheck">‚úÖ Check keywords</button>
            <button class="btn secondary" id="k_btnCopyNot">üìã Copy NOT (profile_Name)</button>
            <button class="btn export" id="k_btnExportNot">‚¨á Export NOT</button>
          </div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Keywords</b>
            <small class="smallNote">stored in browser (localStorage)</small>
          </div>

          <div class="two">
            <input id="k_kwInput" placeholder="Add keyword (ex: done, already, success...)">
            <button class="btn primary" id="k_btnAdd">Ôºã Add</button>
          </div>

          <div class="controls" style="margin-top:10px">
            <button class="btn neutral" id="k_btnDefault">‚Ü∫ Default list</button>
            <button class="btn neutral" id="k_btnNormalize">‚ú® Normalize</button>
            <button class="btn neutral" id="k_btnClearAll">üßπ Clear all</button>
          </div>

          <div class="hint">If no keyword matches ‚Üí row becomes <b>NOT PROCESSED</b>.</div>

          <div class="keywordChips" id="k_chips" style="margin-top:10px"></div>

          <div class="box" id="k_box">Paste your table then click ‚ÄúCheck keywords‚Äù‚Ä¶</div>
          <div class="status" id="k_statusText">Waiting‚Ä¶</div>

          <hr class="sep">

          <div class="sectionTitle">
            <b>Filter by process_status</b>
            <small class="smallNote">affects table + Copy/Export NOT</small>
          </div>
          <div class="two">
            <input id="k_filterLabel" value="All" disabled />
            <button class="btn neutral" id="k_btnClearFilter">Clear filter</button>
          </div>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>profile_Name</th>
              <th>tag</th>
              <th>status_name</th>
              <th style="position:relative">
                process_status
                <span class="filterIcon" id="k_filterIcon" title="Filter">
                  ‚åÑ
                </span>
                <div class="filterMenu hidden" id="k_filterMenu">
                  <button data-v="ALL">All</button>
                  <button data-v="PROCESSED">PROCESSED</button>
                  <button data-v="NOT PROCESSED">NOT PROCESSED</button>
                </div>
              </th>
              <th>log/details (preview)</th>
            </tr>
          </thead>
          <tbody id="k_tableBody">
            <tr><td colspan="6" class="empty">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* =========================================================
   CONFIG (Fill these)
========================================================= */
const TELEGRAM_BOT_TOKEN = "8548469922:AAFRNc6mOUvvpH6Hs9tumIpaHy-VmVuSUmA";
const TELEGRAM_CHAT_ID   = "8469427662";

/* =========================================================
   Shared helpers
========================================================= */
const $ = (id)=>document.getElementById(id);

function setPill(type, text){
  const dot = $("pillDot");
  const pillText = $("pillText");
  dot.className = "dot" + (type ? " " + type : "");
  pillText.textContent = text || "Ready";
}
function colorByType(type){
  return type === "ok" ? "var(--ok)" :
         type === "bad" ? "var(--bad)" :
         type === "warn" ? "var(--warn)" : "var(--muted)";
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeCsv(s){
  s = String(s ?? "");
  if(/[;\n\r"]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function cleanField(v){
  return String(v ?? "")
    .trim()
    .replace(/^"+|"+$/g,"")
    .replace(/^'+|'+$/g,"")
    .trim();
}

/* =========================================================
   Telegram helpers (debug-friendly)
========================================================= */
async function tgSendText(text){
  if(!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.includes("PUT_")){
    console.warn("Telegram token not set.");
    return { ok:false, error:"Token not set" };
  }
  if(!TELEGRAM_CHAT_ID || TELEGRAM_CHAT_ID.includes("PUT_")){
    console.warn("Telegram chat_id not set.");
    return { ok:false, error:"Chat ID not set" };
  }
  try{
    const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
    });
    const json = await res.json().catch(()=>null);
    return { ok: res.ok && json?.ok, status: res.status, json };
  }catch(e){
    return { ok:false, error: e?.message || String(e) };
  }
}

async function tgSendPhoto(blob, caption){
  if(!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.includes("PUT_")) return { ok:false, error:"Token not set" };
  if(!TELEGRAM_CHAT_ID || TELEGRAM_CHAT_ID.includes("PUT_")) return { ok:false, error:"Chat ID not set" };

  try{
    const fd = new FormData();
    fd.append("chat_id", TELEGRAM_CHAT_ID);
    if(caption) fd.append("caption", caption.slice(0, 900));
    fd.append("photo", blob, "screenshot.png");

    const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
      method:"POST",
      body: fd
    });
    const json = await res.json().catch(()=>null);
    return { ok: res.ok && json?.ok, status: res.status, json };
  }catch(e){
    return { ok:false, error: e?.message || String(e) };
  }
}

/* =========================================================
   Screenshot capture (reliable) ‚Äî getDisplayMedia
   NOTE: Needs secure context (https / localhost).
========================================================= */
async function captureScreenshotBlob() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
    throw new Error("getDisplayMedia not supported in this browser/context.");
  }

  const stream = await navigator.mediaDevices.getDisplayMedia({
    video: {
      displaySurface: "browser",
      logicalSurface: true,
      cursor: "never",
      width: { ideal: 1920 },
      height: { ideal: 1080 },
      frameRate: { ideal: 5, max: 10 }
    },
    audio: false
  });

  try {
    const track = stream.getVideoTracks()[0];
    const video = document.createElement("video");
    video.srcObject = stream;
    video.muted = true;
    video.playsInline = true;

    await new Promise((resolve) => {
      video.onloadedmetadata = () => resolve();
    });

    await video.play();
    await new Promise((r) => setTimeout(r, 150));

    const w = video.videoWidth || window.innerWidth;
    const h = video.videoHeight || window.innerHeight;

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    track.stop();
    stream.getTracks().forEach(t => t.stop());
    video.pause();
    video.srcObject = null;

    return await new Promise((resolve) => canvas.toBlob(resolve, "image/png", 0.92));
  } finally {
    stream.getTracks().forEach(t => { try { t.stop(); } catch(e){} });
  }
}

async function runMaintenance(){
  try{
    setPill("warn","Maintenance: sending‚Ä¶");

    const mode = $("viewKeyword").classList.contains("hidden") ? "Analyzer" : "Keyword Checker";
    const statusText = mode === "Analyzer" ? $("a_statusText").textContent : $("k_statusText").textContent;

    const info =
`üõ† Maintenance report
Mode: ${mode}
Time: ${new Date().toISOString()}
URL: ${location.href}
UA: ${navigator.userAgent}
Status: ${statusText}`.slice(0, 900);

    const t1 = await tgSendText(info);
    if(!t1.ok){
      setPill("bad", "Telegram text failed");
      console.error("Telegram sendMessage failed:", t1);
      alert("Telegram message failed. Check token/chat_id. See console.");
      return;
    }

    let blob;
    try{
      blob = await captureScreenshotBlob();
    }catch(e){
      console.error("Screenshot capture failed:", e);
      setPill("bad", "Screenshot blocked");
      await tgSendText("‚ùå Screenshot failed: " + (e?.message || e));
      alert("Screenshot blocked. IMPORTANT: open via http://localhost (not file://).");
      return;
    }

    if(!blob){
      setPill("bad","Screenshot empty");
      await tgSendText("‚ùå Screenshot failed: empty blob");
      return;
    }

    const t2 = await tgSendPhoto(blob, `Screenshot (${mode})`);
    if(!t2.ok){
      setPill("bad","Photo send failed");
      console.error("Telegram sendPhoto failed:", t2);
      alert("sendPhoto failed. See console (possible file size / permissions).");
      return;
    }

    setPill("ok","Sent to admin ‚úÖ");
  }catch(err){
    console.error(err);
    setPill("bad","Maintenance error");
    alert("Maintenance failed. Check console.");
  }
}

async function testTelegram(){
  setPill("warn","Testing Telegram‚Ä¶");
  const t = await tgSendText("‚úÖ Test from CSV Analyzer at " + new Date().toISOString());
  if(t.ok) setPill("ok","Telegram OK ‚úÖ");
  else{
    setPill("bad","Telegram FAILED ‚ùå");
    console.error("Telegram test failed:", t);
    alert("Telegram failed. Check token/chat_id and bot permissions. See console.");
  }
}

/* =========================================================
   TAB SWITCH
========================================================= */
function showTab(which){
  const isAnalyzer = which === "analyzer";
  $("tabAnalyzer").classList.toggle("active", isAnalyzer);
  $("tabKeyword").classList.toggle("active", !isAnalyzer);
  $("viewAnalyzer").classList.toggle("hidden", !isAnalyzer);
  $("viewKeyword").classList.toggle("hidden", isAnalyzer);
  setPill("", "Ready");
}
$("tabAnalyzer").addEventListener("click", ()=>showTab("analyzer"));
$("tabKeyword").addEventListener("click", ()=>showTab("keyword"));

$("btnMaintenance").addEventListener("click", runMaintenance);
$("btnTestTelegram").addEventListener("click", testTelegram);

/* =========================================================
   ANALYZER (old logic)
========================================================= */
function a_setStatus(msg, type="muted"){
  $("a_statusText").textContent = msg;
  $("a_statusText").style.color = colorByType(type);
  setPill(type==="ok"?"ok":type==="bad"?"bad":type==="warn"?"warn":"", msg);
}

function isTimeField(v){
  v = String(v||"").trim();
  return /^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/i.test(v);
}
function parseDateOnlyFlexible(v){
  v = String(v||"").trim();
  if(!v) return null;

  if(v.includes("_")) v = v.split("_")[0].trim();
  if(/\s/.test(v)) v = v.split(/\s+/)[0].trim();

  v = v.replace(/,/g,"").trim();
  const s = v.replace(/\./g,"/").replace(/-/g,"/");

  const m = s.match(/^(\d{1,4})\/(\d{1,2})\/(\d{1,4})$/);
  if(!m) return null;

  let a = Number(m[1]), b = Number(m[2]), c = Number(m[3]);
  if([a,b,c].some(n=>Number.isNaN(n))) return null;

  let yyyy, mm, dd;

  if(m[1].length === 4){
    yyyy = a; mm = b; dd = c;          // YYYY/MM/DD
  } else if(m[3].length === 4){
    yyyy = c;
    if(a > 12){ dd = a; mm = b; }      // DD/MM/YYYY
    else if(b > 12){ mm = a; dd = b; } // MM/DD/YYYY (rare)
    else { mm = a; dd = b; }           // default MM/DD/YYYY
  } else return null;

  if(yyyy < 1900 || yyyy > 2100) return null;
  if(mm < 1 || mm > 12) return null;
  if(dd < 1 || dd > 31) return null;

  return {yyyy, mm, dd};
}
function dayKeyFrom(yyyy,mm,dd){
  const pad = n => String(n).padStart(2,"0");
  return `${yyyy}-${pad(mm)}-${pad(dd)}`;
}
function toUTCDate(dayKey){
  const [y,m,d] = dayKey.split("-").map(Number);
  return new Date(Date.UTC(y, m-1, d));
}
function parseWholeQuotedCommaLine(line){
  let s = line.trim();
  if(!(s.startsWith('"') && s.endsWith('"'))) return null;
  s = s.slice(1,-1);

  const commas = [];
  for(let i=0;i<s.length;i++) if(s[i] === ",") commas.push(i);
  if(commas.length < 3) return null;

  const c1 = commas[0], c2 = commas[1], c3 = commas[2];
  const c4 = commas[3] ?? -1;

  const idStr = s.slice(0,c1).trim();
  const id = parseInt(idStr,10);
  if(!Number.isFinite(id)) return null;

  const status = s.slice(c1+1, c2).trim();
  const dateStr = s.slice(c2+1, c3).trim();
  const timeStr = c4 !== -1 ? s.slice(c3+1, c4).trim() : "";

  const d = parseDateOnlyFlexible(dateStr);
  if(!d) return null;

  const day = dayKeyFrom(d.yyyy, d.mm, d.dd);
  const dt = (dateStr + (timeStr && isTimeField(timeStr) ? " " + timeStr : "")).trim();

  return { id, idText:String(id), status: status || "(no status)", datetime: dt, day };
}
function detectDelimiter(lines){
  let semi=0, comma=0;
  for(const ln of lines.slice(0,30)){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
  }
  return comma >= semi ? "," : ";";
}
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out;
}
function parseTextAnalyzer(text){
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return [];

  const delim = detectDelimiter(lines);
  const rows = [];

  for(const line0 of lines){
    const q = parseWholeQuotedCommaLine(line0);
    if(q){ rows.push(q); continue; }

    const parts = splitCSVLine(line0, delim).map(cleanField).filter(x => x !== "");
    if(parts.length < 2) continue;

    const id = parseInt(parts[0],10);
    if(!Number.isFinite(id)) continue;

    let dateIdx = -1, d = null;
    for(let i=1;i<parts.length;i++){
      const maybe = parseDateOnlyFlexible(parts[i]);
      if(maybe){ dateIdx = i; d = maybe; break; }
    }
    if(dateIdx === -1) continue;

    let timeStr = "";
    if(dateIdx + 1 < parts.length && isTimeField(parts[dateIdx + 1])) timeStr = parts[dateIdx + 1];

    const day = dayKeyFrom(d.yyyy, d.mm, d.dd);
    const dt = (parts[dateIdx] + (timeStr ? " " + timeStr : "")).trim();
    const status = parts.slice(1, dateIdx).join(" ").trim() || "(no status)";

    rows.push({ id, idText:String(id), status, datetime: dt, day });
  }
  return rows;
}

let a_allRows = [];
let a_visibleRows = [];
let a_missingIDs = [];

function a_renderTable(){
  const body = $("a_outputBody");
  body.innerHTML = "";

  if(!a_visibleRows.length){
    body.innerHTML = `<tr><td colspan="4" class="empty">No rows</td></tr>`;
    $("a_count").textContent = "0";
    return;
  }

  for(const r of a_visibleRows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.idText)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.datetime)}</td>
      <td>${escapeHtml(r.day)}</td>
    `;
    body.appendChild(tr);
  }
  $("a_count").textContent = String(a_visibleRows.length);
}

function a_resetRangeBox(){
  $("a_procInRange").textContent = "0";
  $("a_missingCount").textContent = "0";
  $("a_dupCount").textContent = "0";
  $("a_missingCountKpi").textContent = "0";
  $("a_missingBox").textContent = 'Run ‚ÄúCheck‚Äù‚Ä¶';
  a_missingIDs = [];
}

function a_dateMode(){
  const r = document.querySelector('input[name="a_dateMode"]:checked');
  return r ? r.value : "single";
}
function normalizeDateInput(v){
  const d = parseDateOnlyFlexible(v);
  if(!d) return null;
  return dayKeyFrom(d.yyyy, d.mm, d.dd);
}

function a_applyDateFilter(){
  if(!a_allRows.length){ a_setStatus("Process first", "bad"); return; }

  const mode = a_dateMode();
  if(mode === "single"){
    const day = normalizeDateInput($("a_singleDate").value);
    if(!day){ a_setStatus("Invalid day", "bad"); return; }
    a_visibleRows = a_allRows.filter(r => r.day === day);
    a_renderTable(); a_resetRangeBox();
    a_setStatus(`Filtered by day: ${day}`, "ok");
  } else {
    const from = normalizeDateInput($("a_dateFrom").value);
    const to = normalizeDateInput($("a_dateTo").value);
    if(!from || !to){ a_setStatus("Invalid date range", "bad"); return; }
    const a = toUTCDate(from).getTime();
    const b = toUTCDate(to).getTime();
    const lo = Math.min(a,b), hi = Math.max(a,b);

    a_visibleRows = a_allRows.filter(r=>{
      const t = toUTCDate(r.day).getTime();
      return t >= lo && t <= hi;
    });
    a_renderTable(); a_resetRangeBox();
    a_setStatus(`Filtered range: ${from} ‚Üí ${to}`, "ok");
  }
}

function a_clearDateFilter(){
  a_visibleRows = [...a_allRows];
  $("a_singleDate").value = "";
  $("a_dateFrom").value = "";
  $("a_dateTo").value = "";
  a_renderTable(); a_resetRangeBox();
  a_setStatus("Date filter cleared (showing all rows)", "ok");
}

function parseRangeInput(str){
  str = String(str||"").trim();
  if(!str) return null;
  // allow: "3376 - 4375", "3376-4375", "3376 , 4375"
  const m = str.match(/^\s*(\d+)\s*[-,]\s*(\d+)\s*$/);
  if(!m) return null;
  let from = Number(m[1]), to = Number(m[2]);
  if(Number.isNaN(from) || Number.isNaN(to)) return null;
  if(from > to){ const t = from; from = to; to = t; }
  return {from,to};
}

function a_checkRange(){
  if(!a_visibleRows.length){ a_setStatus("No visible rows (apply date first)", "bad"); return; }
  const rr = parseRangeInput($("a_rangeInput").value);
  if(!rr){ a_setStatus("Invalid range. Example: 3376 - 4375", "bad"); return; }
  const {from,to} = rr;

  const counts = new Map();
  for(const r of a_visibleRows) counts.set(r.id, (counts.get(r.id)||0)+1);

  let dupN = 0;
  for(const [,c] of counts) if(c>1) dupN++;
  $("a_dupCount").textContent = String(dupN);

  let processedUniqueInRange = 0;
  for(const [id] of counts) if(id>=from && id<=to) processedUniqueInRange++;
  $("a_procInRange").textContent = String(processedUniqueInRange);

  a_missingIDs = [];
  for(let i=from;i<=to;i++) if(!counts.has(i)) a_missingIDs.push(i);

  $("a_missingCount").textContent = String(a_missingIDs.length);
  $("a_missingCountKpi").textContent = String(a_missingIDs.length);

  $("a_missingBox").textContent =
`Scope = visible rows (your date filter)
ID Range: ${from} ‚Üí ${to}

NOT processed (${a_missingIDs.length}):
${a_missingIDs.slice(0, 400).join("\n") || "‚Äî"}

(Preview first 400)`;

  a_setStatus("Range computed ‚úÖ", "ok");
}

function a_copyIDs(){
  if(!a_visibleRows.length){ a_setStatus("No visible rows to copy", "warn"); return; }
  navigator.clipboard.writeText(a_visibleRows.map(r=>r.idText).join("\n"))
    .then(()=>a_setStatus(`Copied ${a_visibleRows.length} IDs`, "ok"))
    .catch(()=>a_setStatus("Clipboard blocked by browser", "bad"));
}

function a_exportVisibleCSV(){
  if(!a_visibleRows.length){ a_setStatus("No visible rows to export", "warn"); return; }
  let csv = "ID;STATUS;DATETIME;DAY\n";
  for(const r of a_visibleRows){
    csv += `${safeCsv(r.idText)};${safeCsv(r.status)};${safeCsv(r.datetime)};${safeCsv(r.day)}\n`;
  }
  downloadBlob(csv, "visible.csv", "text/csv;charset=utf-8;");
  a_setStatus(`Exported visible.csv (${a_visibleRows.length})`, "ok");
}

function a_copyMissing(){
  if(!a_missingIDs.length){ a_setStatus("No not-processed IDs", "warn"); return; }
  navigator.clipboard.writeText(a_missingIDs.join("\n"))
    .then(()=>a_setStatus(`Copied ${a_missingIDs.length} NOT IDs`, "ok"))
    .catch(()=>a_setStatus("Clipboard blocked by browser", "bad"));
}
function a_exportMissing(){
  if(!a_missingIDs.length){ a_setStatus("No not-processed IDs", "warn"); return; }
  const rr = parseRangeInput($("a_rangeInput").value);
  const name = rr ? `not_processed_${rr.from}-${rr.to}.csv` : "not_processed.csv";
  downloadBlob("ID\n" + a_missingIDs.join("\n"), name, "text/csv;charset=utf-8;");
  a_setStatus(`Exported ${name}`, "ok");
}

function a_refreshModeUI(){
  const m = a_dateMode();
  $("a_dateModeLabel").textContent = m === "single" ? "Single day" : "Date range";
  $("a_singleWrap").style.display = m === "single" ? "block" : "none";
  $("a_rangeWrap").style.display = m === "range" ? "block" : "none";
  $("a_modeSingle").classList.toggle("active", m === "single");
  $("a_modeRange").classList.toggle("active", m === "range");
  a_resetRangeBox();
  a_setStatus(`Date mode: ${m}`, "ok");
}

function a_processCSV(){
  const text = $("a_csvInput").value.trim();
  if(!text){ a_setStatus("Input empty", "bad"); return; }

  a_allRows = parseTextAnalyzer(text);
  $("a_total").textContent = String(a_allRows.length);

  a_visibleRows = [...a_allRows];
  a_renderTable();
  a_resetRangeBox();

  if(!a_allRows.length){
    a_setStatus("No valid rows parsed (check format)", "bad");
    return;
  }

  // auto-fill latest day
  const days = [...new Set(a_allRows.map(r=>r.day))].sort((a,b)=>b.localeCompare(a));
  $("a_singleDate").value = days[0] || "";
  a_setStatus("Parsed ‚úÖ Now Apply date, then Check.", "ok");
}

$("a_btnProcess").addEventListener("click", a_processCSV);
$("a_btnCopy").addEventListener("click", a_copyIDs);
$("a_btnExport").addEventListener("click", a_exportVisibleCSV);
$("a_btnApplyDate").addEventListener("click", a_applyDateFilter);
$("a_btnClearDate").addEventListener("click", a_clearDateFilter);
$("a_btnRange").addEventListener("click", a_checkRange);
$("a_btnCopyMissing").addEventListener("click", a_copyMissing);
$("a_btnExportMissing").addEventListener("click", a_exportMissing);

document.querySelectorAll('input[name="a_dateMode"]').forEach(r=>{
  r.addEventListener("change", a_refreshModeUI);
});
a_refreshModeUI();

/* =========================================================
   KEYWORD CHECKER (GAS logic)
========================================================= */
const KW_STORAGE_KEY = "csv_analyzer_keywords_v1";

const DEFAULT_KEYWORDS = [
  "done","already","reply","forward","search completed for","markunread",
  "sendmessage","successfully","birthdaychanged","click","gender updated",
  "theme already changed","gmail template updated","languagevalue updated",
  "english has been added"
];

function normalizeForSearch(v){
  if (v === null || v === undefined) return "";
  let s = String(v);
  if (s === "#ERROR!") return "";
  s = s.replace(/^[=;]+>?/g, "");
  return s.toLowerCase();
}

function k_setStatus(msg, type="muted"){
  $("k_statusText").textContent = msg;
  $("k_statusText").style.color = colorByType(type);
  setPill(type==="ok"?"ok":type==="bad"?"bad":type==="warn"?"warn":"", msg);
}

function loadKeywords(){
  try{
    const raw = localStorage.getItem(KW_STORAGE_KEY);
    if(!raw) return [...DEFAULT_KEYWORDS];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || !arr.length) return [...DEFAULT_KEYWORDS];
    return arr.map(x=>String(x).trim()).filter(Boolean);
  }catch(e){
    return [...DEFAULT_KEYWORDS];
  }
}
function saveKeywords(list){
  localStorage.setItem(KW_STORAGE_KEY, JSON.stringify(list));
}
function normalizeKeywords(list){
  const seen = new Set();
  const out = [];
  for(const k of list){
    const s = String(k||"").trim().toLowerCase();
    if(!s) continue;
    if(seen.has(s)) continue;
    seen.add(s);
    out.push(s);
  }
  return out;
}

let k_keywords = normalizeKeywords(loadKeywords());
function renderKeywordChips(){
  const wrap = $("k_chips");
  wrap.innerHTML = "";
  if(!k_keywords.length){
    wrap.innerHTML = `<div class="smallNote">No keywords (add some).</div>`;
    return;
  }
  for(const kw of k_keywords){
    const div = document.createElement("div");
    div.className = "chip";
    div.innerHTML = `<span>${escapeHtml(kw)}</span><button title="remove">√ó</button>`;
    div.querySelector("button").addEventListener("click", ()=>{
      k_keywords = k_keywords.filter(x=>x !== kw);
      saveKeywords(k_keywords);
      renderKeywordChips();
    });
    wrap.appendChild(div);
  }
}

function detectDelimTable(text){
  // prefer TAB if present
  if(text.includes("\t")) return "\t";
  // else guess between ; and ,
  const lines = text.replace(/\r/g,"").split("\n").filter(Boolean).slice(0,20);
  let semi=0, comma=0;
  for(const ln of lines){
    semi += (ln.match(/;/g)||[]).length;
    comma += (ln.match(/,/g)||[]).length;
  }
  return comma >= semi ? "," : ";";
}
function splitLine(line, delim){
  // simple CSV splitter with quotes support for , ; (TAB usually no quotes)
  if(delim === "\t"){
    return line.split("\t").map(cleanField);
  }
  const out = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === delim){
      out.push(cur); cur=""; continue;
    }
    cur += ch;
  }
  out.push(cur);
  return out.map(cleanField);
}

let k_rows = [];
let k_filter = "ALL"; // ALL | PROCESSED | NOT PROCESSED

function k_parseTable(){
  const text = $("k_input").value.trim();
  if(!text) return { rows:[], delim:"" };

  const delim = detectDelimTable(text);
  const lines = text.replace(/\r/g,"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(lines.length < 2) return { rows:[], delim };

  const header = splitLine(lines[0], delim).map(x=>String(x||"").trim().toLowerCase());
  const idx = (name)=>header.indexOf(name);

  // accept profile_name or profile name
  let iProfile = idx("profile_name");
  if(iProfile === -1) iProfile = idx("profile name");
  if(iProfile === -1) iProfile = idx("profile");

  const iTag = idx("tag");
  const iStatusName = idx("status_name");
  const iLog = idx("log");
  const iDetails = idx("details");
  const iCnx = idx("cnx_problems");

  if(iProfile === -1){
    return { rows:[], delim, error:"Missing header: profile_Name" };
  }

  const rows = [];
  for(let i=1;i<lines.length;i++){
    const parts = splitLine(lines[i], delim);
    if(parts.every(x=>!String(x||"").trim())) continue;

    const profile = parts[iProfile] ?? "";
    const tag = iTag !== -1 ? (parts[iTag] ?? "") : "";
    const statusName = iStatusName !== -1 ? (parts[iStatusName] ?? "") : "";
    const log = iLog !== -1 ? (parts[iLog] ?? "") : "";
    const details = iDetails !== -1 ? (parts[iDetails] ?? "") : "";
    const cnx = iCnx !== -1 ? (parts[iCnx] ?? "") : "";

    rows.push({
      idx: i,
      profile_Name: String(profile).trim(),
      tag: String(tag).trim(),
      status_name: String(statusName).trim(),
      log: String(log),
      details: String(details),
      cnx_problems: String(cnx),
      process_status: "" // to set
    });
  }
  return { rows, delim };
}

function k_checkKeywords(){
  const parsed = k_parseTable();
  if(parsed.error){
    k_rows = [];
    k_renderTable();
    $("k_total").textContent = "0";
    $("k_processed").textContent = "0";
    $("k_notProcessed").textContent = "0";
    $("k_box").textContent = "‚ùå " + parsed.error + "\n\nTip: Paste from Google Sheets includes TAB delimiter.";
    k_setStatus("Missing header", "bad");
    return;
  }

  k_rows = parsed.rows;

  if(!k_rows.length){
    $("k_total").textContent = "0";
    $("k_processed").textContent = "0";
    $("k_notProcessed").textContent = "0";
    $("k_box").textContent = "No rows parsed. Make sure you pasted header + rows.";
    k_setStatus("No rows parsed", "bad");
    return;
  }

  // keywords normalized
  const keywords = normalizeKeywords(k_keywords);
  if(!keywords.length){
    k_setStatus("No keywords list. Add keywords first.", "warn");
  }

  let processedCount = 0;
  let notCount = 0;

  for(const r of k_rows){
    const logText = normalizeForSearch(r.log);
    const detailsText = normalizeForSearch(r.details);
    const cnxText = normalizeForSearch(r.cnx_problems);

    let processed = false;
    if(logText || detailsText || cnxText){
      for(const kw of keywords){
        if(!kw) continue;
        if(logText.includes(kw) || detailsText.includes(kw) || cnxText.includes(kw)){
          processed = true;
          break;
        }
      }
    }

    r.process_status = processed ? "PROCESSED" : "NOT PROCESSED";
    if(processed) processedCount++;
    else notCount++;
  }

  $("k_total").textContent = String(k_rows.length);
  $("k_processed").textContent = String(processedCount);
  $("k_notProcessed").textContent = String(notCount);

  // box: show only NOT list preview (no "Keywords used" line)
  const notProfiles = [...new Set(k_rows.filter(r=>r.process_status==="NOT PROCESSED").map(r=>r.profile_Name).filter(Boolean))];
  $("k_box").textContent =
`Parsed rows: ${k_rows.length} (delim: ${parsed.delim === "\t" ? "TAB" : parsed.delim})
NOT PROCESSED unique profile_Name (first 200):
${notProfiles.slice(0,200).join("\n") || "‚Äî"}`;

  k_setStatus("Keyword check done ‚úÖ", "ok");
  k_renderTable();
}

function k_getFilteredRows(){
  if(k_filter === "PROCESSED") return k_rows.filter(r=>r.process_status==="PROCESSED");
  if(k_filter === "NOT PROCESSED") return k_rows.filter(r=>r.process_status==="NOT PROCESSED");
  return k_rows;
}

function k_renderTable(){
  const body = $("k_tableBody");
  body.innerHTML = "";
  if(!k_rows.length){
    body.innerHTML = `<tr><td colspan="6" class="empty">No data yet</td></tr>`;
    return;
  }

  const rows = k_getFilteredRows();
  if(!rows.length){
    body.innerHTML = `<tr><td colspan="6" class="empty">No rows for this filter</td></tr>`;
    return;
  }

  let n = 0;
  for(const r of rows){
    n++;
    const preview = (String(r.log||"") + " " + String(r.details||"") + " " + String(r.cnx_problems||"")).trim();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${n}</td>
      <td>${escapeHtml(r.profile_Name)}</td>
      <td>${escapeHtml(r.tag)}</td>
      <td>${escapeHtml(r.status_name)}</td>
      <td style="font-weight:900;color:${r.process_status==="PROCESSED"?"var(--ok)":"var(--bad)"}">${escapeHtml(r.process_status)}</td>
      <td title="${escapeHtml(preview)}">${escapeHtml(preview.slice(0,140))}${preview.length>140?"‚Ä¶":""}</td>
    `;
    body.appendChild(tr);
  }
}

function k_copyNot(){
  if(!k_rows.length){ k_setStatus("No rows", "warn"); return; }

  // If filter set to NOT PROCESSED -> copy visible not processed
  const rows = (k_filter === "NOT PROCESSED") ? k_getFilteredRows() : k_rows.filter(r=>r.process_status==="NOT PROCESSED");

  const list = [...new Set(rows.map(r=>r.profile_Name).filter(Boolean))];
  if(!list.length){ k_setStatus("No NOT PROCESSED to copy", "warn"); return; }

  navigator.clipboard.writeText(list.join("\n"))
    .then(()=>k_setStatus(`Copied ${list.length} profile_Name`, "ok"))
    .catch(()=>k_setStatus("Clipboard blocked by browser", "bad"));
}

function k_exportNot(){
  if(!k_rows.length){ k_setStatus("No rows", "warn"); return; }

  const rows = (k_filter === "NOT PROCESSED") ? k_getFilteredRows() : k_rows.filter(r=>r.process_status==="NOT PROCESSED");
  const list = [...new Set(rows.map(r=>r.profile_Name).filter(Boolean))];

  if(!list.length){ k_setStatus("No NOT PROCESSED to export", "warn"); return; }

  const csv = "profile_Name\n" + list.map(x=>safeCsv(x)).join("\n");
  downloadBlob(csv, "not_processed_profile_name.csv", "text/csv;charset=utf-8;");
  k_setStatus(`Exported NOT (${list.length})`, "ok");
}

function k_addKeyword(){
  const v = $("k_kwInput").value.trim();
  if(!v) return;
  const add = normalizeKeywords([v])[0];
  if(!add) return;
  if(!k_keywords.map(x=>x.toLowerCase()).includes(add)){
    k_keywords.push(add);
    k_keywords = normalizeKeywords(k_keywords);
    saveKeywords(k_keywords);
    renderKeywordChips();
  }
  $("k_kwInput").value = "";
  k_setStatus("Keyword added", "ok");
}

function k_defaultKeywords(){
  k_keywords = normalizeKeywords([...DEFAULT_KEYWORDS]);
  saveKeywords(k_keywords);
  renderKeywordChips();
  k_setStatus("Default keywords loaded", "ok");
}

function k_normalizeKeywordsUI(){
  k_keywords = normalizeKeywords(k_keywords);
  saveKeywords(k_keywords);
  renderKeywordChips();
  k_setStatus("Keywords normalized", "ok");
}

function k_clearAllKeywords(){
  k_keywords = [];
  saveKeywords(k_keywords);
  renderKeywordChips();
  k_setStatus("Keywords cleared", "warn");
}

/* Filter menu UI */
function k_setFilter(v){
  k_filter = v;
  const label = v === "ALL" ? "All" : v;
  $("k_filterLabel").value = label;
  k_renderTable();
  k_setStatus("Filter: " + label, "ok");
}
function k_toggleFilterMenu(show){
  $("k_filterMenu").classList.toggle("hidden", !show);
}
$("k_filterIcon").addEventListener("click", (e)=>{
  e.stopPropagation();
  const isHidden = $("k_filterMenu").classList.contains("hidden");
  k_toggleFilterMenu(isHidden);
});
document.addEventListener("click", ()=>{
  k_toggleFilterMenu(false);
});
$("k_filterMenu").addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  const v = btn.getAttribute("data-v");
  if(v === "ALL") k_setFilter("ALL");
  else if(v === "PROCESSED") k_setFilter("PROCESSED");
  else if(v === "NOT PROCESSED") k_setFilter("NOT PROCESSED");
  k_toggleFilterMenu(false);
});

$("k_btnClearFilter").addEventListener("click", ()=>k_setFilter("ALL"));

$("k_btnCheck").addEventListener("click", k_checkKeywords);
$("k_btnCopyNot").addEventListener("click", k_copyNot);
$("k_btnExportNot").addEventListener("click", k_exportNot);

$("k_btnAdd").addEventListener("click", k_addKeyword);
$("k_kwInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") k_addKeyword(); });

$("k_btnDefault").addEventListener("click", k_defaultKeywords);
$("k_btnNormalize").addEventListener("click", k_normalizeKeywordsUI);
$("k_btnClearAll").addEventListener("click", k_clearAllKeywords);

renderKeywordChips();
k_setFilter("ALL");

/* =========================================================
   INIT
========================================================= */
setPill("", "Ready");
</script>
</body>
</html>
